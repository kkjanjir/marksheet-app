<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>SBS Shiksha Niketan â€” Marksheet System</title>
<meta name="theme-color" content="#1a237e"/>
<link rel="manifest" href="manifest.json"/>
<link rel="apple-touch-icon" href="icon-192.png"/>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,700;0,9..40,900;1,9..40,400&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet"/>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>

<!-- React -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<style>
/* â”€â”€ RESET & BASE â”€â”€ */
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:'DM Sans',sans-serif;background:#e8eaf0;-webkit-tap-highlight-color:transparent;}

/* â”€â”€ UTILITIES â”€â”€ */
.card{background:#fff;border-radius:16px;box-shadow:0 2px 20px rgba(0,0,0,0.07);}
.inp{width:100%;padding:9px 13px;border:1.5px solid #e0e0e0;border-radius:9px;font-size:13px;
  font-family:'DM Sans',sans-serif;outline:none;background:#fafafa;transition:border-color .2s,background .2s,box-shadow .2s;}
.inp:focus{border-color:#1a237e;background:#fff;box-shadow:0 0 0 3px rgba(26,35,126,0.1);}
.btn{border:none;border-radius:9px;padding:9px 18px;font-weight:700;cursor:pointer;
  font-family:'DM Sans',sans-serif;font-size:13px;transition:opacity .15s,transform .1s;}
.btn:active{opacity:.8;transform:scale(0.97);}
.mi{width:100%;padding:5px 3px;border:1px solid #ddd;border-radius:5px;font-size:11px;
  text-align:center;outline:none;font-family:'DM Sans',sans-serif;}
.mi:focus{border-color:#1a237e;background:#eef3ff;box-shadow:0 0 0 2px rgba(26,35,126,0.1);}

/* â”€â”€ DROPDOWN â”€â”€ */
.sug{position:absolute;left:0;right:0;top:calc(100% + 2px);background:#fff;
  border:1.5px solid #c5cae9;border-radius:0 0 10px 10px;z-index:400;
  box-shadow:0 10px 30px rgba(0,0,0,0.12);max-height:180px;overflow-y:auto;}
.sug-item{padding:10px 13px;cursor:pointer;font-size:13px;border-bottom:1px solid #f0f0f0;color:#333;}
.sug-item:hover,.sug-item:active{background:#e8eaf6;color:#1a237e;}

/* â”€â”€ ANIMATIONS â”€â”€ */
@keyframes fadeUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.35}}
@keyframes spin{to{transform:rotate(360deg)}}
.fi{animation:fadeUp .25s ease both;}
.pulse{animation:pulse 1.1s infinite;}

/* â”€â”€ TOAST â”€â”€ */
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);
  background:#1a1a2e;color:#fff;padding:11px 24px;border-radius:30px;
  font-size:13px;z-index:9999;box-shadow:0 6px 24px rgba(0,0,0,0.3);
  white-space:nowrap;animation:fadeUp .2s ease;}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-thumb{background:#9fa8da;border-radius:6px;}

/* â”€â”€ DESKTOP LAYOUT â”€â”€ */
@media(min-width:900px){
  .shell{display:flex;height:100vh;overflow:hidden;}
  .left-pane{width:470px;flex-shrink:0;overflow-y:auto;height:100vh;
    border-right:2px solid #e0e4f0;background:#eef0f6;}
  .right-pane{flex:1;overflow-y:auto;height:100vh;background:#3a3a3a;
    display:flex;flex-direction:column;align-items:center;padding:24px 16px;}
}
@media(max-width:899px){
  .shell{display:block;}
  .left-pane{width:100%;min-height:100vh;}
  .right-pane{display:none!important;}
}

/* â”€â”€ PRINT â€” A4 exact, zero margin, full bleed â”€â”€ */
@media print{
  *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;}
  html,body{margin:0!important;padding:0!important;width:210mm!important;
    height:297mm!important;background:white!important;overflow:hidden!important;}
  body *{visibility:hidden!important;}
  #MARKSHEET,#MARKSHEET *{visibility:visible!important;}
  #MARKSHEET{position:fixed!important;inset:0!important;width:210mm!important;
    height:297mm!important;margin:0!important;padding:0!important;
    overflow:hidden!important;background:white!important;box-shadow:none!important;}
  @page{size:210mm 297mm;margin:0mm;}
}

/* â”€â”€ SCREEN-ONLY helper â”€â”€ */
@media print{.no-print{display:none!important;}}
</style>
</head>
<body>
<div id="root"></div>

<!-- Firebase init â€” move API key to env variables before going public -->
<script>
try {
  firebase.initializeApp({
    apiKey:"AIzaSyDw6lVRfXgehqpgvTCobqZZyLAy9alzAU8",
    authDomain:"sbs-marksheet.firebaseapp.com",
    projectId:"sbs-marksheet",
    storageBucket:"sbs-marksheet.firebasestorage.app",
    messagingSenderId:"1064566048496",
    appId:"1:1064566048496:web:0b7cf5d4b9fa0bf9dae435"
  });
  const db = firebase.firestore();
  db.settings({cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED});
  db.enablePersistence({synchronizeTabs:true}).catch(err=>{
    if(err.code==='failed-precondition') console.warn('Multi-tab persistence off');
  });
  window._db   = db;
  window._auth = firebase.auth();
} catch(e) {
  console.error('Firebase init failed:', e);
  window._db   = null;
  window._auth = null;
}
</script>

<script type="text/babel" data-presets="react">
const {useState, useEffect, useRef, useCallback, useMemo} = React;

/* â”€â”€â”€ AUTH SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const auth = window._auth;

// âœ… APNI GMAIL IDS YAHAN LIKHO â€” sirf ye log login kar sakenge
const ALLOWED_EMAILS = [
  "aapkigmail@gmail.com",   // â† replace with your Gmail
  // "dusri@gmail.com",     // â† aur staff add karo zaroorat ho to
];

/* â”€â”€â”€ CONSTANTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const SCHOOL = {
  name: "SBS SHIKSHA NIKETAN",
  addr: "Karaspur Prithvipur, Ghazipur, Uttar Pradesh â€“ 233226",
  logo: "logo.png",
};

const DEFAULT_SUBJECTS = [
  "HINDI","ENGLISH","MATHEMATICS","SCIENCE",
  "SOCIAL SCIENCE","ART AND DRAWING","COMPUTER","G.K."
];

const GRADE_TABLE = [
  {min:91,max:100,g:"A1",l:"OUTSTANDING"},
  {min:81,max:90, g:"A2",l:"EXCELLENT"},
  {min:71,max:80, g:"B1",l:"VERY GOOD"},
  {min:61,max:70, g:"B2",l:"GOOD"},
  {min:51,max:60, g:"C1",l:"AVERAGE"},
  {min:41,max:50, g:"C2",l:"SATISFACTORY"},
  {min:33,max:40, g:"D", l:"PASS"},
  {min:0, max:32, g:"E", l:"FAIL"},
];

const grade      = p => { if(p===null||p===undefined) return "â€“"; for(const r of GRADE_TABLE) if(p>=r.min&&p<=r.max) return r.g; return "â€“"; };
const gradeLabel = p => { if(p===null||p===undefined) return "â€“"; for(const r of GRADE_TABLE) if(p>=r.min&&p<=r.max) return r.l; return "â€“"; };

const REMARK_OPTS = [
  "Excellent performance! Keep up the great work.",
  "Good effort shown. Focus more on weaker subjects.",
  "Satisfactory progress. Must work harder next term.",
  "Very good student. Regular attendance is essential.",
  "Outstanding achievement. We are proud of you!",
];

const ADDR_OPTS = [
  "Nasiruddinpur, Prithvipur, Ghazipur, Uttar Pradesh 233226",
  "Prithvipur, Ghazipur, Uttar Pradesh 233226",
  "Karaspur, Prithvipur, Ghazipur, Uttar Pradesh 233226",
];

/* â”€â”€â”€ MATH HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const subObt = s => (parseFloat(s.o1)||0)+(parseFloat(s.o2)||0)+(parseFloat(s.o3)||0);
const subMM  = s => (parseFloat(s.m1)||0)+(parseFloat(s.m2)||0)+(parseFloat(s.m3)||0);
const pct    = (o,m) => m>0 ? parseFloat(((o/m)*100).toFixed(1)) : null;

function grandTotals(subs){
  return subs.reduce((a,s)=>({
    m1:a.m1+(parseFloat(s.m1)||0), o1:a.o1+(parseFloat(s.o1)||0),
    m2:a.m2+(parseFloat(s.m2)||0), o2:a.o2+(parseFloat(s.o2)||0),
    m3:a.m3+(parseFloat(s.m3)||0), o3:a.o3+(parseFloat(s.o3)||0),
    mT:a.mT+subMM(s), oT:a.oT+subObt(s),
  }), {m1:0,o1:0,m2:0,o2:0,m3:0,o3:0,mT:0,oT:0});
}

/* â”€â”€â”€ FIREBASE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
// BUG FIX: Wrap all firebase calls in try/catch with db null check
const db = window._db;

const fbSave = async (st) => {
  if(!db) throw new Error("No DB");
  await db.collection("students").doc(String(st.id)).set(st);
  const bRef = db.collection("backups").doc(String(st.id));
  const snap = await bRef.get();
  let vers = snap.exists ? (snap.data().v||[]) : [];
  vers = [{...st, _at:new Date().toISOString()}, ...vers].slice(0,2);
  await bRef.set({v:vers});
};
const fbAll  = async () => { if(!db) throw new Error("No DB"); return (await db.collection("students").get()).docs.map(d=>d.data()); };
const fbDel  = async id => { if(!db) throw new Error("No DB"); return db.collection("students").doc(String(id)).delete(); };
const fbBaks = async id => {
  if(!db) return [];
  const d = await db.collection("backups").doc(String(id)).get();
  return d.exists ? (d.data().v||[]) : [];
};

/* â”€â”€â”€ LOCAL STORAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const LS_KEY = "sbs_mk_v7";
const lsSave = d => { try{localStorage.setItem(LS_KEY, JSON.stringify(d));}catch(e){console.warn("LS save failed",e);} };
const lsLoad = () => { try{ const r=localStorage.getItem(LS_KEY); return r?JSON.parse(r):[]; }catch{return[];} };

/* â”€â”€â”€ NEW STUDENT FACTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const newStudent = () => ({
  id: `${Date.now()}_${Math.random().toString(36).slice(2,8)}`,
  name:"", father:"", mother:"", addr:"",
  roll:"", admno:"", dob:"", cls:"", sec:"", session:"2025-26",
  photo: null,
  att:{p:"", t:""},
  remark:"", rank:"",
  subs: DEFAULT_SUBJECTS.map(n=>({n, m1:60, o1:"", m2:60, o2:"", m3:60, o3:""})),
  cosco:{sports:"", art:"", music:"", disc:"", clean:""},
  _created: new Date().toISOString(),
  _updated: new Date().toISOString(),
});

/* â”€â”€â”€ ICONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const Icon = {
  back:   <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
  plus:   <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>,
  print:  <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
  trash:  <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6M9 6V4h6v2"/></svg>,
  search: <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
  upload: <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>,
  hist:   <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-4.95"/></svg>,
  cloud:  <svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" strokeWidth="2"><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"/></svg>,
  check:  <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
};

/* â”€â”€â”€ LOGIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function LoginScreen({onLogin, error, loading}){
  return (
    <div style={{
      minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",
      flexDirection:"column",gap:0,
      background:"linear-gradient(150deg,#0d1460,#1a237e,#1565c0)",
      fontFamily:"'DM Sans',sans-serif",
    }}>
      {/* Decorative blobs */}
      <div style={{position:"fixed",width:300,height:300,borderRadius:"50%",
        background:"rgba(255,255,255,.04)",top:-80,right:-80,pointerEvents:"none"}}/>
      <div style={{position:"fixed",width:200,height:200,borderRadius:"50%",
        background:"rgba(255,255,255,.04)",bottom:-60,left:-60,pointerEvents:"none"}}/>

      <div className="card fi" style={{
        padding:"40px 32px",maxWidth:360,width:"90%",textAlign:"center",
        boxShadow:"0 24px 60px rgba(0,0,0,0.4)",borderRadius:20,
      }}>
        {/* Logo / Icon */}
        <div style={{
          width:72,height:72,borderRadius:18,margin:"0 auto 18px",
          background:"linear-gradient(135deg,#1a237e,#1565c0)",
          display:"flex",alignItems:"center",justifyContent:"center",
          boxShadow:"0 8px 24px rgba(26,35,126,0.3)",
        }}>
          <span style={{fontSize:36}}>ğŸ«</span>
        </div>

        <div style={{fontFamily:"'Playfair Display',serif",fontSize:20,fontWeight:900,
          color:"#1a237e",lineHeight:1.2,marginBottom:6}}>
          SBS SHIKSHA NIKETAN
        </div>
        <div style={{fontSize:12,color:"#888",marginBottom:28}}>
          Marksheet Management System
        </div>

        {/* Error message */}
        {error && (
          <div style={{background:"#ffebee",color:"#c62828",padding:"10px 14px",
            borderRadius:10,fontSize:13,marginBottom:18,border:"1px solid #ffcdd2"}}>
            âš ï¸ {error}
          </div>
        )}

        {/* Google Sign In Button */}
        <button onClick={onLogin} disabled={loading} className="btn" style={{
          width:"100%",padding:"13px 20px",fontSize:14,
          background:loading?"#f5f5f5":"#fff",
          color:loading?"#aaa":"#333",
          border:"1.5px solid #e0e0e0",
          display:"flex",alignItems:"center",justifyContent:"center",gap:12,
          boxShadow:"0 2px 8px rgba(0,0,0,0.08)",
          borderRadius:12,
        }}>
          {loading ? (
            <>
              <span style={{width:18,height:18,border:"2px solid #ddd",
                borderTopColor:"#1a237e",borderRadius:"50%",display:"inline-block",
                animation:"spin 0.8s linear infinite"}}/>
              Login ho raha haiâ€¦
            </>
          ) : (
            <>
              {/* Google G logo SVG */}
              <svg width="18" height="18" viewBox="0 0 48 48">
                <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                <path fill="none" d="M0 0h48v48H0z"/>
              </svg>
              Google se Login Karein
            </>
          )}
        </button>

        <div style={{marginTop:20,fontSize:11,color:"#bbb",lineHeight:1.6}}>
          ğŸ”’ Sirf authorized Gmail accounts<br/>hi login kar sakte hain
        </div>
      </div>
    </div>
  );
}

/* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function Toast({msg}){
  if(!msg) return null;
  return <div className="toast no-print">{msg}</div>;
}

/* â”€â”€â”€ SYNC STATUS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function SyncBar({status, ts}){
  const cfg = {
    synced:  {c:"#43a047", t:"Firebase se sync ho gaya âœ“"},
    syncing: {c:"#fb8c00", t:"Save ho raha haiâ€¦"},
    error:   {c:"#e53935", t:"Sync fail â€” device pe save hua"},
    offline: {c:"#757575", t:"Offline â€” device storage se load"},
    idle:    {c:"#bdbdbd", t:"Ready"},
  };
  const {c,t} = cfg[status]||cfg.idle;
  return (
    <div style={{background:"#f0f2ff",borderBottom:"1px solid #dde1f5",padding:"5px 14px",
      display:"flex",alignItems:"center",gap:7,fontSize:11,color:"#555"}}>
      <span style={{width:8,height:8,borderRadius:"50%",background:c,display:"inline-block",
        animation:status==="syncing"?"pulse 1.1s infinite":""}}/>
      {Icon.cloud}
      <span style={{flex:1}}>{t}</span>
      {ts && status==="synced" && <span style={{color:"#aaa"}}>{ts}</span>}
    </div>
  );
}

/* â”€â”€â”€ STAT CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function StatCard({value, label, color}){
  return (
    <div style={{background:"rgba(255,255,255,.13)",borderRadius:12,padding:"9px 16px",textAlign:"center",minWidth:68}}>
      <div style={{fontSize:24,fontWeight:900,color}}>{value}</div>
      <div style={{fontSize:10,color:"rgba(255,255,255,.6)"}}>{label}</div>
    </div>
  );
}

/* â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function Dashboard({students, onNew, onSelect, syncStatus, syncTs, user, onLogout}){
  const [q, setQ] = useState("");

  // BUG FIX: useMemo for filtered list (performance)
  const filtered = useMemo(()=>
    students.filter(s =>
      (s.name||"").toLowerCase().includes(q.toLowerCase()) ||
      (s.roll||"").includes(q) ||
      (s.cls||"").includes(q)
    ), [students, q]);

  const passCount = useMemo(()=>
    students.filter(s => { const g=grandTotals(s.subs); return g.mT>0 && pct(g.oT,g.mT)>=33; }).length,
    [students]);

  const clsSet = useMemo(()=> new Set(students.map(s=>s.cls).filter(Boolean)), [students]);

  return (
    <div className="fi">
      <SyncBar status={syncStatus} ts={syncTs}/>
      <div style={{padding:14,paddingBottom:90}}>

        {/* Header card */}
        <div className="card" style={{
          padding:"22px 18px",marginBottom:14,textAlign:"center",
          background:"linear-gradient(150deg,#0d1460,#1a237e,#1565c0)",
          overflow:"hidden",position:"relative"
        }}>
          {/* Decorative circles */}
          <div style={{position:"absolute",width:120,height:120,borderRadius:"50%",
            background:"rgba(255,255,255,.05)",top:-30,right:-20,pointerEvents:"none"}}/>
          <div style={{position:"absolute",width:80,height:80,borderRadius:"50%",
            background:"rgba(255,255,255,.05)",bottom:-20,left:-10,pointerEvents:"none"}}/>
          <div style={{fontSize:10,letterSpacing:3,color:"rgba(255,255,255,.5)",fontWeight:700,marginBottom:4}}>
            SCHOOL MANAGEMENT SYSTEM
          </div>
          <div style={{fontSize:22,fontWeight:900,color:"#fff",
            fontFamily:"'Playfair Display',serif",lineHeight:1.2,marginBottom:2}}>
            {SCHOOL.name}
          </div>
          <div style={{fontSize:10,color:"#90caf9",marginBottom:14}}>{SCHOOL.addr}</div>
          {/* User info + logout */}
          {user && (
            <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:10,marginBottom:12}}>
              <img src={user.photoURL||""} alt=""
                style={{width:28,height:28,borderRadius:"50%",border:"2px solid rgba(255,255,255,.3)"}}
                onError={e=>e.target.style.display="none"}/>
              <span style={{fontSize:11,color:"rgba(255,255,255,.75)",maxWidth:180,
                overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>
                {user.displayName||user.email}
              </span>
              <button onClick={onLogout} style={{background:"rgba(255,255,255,.15)",border:"none",
                color:"#fff",borderRadius:8,padding:"4px 10px",fontSize:11,cursor:"pointer",fontWeight:600}}>
                Logout
              </button>
            </div>
          )}
          <div style={{display:"flex",justifyContent:"center",gap:10,flexWrap:"wrap"}}>
            <StatCard value={students.length} label="Students"  color="#fff"/>
            <StatCard value={passCount}        label="Passed"    color="#a5d6a7"/>
            <StatCard value={clsSet.size}      label="Classes"   color="#ffcc80"/>
            <StatCard value={students.length - passCount} label="Fail/Blank" color="#ef9a9a"/>
          </div>
        </div>

        {/* Search + New */}
        <div style={{display:"flex",gap:10,marginBottom:14}}>
          <div style={{flex:1,position:"relative"}}>
            <span style={{position:"absolute",left:11,top:"50%",transform:"translateY(-50%)",color:"#aaa"}}>{Icon.search}</span>
            <input value={q} onChange={e=>setQ(e.target.value)}
              placeholder="Naam, class ya roll se dhundeâ€¦"
              className="inp" style={{paddingLeft:34}}/>
          </div>
          <button onClick={onNew} className="btn"
            style={{background:"#1a237e",color:"#fff",display:"flex",alignItems:"center",gap:7,whiteSpace:"nowrap"}}>
            {Icon.plus} Naya Student
          </button>
        </div>

        {/* Student list */}
        {filtered.length === 0 ? (
          <div className="card" style={{padding:"50px 20px",textAlign:"center"}}>
            <div style={{fontSize:52,marginBottom:10}}>ğŸ“‹</div>
            <div style={{fontWeight:700,color:"#444",fontSize:15}}>
              {q ? "Koi student nahi mila" : "Abhi tak koi student nahi"}
            </div>
            <div style={{color:"#aaa",fontSize:12,marginTop:5}}>
              {q ? "Dusra naam/roll try karein" : '"Naya Student" tap karein'}
            </div>
          </div>
        ) : (
          <div style={{display:"flex",flexDirection:"column",gap:10}}>
            {filtered.map(s => {
              const g = grandTotals(s.subs);
              const p = g.mT>0 ? pct(g.oT,g.mT) : null;
              const pass = p!==null && p>=33;
              return (
                <div key={s.id} onClick={()=>onSelect(s.id)} className="card"
                  style={{padding:"13px 15px",display:"flex",alignItems:"center",gap:13,cursor:"pointer",
                    transition:"box-shadow .15s,transform .15s"}}
                  onMouseEnter={e=>{e.currentTarget.style.boxShadow="0 6px 24px rgba(0,0,0,.13)";e.currentTarget.style.transform="translateY(-1px)";}}
                  onMouseLeave={e=>{e.currentTarget.style.boxShadow="";e.currentTarget.style.transform="";}}>
                  <div style={{width:46,height:46,borderRadius:12,overflow:"hidden",
                    background:"linear-gradient(135deg,#c5cae9,#e8eaf6)",flexShrink:0,
                    display:"flex",alignItems:"center",justifyContent:"center"}}>
                    {s.photo
                      ? <img src={s.photo} style={{width:"100%",height:"100%",objectFit:"cover"}} alt=""/>
                      : <span style={{fontSize:22}}>ğŸ‘¤</span>}
                  </div>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontWeight:700,fontSize:14,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>
                      {s.name||"Naam nahi diya"}
                    </div>
                    <div style={{fontSize:11,color:"#888",marginTop:2}}>
                      Class <b>{s.cls||"?"}{s.sec?"-"+s.sec:""}</b>
                      {s.roll && <> Â· Roll <b>{s.roll}</b></>}
                      {s.session && <> Â· {s.session}</>}
                    </div>
                  </div>
                  {p !== null && (
                    <div style={{textAlign:"right",flexShrink:0}}>
                      <div style={{fontWeight:800,fontSize:15,color:pass?"#2e7d32":"#c62828"}}>{p}%</div>
                      <span style={{background:pass?"#e8f5e9":"#ffebee",color:pass?"#2e7d32":"#c62828",
                        padding:"2px 9px",borderRadius:20,fontSize:11,fontWeight:700}}>{grade(p)}</span>
                    </div>
                  )}
                  <div style={{color:"#ccc",marginLeft:4}}>â€º</div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}

/* â”€â”€â”€ EDITOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function Editor({student, onSave, onBack, onPrint, onDelete, showToast}){
  const [s, setS] = useState(()=>JSON.parse(JSON.stringify(student)));
  const [baks, setBaks] = useState([]);
  const [showBaks, setShowBaks] = useState(false);
  const [addrOpen, setAddrOpen] = useState(false);
  const [remOpen, setRemOpen] = useState(false);
  const [saving, setSaving] = useState(false);
  const photoRef = useRef();
  const timer = useRef();

  // Auto-save 1.5s after changes
  useEffect(()=>{
    clearTimeout(timer.current);
    timer.current = setTimeout(()=>onSave(s), 1500);
    return ()=>clearTimeout(timer.current);
  }, [s]);

  const upd = (k,v) => setS(p=>({...p,[k]:v,_updated:new Date().toISOString()}));
  const updSub = (i,k,v) => {
    setS(p=>{
      const a=[...p.subs]; a[i]={...a[i],[k]:v};
      return {...p,subs:a,_updated:new Date().toISOString()};
    });
  };

  // BUG FIX: clamp also handles decimal marks
  const clamp = (v, mm) => {
    if(v===""||v==="-") return "";
    let n = parseFloat(v);
    if(isNaN(n)) return "";
    if(n<0) n=0;
    const max = parseFloat(mm)||60;
    if(n>max) n=max;
    return String(Math.round(n*10)/10);  // keep 1 decimal max
  };

  const handlePhoto = e => {
    const f = e.target.files[0]; if(!f) return;
    if(f.size>800000){ showToast("âš ï¸ Image 800KB se zyada hai"); return; }
    const r = new FileReader();
    r.onload = ev => setS(p=>({...p,photo:ev.target.result}));
    r.readAsDataURL(f);
  };

  const loadBaks = async () => {
    try {
      const b = await fbBaks(s.id);
      setBaks(b); setShowBaks(true);
    } catch(e) {
      showToast("âš ï¸ Backup load nahi hua");
    }
  };

  const gt = grandTotals(s.subs);
  const op = gt.mT>0 ? pct(gt.oT,gt.mT) : null;
  const pass = op!==null && op>=33;
  const attPct = s.att.p && s.att.t && parseFloat(s.att.t)>0
    ? ((parseFloat(s.att.p)/parseFloat(s.att.t))*100).toFixed(0)+"%"
    : "";

  const addrMatches = ADDR_OPTS.filter(a=>
    a.toLowerCase().includes((s.addr||"").toLowerCase()) && (s.addr||"").length>0
  );

  return (
    <div className="fi" style={{paddingBottom:90}}>
      {/* Top bar */}
      <div style={{background:"linear-gradient(135deg,#1a237e,#283593)",
        padding:"12px 14px",display:"flex",alignItems:"center",gap:10,
        position:"sticky",top:0,zIndex:60}}>
        <button onClick={onBack} className="btn"
          style={{background:"rgba(255,255,255,.15)",color:"#fff",padding:"7px 11px",display:"flex",alignItems:"center"}}>
          {Icon.back}
        </button>
        <div style={{flex:1,overflow:"hidden"}}>
          <div style={{color:"#fff",fontWeight:700,fontSize:14,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>
            {s.name||"Naya Student"}
          </div>
          <div style={{color:"#90caf9",fontSize:11}}>
            {s.cls?"Class "+s.cls+(s.sec?"-"+s.sec:""):""}{s.session?" Â· "+s.session:""}
          </div>
        </div>
        <button onClick={loadBaks} className="btn"
          style={{background:"rgba(255,255,255,.13)",color:"#fff",padding:"7px 11px",display:"flex",alignItems:"center",gap:5,fontSize:11}}>
          {Icon.hist} Backup
        </button>
        <button onClick={()=>{onSave(s); onPrint(s);}} className="btn"
          style={{background:"#c62828",color:"#fff",display:"flex",alignItems:"center",gap:6}}>
          {Icon.print} Print
        </button>
      </div>

      <div style={{background:"#fffde7",borderBottom:"1px solid #fff176",padding:"5px 14px",
        fontSize:11,color:"#f57f17",display:"flex",alignItems:"center",gap:6}}>
        âš¡ Automatically Firebase mein save ho raha hai
      </div>

      <div style={{padding:14,display:"flex",flexDirection:"column",gap:13}}>

        {/* Score banner */}
        {op!==null && (
          <div style={{
            background:pass?"linear-gradient(135deg,#e8f5e9,#f1f8e9)":"linear-gradient(135deg,#ffebee,#fce4ec)",
            border:`1.5px solid ${pass?"#a5d6a7":"#ef9a9a"}`,borderRadius:14,
            padding:"13px 17px",display:"flex",justifyContent:"space-between",alignItems:"center",
          }}>
            <div>
              <div style={{fontSize:11,color:"#888",fontWeight:600}}>Overall Score</div>
              <div style={{fontSize:22,fontWeight:800,color:pass?"#2e7d32":"#c62828"}}>{gt.oT} / {gt.mT}</div>
            </div>
            <div style={{textAlign:"right"}}>
              <div style={{fontSize:30,fontWeight:900,color:pass?"#1b5e20":"#b71c1c",lineHeight:1}}>{op}%</div>
              <div style={{background:pass?"#2e7d32":"#c62828",color:"#fff",
                padding:"3px 13px",borderRadius:20,fontSize:12,fontWeight:700,display:"inline-block",marginTop:3}}>
                {grade(op)} â€” {gradeLabel(op)}
              </div>
            </div>
          </div>
        )}

        {/* Backups panel */}
        {showBaks && (
          <div className="card" style={{padding:14}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
              <b style={{fontSize:13}}>ğŸ“‚ Last 2 Cloud Backups</b>
              <button onClick={()=>setShowBaks(false)} style={{background:"none",border:"none",cursor:"pointer",fontSize:20,color:"#999"}}>âœ•</button>
            </div>
            {baks.length===0
              ? <div style={{color:"#bbb",fontSize:13}}>Abhi tak koi backup nahi</div>
              : baks.map((b,i)=>(
                  <div key={i} style={{border:"1px solid #eee",borderRadius:10,padding:"10px 13px",marginBottom:8,
                    display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                    <div>
                      <div style={{fontWeight:600,fontSize:13}}>{i===0?"ğŸ• Latest":"ğŸ•‘ Previous"}</div>
                      <div style={{fontSize:11,color:"#999"}}>{b._at?new Date(b._at).toLocaleString("en-IN"):""}</div>
                    </div>
                    <button onClick={()=>{setS({...b, _updated:new Date().toISOString()});setShowBaks(false);showToast("âœ… Backup restore ho gaya!");}}
                      className="btn" style={{background:"#1a237e",color:"#fff",padding:"6px 14px",fontSize:12}}>Restore</button>
                  </div>
                ))
            }
          </div>
        )}

        {/* Student Info */}
        <div className="card" style={{padding:14}}>
          <div style={{fontWeight:700,fontSize:13,marginBottom:12,color:"#333"}}>ğŸ‘¤ Student Information</div>
          <div style={{display:"flex",gap:12,marginBottom:11}}>
            {/* Photo */}
            <div onClick={()=>photoRef.current.click()} style={{
              width:80,height:96,border:"2px dashed #9fa8da",borderRadius:10,cursor:"pointer",
              overflow:"hidden",background:"#f5f7ff",display:"flex",flexDirection:"column",
              alignItems:"center",justifyContent:"center",flexShrink:0,gap:4,transition:"border-color .2s"
            }}
            onMouseEnter={e=>e.currentTarget.style.borderColor="#1a237e"}
            onMouseLeave={e=>e.currentTarget.style.borderColor="#9fa8da"}>
              {s.photo
                ? <img src={s.photo} style={{width:"100%",height:"100%",objectFit:"cover"}} alt=""/>
                : <>{Icon.upload}<span style={{fontSize:10,color:"#aaa",textAlign:"center"}}>Photo<br/><span style={{fontSize:9}}>max 800KB</span></span></>}
            </div>
            <input ref={photoRef} type="file" accept="image/*" style={{display:"none"}} onChange={handlePhoto}/>
            <div style={{flex:1,display:"flex",flexDirection:"column",gap:8}}>
              <input className="inp" placeholder="Student Full Name *" value={s.name}
                onChange={e=>upd("name",e.target.value)}/>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
                <input className="inp" placeholder="Class (e.g. 5)" value={s.cls}
                  onChange={e=>upd("cls",e.target.value)}/>
                <input className="inp" placeholder="Section (A/B)" value={s.sec}
                  onChange={e=>upd("sec",e.target.value)}/>
              </div>
            </div>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            <input className="inp" placeholder="Father's Name" value={s.father} onChange={e=>upd("father",e.target.value)}/>
            <input className="inp" placeholder="Mother's Name" value={s.mother} onChange={e=>upd("mother",e.target.value)}/>
            <input className="inp" placeholder="Roll No." value={s.roll} onChange={e=>upd("roll",e.target.value)}/>
            <input className="inp" placeholder="Admission No." value={s.admno} onChange={e=>upd("admno",e.target.value)}/>
            <input className="inp" type="date" value={s.dob}
              min="1999-01-01" max={new Date().toISOString().split("T")[0]}
              onChange={e=>upd("dob",e.target.value)}/>
            <input className="inp" placeholder="Session e.g. 2025-26" value={s.session} onChange={e=>upd("session",e.target.value)}/>
            {/* Address with autocomplete */}
            <div style={{gridColumn:"span 2",position:"relative"}}>
              <input className="inp" placeholder="Address" value={s.addr||""}
                onChange={e=>{upd("addr",e.target.value); setAddrOpen(true);}}
                onFocus={()=>setAddrOpen(true)}
                onBlur={()=>setTimeout(()=>setAddrOpen(false),200)}/>
              {addrOpen && addrMatches.length>0 && (
                <div className="sug">
                  {addrMatches.map((a,i)=>(
                    <div key={i} className="sug-item" onMouseDown={()=>{upd("addr",a); setAddrOpen(false);}}>
                      ğŸ“ {a}
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Attendance */}
        <div className="card" style={{padding:14}}>
          <div style={{fontWeight:700,fontSize:13,marginBottom:10,color:"#333"}}>ğŸ“… Haaziri (Attendance)</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            <div>
              <label style={{fontSize:11,color:"#888",display:"block",marginBottom:4}}>Haazir Din</label>
              <input className="inp" type="number" min="0" placeholder="e.g. 210" value={s.att.p}
                onChange={e=>setS(p=>({...p,att:{...p.att,p:e.target.value}}))}/>
            </div>
            <div>
              <label style={{fontSize:11,color:"#888",display:"block",marginBottom:4}}>Kul Kaarya Diwas</label>
              <input className="inp" type="number" min="0" placeholder="e.g. 240" value={s.att.t}
                onChange={e=>setS(p=>({...p,att:{...p.att,t:e.target.value}}))}/>
            </div>
          </div>
          {attPct && (
            <div style={{marginTop:8,fontSize:12,color:"#2e7d32",fontWeight:600,
              background:"#e8f5e9",padding:"6px 11px",borderRadius:8,display:"inline-flex",alignItems:"center",gap:5}}>
              {Icon.check} Haaziri: {attPct}
            </div>
          )}
        </div>

        {/* Marks Table */}
        <div className="card" style={{padding:14}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:11}}>
            <div style={{fontWeight:700,fontSize:13,color:"#333"}}>ğŸ“Š Marks â€” 3 Terms (MM: 60 each)</div>
            <button onClick={()=>setS(p=>({...p,subs:[...p.subs,{n:"",m1:60,o1:"",m2:60,o2:"",m3:60,o3:""}]}))}
              className="btn" style={{background:"#e3f2fd",color:"#1565c0",padding:"5px 13px",fontSize:12}}>
              + Subject
            </button>
          </div>
          <div style={{overflowX:"auto",WebkitOverflowScrolling:"touch"}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:11,minWidth:500}}>
              <thead>
                <tr style={{background:"#e8eaf6"}}>
                  <th style={{padding:"6px 5px",textAlign:"left",minWidth:85}}>Subject</th>
                  <th colSpan="2" style={{padding:5,color:"#1a237e",fontSize:10}}>Term 1</th>
                  <th colSpan="2" style={{padding:5,color:"#1a237e",fontSize:10}}>Term 2</th>
                  <th colSpan="2" style={{padding:5,color:"#1a237e",fontSize:10}}>Term 3</th>
                  <th style={{padding:5,color:"#c62828",fontSize:10}}>Total</th>
                  <th style={{padding:5,color:"#388e3c",fontSize:10}}>%</th>
                  <th style={{padding:5,color:"#6a1b9a",fontSize:10}}>Grade</th>
                  <th style={{width:22}}></th>
                </tr>
                <tr style={{background:"#f0f2ff",fontSize:9}}>
                  <th></th>
                  <th style={{padding:"2px",color:"#888"}}>MM</th><th style={{padding:"2px"}}>Obt</th>
                  <th style={{padding:"2px",color:"#888"}}>MM</th><th style={{padding:"2px"}}>Obt</th>
                  <th style={{padding:"2px",color:"#888"}}>MM</th><th style={{padding:"2px"}}>Obt</th>
                  <th/><th/><th/><th/>
                </tr>
              </thead>
              <tbody>
                {s.subs.map((sub,i)=>{
                  const tot=subObt(sub), mm=subMM(sub);
                  const p=mm>0?pct(tot,mm):null;
                  const pass=p!==null&&p>=33;
                  return (
                    <tr key={i} style={{borderBottom:"1px solid #eee",background:i%2===0?"#fafafa":"#fff"}}>
                      <td style={{padding:"2px"}}>
                        <input className="mi" style={{textAlign:"left",fontWeight:600,minWidth:80}}
                          value={sub.n} onChange={e=>updSub(i,"n",e.target.value)} placeholder="Subject"/>
                      </td>
                      <td style={{padding:"2px"}}><input className="mi" style={{width:34,background:"#e3f2fd"}} value={sub.m1} onChange={e=>updSub(i,"m1",e.target.value)}/></td>
                      <td style={{padding:"2px"}}><input className="mi" style={{width:34}} value={sub.o1} onChange={e=>updSub(i,"o1",clamp(e.target.value,sub.m1))}/></td>
                      <td style={{padding:"2px"}}><input className="mi" style={{width:34,background:"#e3f2fd"}} value={sub.m2} onChange={e=>updSub(i,"m2",e.target.value)}/></td>
                      <td style={{padding:"2px"}}><input className="mi" style={{width:34}} value={sub.o2} onChange={e=>updSub(i,"o2",clamp(e.target.value,sub.m2))}/></td>
                      <td style={{padding:"2px"}}><input className="mi" style={{width:34,background:"#e3f2fd"}} value={sub.m3} onChange={e=>updSub(i,"m3",e.target.value)}/></td>
                      <td style={{padding:"2px"}}><input className="mi" style={{width:34}} value={sub.o3} onChange={e=>updSub(i,"o3",clamp(e.target.value,sub.m3))}/></td>
                      <td style={{padding:"3px 4px",fontWeight:700,color:"#c62828",textAlign:"center"}}>{mm>0?tot:""}</td>
                      <td style={{padding:"3px 4px",textAlign:"center",fontWeight:600,color:pass?"#2e7d32":"#c62828"}}>{p!==null?p+"%":""}</td>
                      <td style={{padding:"3px 4px",textAlign:"center"}}>
                        {p!==null && (
                          <span style={{background:pass?"#e8f5e9":"#ffebee",color:pass?"#2e7d32":"#c62828",
                            padding:"1px 5px",borderRadius:7,fontSize:10,fontWeight:700}}>{grade(p)}</span>
                        )}
                      </td>
                      <td>
                        <button onClick={()=>setS(p=>({...p,subs:p.subs.filter((_,j)=>j!==i)}))}
                          style={{background:"none",border:"none",cursor:"pointer",color:"#ef9a9a",padding:2}}>{Icon.trash}</button>
                      </td>
                    </tr>
                  );
                })}
                {/* Grand total row */}
                <tr style={{background:"#e8eaf6",fontWeight:800,fontSize:12}}>
                  <td style={{padding:"6px 5px"}}>TOTAL</td>
                  <td style={{textAlign:"center",color:"#777"}}>{gt.m1}</td>
                  <td style={{textAlign:"center"}}>{gt.o1}</td>
                  <td style={{textAlign:"center",color:"#777"}}>{gt.m2}</td>
                  <td style={{textAlign:"center"}}>{gt.o2}</td>
                  <td style={{textAlign:"center",color:"#777"}}>{gt.m3}</td>
                  <td style={{textAlign:"center"}}>{gt.o3}</td>
                  <td style={{textAlign:"center",color:"#c62828"}}>{gt.oT}/{gt.mT}</td>
                  <td style={{textAlign:"center",color:pass?"#2e7d32":"#c62828"}}>{op!==null?op+"%":""}</td>
                  <td style={{textAlign:"center"}}>
                    <span style={{background:"#1a237e",color:"#fff",padding:"1px 6px",borderRadius:7,fontSize:10}}>
                      {op!==null?grade(op):""}
                    </span>
                  </td>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        {/* Co-Scholastic */}
        <div className="card" style={{padding:14}}>
          <div style={{fontWeight:700,fontSize:13,marginBottom:10,color:"#333"}}>ğŸ¨ Co-Scholastic Activities</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            {[["sports","âš½ Sports & Games"],["art","ğŸ¨ Art & Craft"],
              ["music","ğŸµ Music & Dance"],["disc","ğŸ“ Discipline"],["clean","âœ¨ Cleanliness"]].map(([k,lbl])=>(
              <div key={k}>
                <label style={{fontSize:11,color:"#888",display:"block",marginBottom:3}}>{lbl}</label>
                <select className="inp" value={s.cosco[k]}
                  onChange={e=>setS(p=>({...p,cosco:{...p.cosco,[k]:e.target.value}}))}>
                  <option value="">â€” Chunein â€”</option>
                  {["A+","A","B+","B","C"].map(g=><option key={g} value={g}>{g}</option>)}
                </select>
              </div>
            ))}
          </div>
        </div>

        {/* Remarks + Rank */}
        <div className="card" style={{padding:14}}>
          <div style={{fontWeight:700,fontSize:13,marginBottom:11,color:"#333"}}>âœï¸ Remarks & Result</div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:10}}>
            <div>
              <label style={{fontSize:11,color:"#888",display:"block",marginBottom:4}}>Class Rank</label>
              <input className="inp" placeholder="e.g. 3rd" value={s.rank||""} onChange={e=>upd("rank",e.target.value)}/>
            </div>
            <div>
              <label style={{fontSize:11,color:"#888",display:"block",marginBottom:4}}>Attendance</label>
              <input className="inp" readOnly value={attPct} style={{background:"#f5f5f5",color:"#444"}}/>
            </div>
          </div>
          <label style={{fontSize:11,color:"#888",display:"block",marginBottom:4}}>
            Teacher's Remark <span style={{color:"#9fa8da"}}>(field tap karein suggestions ke liye)</span>
          </label>
          <div style={{position:"relative"}}>
            <textarea className="inp" rows={2} value={s.remark||""} placeholder="Suggestion chunein ya khud likheinâ€¦"
              onChange={e=>upd("remark",e.target.value)}
              onFocus={()=>setRemOpen(true)}
              onBlur={()=>setTimeout(()=>setRemOpen(false),200)}
              style={{resize:"none"}}/>
            {remOpen && (
              <div className="sug">
                {REMARK_OPTS.map((r,i)=>(
                  <div key={i} className="sug-item" onMouseDown={()=>{upd("remark",r); setRemOpen(false);}}>
                    ğŸ’¬ {r}
                  </div>
                ))}
                <div className="sug-item" style={{color:"#aaa",fontStyle:"italic"}} onMouseDown={()=>setRemOpen(false)}>
                  âœï¸ Upar khud ki remark likhein
                </div>
              </div>
            )}
          </div>
        </div>

        {/* Delete */}
        <button onClick={onDelete} className="btn"
          style={{width:"100%",background:"#fff5f5",color:"#c62828",border:"1.5px solid #ffcdd2",fontSize:13}}>
          ğŸ—‘ï¸ Is Student Ko Permanently Delete Karein
        </button>
      </div>
    </div>
  );
}

/* â”€â”€â”€ MARKSHEET PRINT VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function PrintView({student:s, onClose}){
  const gt = grandTotals(s.subs);
  const op = gt.mT>0 ? pct(gt.oT,gt.mT) : null;
  const attDisp = s.att.p && s.att.t && parseFloat(s.att.t)>0
    ? ((parseFloat(s.att.p)/parseFloat(s.att.t))*100).toFixed(0)+"%"
    : (s.att.p ? s.att.p+" din" : "");

  const t1p = gt.m1>0 ? ((gt.o1/gt.m1)*100).toFixed(0)+"%" : "";
  const t2p = gt.m2>0 ? ((gt.o2/gt.m2)*100).toFixed(0)+"%" : "";
  const t3p = gt.m3>0 ? ((gt.o3/gt.m3)*100).toFixed(0)+"%" : "";

  const border  = "1px solid #000";
  const headerBg = "#fce4d6";
  const infoTeal = "#d1eeee";

  return (
    <div className="fi">
      {/* Screen controls */}
      <div className="no-print" style={{background:"#1a237e",padding:"12px 15px",
        display:"flex",alignItems:"center",gap:10,position:"sticky",top:0,zIndex:60}}>
        <button onClick={onClose} className="btn"
          style={{background:"rgba(255,255,255,.15)",color:"#fff",display:"flex",alignItems:"center",gap:6}}>
          {Icon.back} Back
        </button>
        <div style={{flex:1,color:"#fff",fontWeight:600,fontSize:13,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>
          {s.name} â€” Marksheet Preview
        </div>
        <button onClick={()=>window.print()} className="btn"
          style={{background:"#c62828",color:"#fff",display:"flex",alignItems:"center",gap:6}}>
          {Icon.print} Print / PDF Save
        </button>
      </div>
      <div className="no-print" style={{background:"#fff8e1",padding:"7px 15px",fontSize:12,color:"#e65100",textAlign:"center"}}>
        ğŸ’¡ Chrome â†’ Print â†’ Destination: "Save as PDF" â†’ More settings â†’ Margins: None â†’ Print
      </div>

      {/* THE A4 MARKSHEET */}
      <div id="MARKSHEET" style={{
        width:"210mm",height:"297mm",background:"white",margin:"0 auto",
        padding:"4mm",boxSizing:"border-box",overflow:"hidden",
        fontFamily:"Arial,Helvetica,sans-serif",display:"flex",flexDirection:"column",
      }}>
        <div style={{border:"3.5px solid #c62828",flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
          <div style={{border:"1px solid #000",margin:"2px",flex:1,display:"flex",flexDirection:"column",
            padding:"5px 7px 4px",overflow:"hidden",gap:3}}>

            {/* HEADER */}
            <div style={{display:"flex",alignItems:"center",gap:6,flexShrink:0}}>
              <div style={{width:78,height:78,border:"1px solid #bbb",overflow:"hidden",display:"flex",
                alignItems:"center",justifyContent:"center",flexShrink:0,marginTop:8,marginLeft:2,background:"#f8f8f8"}}>
                <img src={SCHOOL.logo} alt="Logo" style={{width:"100%",height:"100%",objectFit:"contain"}}
                  onError={e=>{e.target.style.display="none";
                    e.target.parentNode.innerHTML='<div style="font-size:8px;color:#bbb;text-align:center;padding:4px;line-height:1.4">SCHOOL<br/>LOGO</div>';}}/>
              </div>
              <div style={{flex:1,textAlign:"center",padding:"0 6px"}}>
                <div style={{fontSize:23,fontWeight:900,color:"#c62828",
                  fontFamily:'"Times New Roman",Times,serif',textTransform:"uppercase",letterSpacing:0.5,lineHeight:1.15}}>
                  {SCHOOL.name}
                </div>
                <div style={{fontSize:9.5,fontWeight:700,color:"#111",marginTop:2}}>{SCHOOL.addr}</div>
                <div style={{display:"inline-block",background:"#ffff00",color:"#c62828",
                  padding:"2px 16px",fontWeight:900,fontSize:11.5,
                  borderBottom:"2px solid #c62828",textDecoration:"underline",marginTop:5,marginBottom:4}}>
                  PROGRESS EVALUATION REPORT
                </div>
                <div style={{fontSize:10.5,fontWeight:700,color:"#1a237e",lineHeight:1.5}}>
                  ACADEMIC SESSION :&nbsp;<span style={{color:"#000",fontFamily:'"Times New Roman",serif'}}>{s.session}</span>
                </div>
                <div style={{fontSize:12,fontWeight:900,color:"#000",fontFamily:'"Times New Roman",Times,serif',lineHeight:1.4}}>
                  CLASS :&nbsp;{s.cls}{s.sec?"-"+s.sec:""}
                </div>
              </div>
              <div style={{width:72,height:86,border:"1.5px solid #000",overflow:"hidden",flexShrink:0,
                background:"#f5f5f5",display:"flex",alignItems:"center",justifyContent:"center",marginTop:14,marginRight:2}}>
                {s.photo
                  ? <img src={s.photo} style={{width:"100%",height:"100%",objectFit:"cover"}} alt=""/>
                  : <span style={{fontSize:9,color:"#bbb",textAlign:"center"}}>Student<br/>Photo</span>}
              </div>
            </div>

            {/* STUDENT INFO */}
            <div style={{background:infoTeal,borderTop:"2px solid #000",borderBottom:"2px solid #000",
              padding:"5px 8px",fontFamily:'"Times New Roman",Times,serif',fontSize:10,fontWeight:700,flexShrink:0}}>
              <div style={{display:"grid",gridTemplateColumns:"57% 43%"}}>
                <div style={{display:"flex",flexDirection:"column",gap:"3px",borderRight:"1px solid rgba(0,0,0,.15)",paddingRight:6}}>
                  {[
                    ["STUDENT'S NAME",(s.name||"").toUpperCase()],
                    ["MOTHER'S NAME", (s.mother||"").toUpperCase()],
                    ["FATHER'S NAME", (s.father||"").toUpperCase()],
                    ["ADDRESS",       (s.addr||"").toUpperCase()],
                  ].map(([label,val])=>(
                    <div key={label} style={{display:"flex",alignItems:"flex-start",minHeight:16}}>
                      <span style={{width:110,flexShrink:0,fontSize:9.5,fontWeight:700}}>{label}</span>
                      <span style={{marginRight:4,fontWeight:700}}>:</span>
                      <span style={{flex:1,fontSize:9.5,wordBreak:"break-word",lineHeight:1.3}}>{val}</span>
                    </div>
                  ))}
                </div>
                <div style={{display:"flex",flexDirection:"column",gap:"3px",paddingLeft:8}}>
                  {[
                    ["ROLL NO.",      s.roll||""],
                    ["ADMISSION NO.", s.admno||""],
                    ["DATE OF BIRTH", s.dob||""],
                  ].map(([label,val])=>(
                    <div key={label} style={{display:"flex",alignItems:"center",minHeight:16}}>
                      <span style={{width:100,flexShrink:0,fontSize:9.5,fontWeight:700}}>{label}</span>
                      <span style={{marginRight:4,fontWeight:700}}>:</span>
                      <span style={{fontSize:9.5,fontWeight:900}}>{val}</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* MARKS TABLE */}
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:9.5,tableLayout:"fixed",flexShrink:0}}>
              <colgroup>
                <col style={{width:"21%"}}/>
                <col style={{width:"5.5%"}}/><col style={{width:"8%"}}/>
                <col style={{width:"5.5%"}}/><col style={{width:"8%"}}/>
                <col style={{width:"5.5%"}}/><col style={{width:"8%"}}/>
                <col style={{width:"5.5%"}}/><col style={{width:"9%"}}/>
                <col style={{width:"7%"}}/>
              </colgroup>
              <thead>
                <tr style={{background:headerBg,height:26}}>
                  <th rowSpan={2} style={{border,textAlign:"left",paddingLeft:4,fontWeight:800,fontSize:10,verticalAlign:"middle"}}>SUBJECTS</th>
                  <th colSpan={2} style={{border,color:"#1a237e",fontWeight:700,fontSize:9,textAlign:"center"}}>FIRST TERM EXAM</th>
                  <th colSpan={2} style={{border,color:"#1a237e",fontWeight:700,fontSize:9,textAlign:"center"}}>SECOND TERM EXAM</th>
                  <th colSpan={2} style={{border,color:"#1a237e",fontWeight:700,fontSize:9,textAlign:"center"}}>THIRD TERM EXAM</th>
                  <th colSpan={2} style={{border,color:"#1a237e",fontWeight:700,fontSize:9,textAlign:"center"}}>GRAND TOTAL</th>
                  <th rowSpan={2} style={{border,fontWeight:700,fontSize:9,textAlign:"center",verticalAlign:"middle"}}>GRADE</th>
                </tr>
                <tr style={{background:headerBg,height:20}}>
                  {["MM","MARKS OBT","MM","MARKS OBT","MM","MARKS OBT","MM","TOTAL"].map((h,i)=>(
                    <th key={i} style={{border,color:i%2===0?"#0070c0":"#222",fontWeight:700,fontSize:8,textAlign:"center",padding:"1px"}}>{h}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {s.subs.map((sub,i)=>{
                  const tot=subObt(sub), mm=subMM(sub);
                  const p=mm>0?pct(tot,mm):null;
                  return (
                    <tr key={i} style={{height:22,background:i%2===0?"#fff":"#f9f9f9"}}>
                      <td style={{border,paddingLeft:4,fontWeight:700,textTransform:"uppercase",
                        fontSize:9.5,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{sub.n}</td>
                      <td style={{border,textAlign:"center",color:"#0070c0",fontWeight:700}}>{sub.m1}</td>
                      <td style={{border,textAlign:"center",fontWeight:600}}>{sub.o1}</td>
                      <td style={{border,textAlign:"center",color:"#0070c0",fontWeight:700}}>{sub.m2}</td>
                      <td style={{border,textAlign:"center",fontWeight:600}}>{sub.o2}</td>
                      <td style={{border,textAlign:"center",color:"#0070c0",fontWeight:700}}>{sub.m3}</td>
                      <td style={{border,textAlign:"center",fontWeight:600}}>{sub.o3}</td>
                      <td style={{border,textAlign:"center",color:"#0070c0",fontWeight:700}}>{mm>0?mm:""}</td>
                      <td style={{border,textAlign:"center",fontWeight:800}}>{mm>0?tot:""}</td>
                      {/* BUG FIX: Grade column was missing in app.js version */}
                      <td style={{border,textAlign:"center",fontWeight:900,fontSize:10,
                        color:p!==null&&p<33?"#c62828":"#1a237e"}}>{p!==null?grade(p):""}</td>
                    </tr>
                  );
                })}
                <tr style={{background:"#f0f0f0",fontWeight:800,height:24,fontSize:9.5}}>
                  <td style={{border,paddingLeft:4,fontWeight:900}}>TOTAL</td>
                  <td style={{border,textAlign:"center",color:"#0070c0"}}>{gt.m1}</td>
                  <td style={{border,textAlign:"center"}}>{gt.o1||""}</td>
                  <td style={{border,textAlign:"center",color:"#0070c0"}}>{gt.m2}</td>
                  <td style={{border,textAlign:"center"}}>{gt.o2||""}</td>
                  <td style={{border,textAlign:"center",color:"#0070c0"}}>{gt.m3}</td>
                  <td style={{border,textAlign:"center"}}>{gt.o3||""}</td>
                  <td style={{border,textAlign:"center",color:"#0070c0"}}>{gt.mT}</td>
                  <td style={{border,textAlign:"center",fontWeight:900}}>{gt.oT}</td>
                  <td style={{border}}></td>
                </tr>
                <tr style={{background:"#f0f0f0",fontWeight:800,height:24,fontSize:9.5}}>
                  <td style={{border,paddingLeft:4,fontWeight:900}}>PERCENTAGE</td>
                  <td colSpan={2} style={{border,textAlign:"center"}}>{t1p}</td>
                  <td colSpan={2} style={{border,textAlign:"center"}}>{t2p}</td>
                  <td colSpan={2} style={{border,textAlign:"center"}}>{t3p}</td>
                  <td colSpan={2} style={{border,textAlign:"center",fontSize:12,fontWeight:900}}>{op!==null?op+"%":""}</td>
                  <td style={{border,textAlign:"center",fontWeight:900,fontSize:11,color:"#1a237e"}}>{grade(op)}</td>
                </tr>
              </tbody>
            </table>

            {/* CO-SCHOLASTIC */}
            <div style={{flexShrink:0}}>
              <div style={{background:headerBg,fontWeight:700,fontSize:9,padding:"3px 6px",border,
                display:"flex",justifyContent:"space-between",borderBottom:"none"}}>
                <span>Co-Scholastic Area</span>
                <span>A+:Outstanding Â· A:Excellent Â· B+:Very Good Â· B:Good Â· C:Average</span>
              </div>
              {/* BUG FIX: Co-scholastic grades now correctly rendered */}
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:9}}>
                <tbody>
                  <tr style={{height:22}}>
                    {[["Sports & Games","sports"],["Art & Craft","art"],
                      ["Music & Dance","music"],["Discipline","disc"],["Cleanliness","clean"]].map(([lbl,k])=>(
                      <React.Fragment key={k}>
                        <td style={{border,padding:"2px 5px",fontWeight:700,background:"#fafafa",fontSize:9}}>{lbl}</td>
                        <td style={{border,textAlign:"center",fontWeight:900,color:"#1a237e",width:"5%"}}>{s.cosco[k]||""}</td>
                      </React.Fragment>
                    ))}
                  </tr>
                </tbody>
              </table>
            </div>

            {/* GRADE SCALE */}
            <div style={{display:"flex",border,height:22,fontSize:8,flexShrink:0}}>
              <div style={{background:"#4a4a4a",color:"#fff",width:"12%",display:"flex",
                alignItems:"center",justifyContent:"center",textAlign:"center",
                padding:"0 3px",lineHeight:1.3,fontSize:7.5,fontWeight:700}}>GRADE<br/>SCALE</div>
              <div style={{flex:1,display:"flex"}}>
                {GRADE_TABLE.map((r,i)=>(
                  <div key={i} style={{flex:1,background:"#dbe5f1",borderLeft:"1px solid rgba(255,255,255,.8)",
                    display:"flex",alignItems:"center",justifyContent:"center",fontWeight:700,fontSize:7.5,
                    textAlign:"center",lineHeight:1.2}}>
                    {r.min===0?"00":r.min}â€“{r.max}<br/>{r.g}
                  </div>
                ))}
              </div>
            </div>

            {/* REMARK / RANK / ATTENDANCE */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 110px 140px",gap:"0 12px",
              alignItems:"flex-end",padding:"3px 2px 2px",fontSize:10,fontWeight:700,flexShrink:0}}>
              <div style={{display:"flex",alignItems:"flex-end",gap:4}}>
                <span style={{whiteSpace:"nowrap",fontSize:10}}>Remark :</span>
                <span style={{flex:1,borderBottom:"1.5px solid #000",paddingBottom:1,fontSize:9.5,
                  lineHeight:1.3,wordBreak:"break-word"}}>{s.remark}</span>
              </div>
              <div style={{display:"flex",alignItems:"flex-end",gap:4,justifyContent:"center"}}>
                <span style={{fontSize:10}}>Rank :</span>
                <span style={{borderBottom:"1.5px solid #000",minWidth:44,textAlign:"center",paddingBottom:1}}>{s.rank||""}</span>
              </div>
              <div style={{display:"flex",alignItems:"flex-end",gap:4,justifyContent:"flex-end"}}>
                <span style={{whiteSpace:"nowrap",fontSize:10}}>Attendance :</span>
                <span style={{borderBottom:"1.5px solid #000",minWidth:40,paddingBottom:1}}>{attDisp}</span>
              </div>
            </div>

            {/* SIGNATURES */}
            <div style={{display:"flex",justifyContent:"space-between",padding:"8px 18px 0",
              fontSize:10,fontWeight:700,flexShrink:0,marginTop:"auto"}}>
              {["Date","Class Teacher","Principal"].map(lbl=>(
                <div key={lbl} style={{textAlign:"center"}}>
                  <div style={{borderTop:"2px dotted #444",width:105,marginBottom:4}}></div>{lbl}
                </div>
              ))}
            </div>

          </div>
        </div>
      </div>
    </div>
  );
}

/* â”€â”€â”€ LIVE PREVIEW (Desktop right pane) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function LivePreview({student:s}){
  if(!s) return (
    <div style={{color:"#aaa",textAlign:"center",marginTop:80}}>
      <div style={{fontSize:50,marginBottom:12}}>ğŸ“„</div>
      <div style={{fontSize:13}}>Student select karein preview ke liye</div>
    </div>
  );
  const gt = grandTotals(s.subs);
  const op = gt.mT>0 ? pct(gt.oT,gt.mT) : null;
  const attDisp = s.att.p && s.att.t && parseFloat(s.att.t)>0 ? ((parseFloat(s.att.p)/parseFloat(s.att.t))*100).toFixed(0)+"%" : "";
  const border = "0.8px solid #000";
  const infoTeal = "#d1eeee";
  const headerBg = "#fce4d6";
  const t1p = gt.m1>0?((gt.o1/gt.m1)*100).toFixed(0)+"%":"";
  const t2p = gt.m2>0?((gt.o2/gt.m2)*100).toFixed(0)+"%":"";
  const t3p = gt.m3>0?((gt.o3/gt.m3)*100).toFixed(0)+"%":"";

  const SCALE = 0.63;
  return (
    <div style={{width:"100%",display:"flex",flexDirection:"column",alignItems:"center"}}>
      <div style={{
        width:"210mm",height:"297mm",background:"white",
        fontFamily:"Arial,sans-serif",boxShadow:"0 12px 50px rgba(0,0,0,.5)",
        transform:`scale(${SCALE})`,transformOrigin:"top center",
        marginBottom:`calc((${SCALE} - 1) * 297mm)`,
        padding:"4mm",boxSizing:"border-box",overflow:"hidden",display:"flex",flexDirection:"column",
      }}>
        <div style={{border:"3.5px solid #c62828",flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
          <div style={{border:"1px solid #000",margin:"2px",flex:1,display:"flex",flexDirection:"column",
            padding:"5px 7px 4px",overflow:"hidden",gap:3}}>
            {/* header */}
            <div style={{display:"flex",alignItems:"center",gap:6,flexShrink:0}}>
              <div style={{width:78,height:78,border:"1px solid #bbb",overflow:"hidden",
                display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,marginTop:8,marginLeft:2,background:"#f8f8f8"}}>
                <img src={SCHOOL.logo} alt="" style={{width:"100%",height:"100%",objectFit:"contain"}}
                  onError={e=>{e.target.style.display="none";}}/>
              </div>
              <div style={{flex:1,textAlign:"center",padding:"0 6px"}}>
                <div style={{fontSize:23,fontWeight:900,color:"#c62828",fontFamily:"serif",textTransform:"uppercase"}}>{SCHOOL.name}</div>
                <div style={{fontSize:9.5,fontWeight:700}}>{SCHOOL.addr}</div>
                <div style={{display:"inline-block",background:"#ff0",color:"#c62828",padding:"2px 16px",fontWeight:900,
                  fontSize:11.5,borderBottom:"2px solid #c62828",textDecoration:"underline",marginTop:5,marginBottom:4}}>
                  PROGRESS EVALUATION REPORT
                </div>
                <div style={{fontSize:10.5,fontWeight:700,color:"#1a237e"}}>ACADEMIC SESSION :&nbsp;<span style={{color:"#000"}}>{s.session}</span></div>
                <div style={{fontSize:12,fontWeight:900}}>CLASS :&nbsp;{s.cls}{s.sec?"-"+s.sec:""}</div>
              </div>
              <div style={{width:72,height:86,border:"1.5px solid #000",overflow:"hidden",flexShrink:0,
                background:"#f5f5f5",display:"flex",alignItems:"center",justifyContent:"center",marginTop:14,marginRight:2}}>
                {s.photo?<img src={s.photo} style={{width:"100%",height:"100%",objectFit:"cover"}} alt=""/>
                  :<span style={{fontSize:9,color:"#bbb",textAlign:"center"}}>Photo</span>}
              </div>
            </div>
            {/* student info */}
            <div style={{background:infoTeal,borderTop:"2px solid #000",borderBottom:"2px solid #000",
              padding:"5px 8px",fontFamily:"serif",fontSize:10,fontWeight:700,flexShrink:0}}>
              <div style={{display:"grid",gridTemplateColumns:"57% 43%"}}>
                <div style={{display:"flex",flexDirection:"column",gap:3,borderRight:"1px solid rgba(0,0,0,.15)",paddingRight:6}}>
                  {[["STUDENT'S NAME",(s.name||"").toUpperCase()],["MOTHER'S NAME",(s.mother||"").toUpperCase()],
                    ["FATHER'S NAME",(s.father||"").toUpperCase()],["ADDRESS",(s.addr||"").toUpperCase()]].map(([l,v])=>(
                    <div key={l} style={{display:"flex",minHeight:16}}>
                      <span style={{width:110,flexShrink:0,fontSize:9.5}}>{l}</span>
                      <span style={{marginRight:4}}>:</span>
                      <span style={{flex:1,fontSize:9.5,wordBreak:"break-word"}}>{v}</span>
                    </div>
                  ))}
                </div>
                <div style={{display:"flex",flexDirection:"column",gap:3,paddingLeft:8}}>
                  {[["ROLL NO.",s.roll||""],["ADMISSION NO.",s.admno||""],["DATE OF BIRTH",s.dob||""]].map(([l,v])=>(
                    <div key={l} style={{display:"flex",minHeight:16}}>
                      <span style={{width:100,flexShrink:0,fontSize:9.5}}>{l}</span>
                      <span style={{marginRight:4}}>:</span>
                      <span style={{fontSize:9.5,fontWeight:900}}>{v}</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>
            {/* marks */}
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:9.5,tableLayout:"fixed",flexShrink:0}}>
              <colgroup>
                <col style={{width:"21%"}}/><col style={{width:"5.5%"}}/><col style={{width:"8%"}}/>
                <col style={{width:"5.5%"}}/><col style={{width:"8%"}}/><col style={{width:"5.5%"}}/><col style={{width:"8%"}}/>
                <col style={{width:"5.5%"}}/><col style={{width:"9%"}}/><col style={{width:"7%"}}/>
              </colgroup>
              <thead>
                <tr style={{background:headerBg,height:26}}>
                  <th rowSpan={2} style={{border,textAlign:"left",paddingLeft:3,fontWeight:800,verticalAlign:"middle"}}>SUBJECTS</th>
                  {[["FIRST TERM EXAM"],["SECOND TERM EXAM"],["THIRD TERM EXAM"],["GRAND TOTAL"]].map(([h])=>(
                    <th key={h} colSpan={2} style={{border,color:"#1a237e",fontWeight:700,fontSize:9,textAlign:"center"}}>{h}</th>
                  ))}
                  <th rowSpan={2} style={{border,fontWeight:700,fontSize:9,textAlign:"center",verticalAlign:"middle"}}>GRADE</th>
                </tr>
                <tr style={{background:headerBg,height:20}}>
                  {["MM","OBT","MM","OBT","MM","OBT","MM","TOTAL"].map((h,i)=>(
                    <th key={i} style={{border,color:i%2===0?"#0070c0":"#222",fontWeight:700,fontSize:8,textAlign:"center"}}>{h}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {s.subs.map((sub,i)=>{
                  const tot=subObt(sub),mm=subMM(sub),p=mm>0?pct(tot,mm):null;
                  return (
                    <tr key={i} style={{height:22,background:i%2===0?"#fff":"#f9f9f9"}}>
                      <td style={{border,paddingLeft:3,fontWeight:700,textTransform:"uppercase",overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"}}>{sub.n}</td>
                      <td style={{border,textAlign:"center",color:"#0070c0",fontWeight:700}}>{sub.m1}</td><td style={{border,textAlign:"center"}}>{sub.o1}</td>
                      <td style={{border,textAlign:"center",color:"#0070c0",fontWeight:700}}>{sub.m2}</td><td style={{border,textAlign:"center"}}>{sub.o2}</td>
                      <td style={{border,textAlign:"center",color:"#0070c0",fontWeight:700}}>{sub.m3}</td><td style={{border,textAlign:"center"}}>{sub.o3}</td>
                      <td style={{border,textAlign:"center",color:"#0070c0",fontWeight:700}}>{mm>0?mm:""}</td>
                      <td style={{border,textAlign:"center",fontWeight:800}}>{mm>0?tot:""}</td>
                      <td style={{border,textAlign:"center",fontWeight:900,fontSize:10,color:p!==null&&p<33?"#c62828":"#1a237e"}}>{p!==null?grade(p):""}</td>
                    </tr>
                  );
                })}
                <tr style={{background:"#f0f0f0",fontWeight:800,height:24,fontSize:9.5}}>
                  <td style={{border,paddingLeft:3,fontWeight:900}}>TOTAL</td>
                  <td style={{border,textAlign:"center",color:"#0070c0"}}>{gt.m1}</td><td style={{border,textAlign:"center"}}>{gt.o1||""}</td>
                  <td style={{border,textAlign:"center",color:"#0070c0"}}>{gt.m2}</td><td style={{border,textAlign:"center"}}>{gt.o2||""}</td>
                  <td style={{border,textAlign:"center",color:"#0070c0"}}>{gt.m3}</td><td style={{border,textAlign:"center"}}>{gt.o3||""}</td>
                  <td style={{border,textAlign:"center",color:"#0070c0"}}>{gt.mT}</td><td style={{border,textAlign:"center",fontWeight:900}}>{gt.oT}</td>
                  <td style={{border}}></td>
                </tr>
                <tr style={{background:"#f0f0f0",fontWeight:800,height:24,fontSize:9.5}}>
                  <td style={{border,paddingLeft:3,fontWeight:900}}>PERCENTAGE</td>
                  <td colSpan={2} style={{border,textAlign:"center"}}>{t1p}</td>
                  <td colSpan={2} style={{border,textAlign:"center"}}>{t2p}</td>
                  <td colSpan={2} style={{border,textAlign:"center"}}>{t3p}</td>
                  <td colSpan={2} style={{border,textAlign:"center",fontSize:12,fontWeight:900}}>{op!==null?op+"%":""}</td>
                  <td style={{border,textAlign:"center",fontWeight:900,color:"#1a237e"}}>{grade(op)}</td>
                </tr>
              </tbody>
            </table>
            {/* co-scho */}
            <div style={{flexShrink:0}}>
              <div style={{background:headerBg,fontWeight:700,fontSize:9,padding:"3px 6px",border,borderBottom:"none",
                display:"flex",justifyContent:"space-between"}}>
                <span>Co-Scholastic Area</span>
                <span>A+:Outstanding Â· A:Excellent Â· B+:Very Good Â· B:Good Â· C:Average</span>
              </div>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:9}}>
                <tbody><tr style={{height:22}}>
                  {[["Sports","sports"],["Art","art"],["Music","music"],["Discipline","disc"],["Cleanliness","clean"]].map(([l,k])=>(
                    <React.Fragment key={k}>
                      <td style={{border,padding:"2px 5px",fontWeight:700,background:"#fafafa"}}>{l}</td>
                      <td style={{border,textAlign:"center",fontWeight:900,color:"#1a237e",width:"5%"}}>{s.cosco[k]||""}</td>
                    </React.Fragment>
                  ))}
                </tr></tbody>
              </table>
            </div>
            {/* grade scale */}
            <div style={{display:"flex",border,height:22,fontSize:8,flexShrink:0}}>
              <div style={{background:"#4a4a4a",color:"#fff",width:"12%",display:"flex",alignItems:"center",
                justifyContent:"center",textAlign:"center",fontSize:7.5,fontWeight:700,lineHeight:1.3}}>GRADE<br/>SCALE</div>
              <div style={{flex:1,display:"flex"}}>
                {GRADE_TABLE.map((r,i)=>(
                  <div key={i} style={{flex:1,background:"#dbe5f1",borderLeft:"1px solid rgba(255,255,255,.8)",
                    display:"flex",alignItems:"center",justifyContent:"center",fontWeight:700,fontSize:7.5,textAlign:"center",lineHeight:1.2}}>
                    {r.min===0?"00":r.min}â€“{r.max}<br/>{r.g}
                  </div>
                ))}
              </div>
            </div>
            {/* remark/rank/att */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 110px 140px",gap:"0 12px",
              alignItems:"flex-end",padding:"3px 2px 2px",fontSize:10,fontWeight:700,flexShrink:0}}>
              <div style={{display:"flex",alignItems:"flex-end",gap:4}}>
                <span style={{whiteSpace:"nowrap"}}>Remark :</span>
                <span style={{flex:1,borderBottom:"1.5px solid #000",paddingBottom:1,fontSize:9.5,wordBreak:"break-word"}}>{s.remark}</span>
              </div>
              <div style={{display:"flex",alignItems:"flex-end",gap:4,justifyContent:"center"}}>
                <span>Rank :</span>
                <span style={{borderBottom:"1.5px solid #000",minWidth:44,textAlign:"center",paddingBottom:1}}>{s.rank||""}</span>
              </div>
              <div style={{display:"flex",alignItems:"flex-end",gap:4,justifyContent:"flex-end"}}>
                <span style={{whiteSpace:"nowrap"}}>Attendance :</span>
                <span style={{borderBottom:"1.5px solid #000",minWidth:40,paddingBottom:1}}>{attDisp}</span>
              </div>
            </div>
            {/* signatures */}
            <div style={{display:"flex",justifyContent:"space-between",padding:"8px 18px 0",
              fontSize:10,fontWeight:700,flexShrink:0,marginTop:"auto"}}>
              {["Date","Class Teacher","Principal"].map(l=>(
                <div key={l} style={{textAlign:"center"}}>
                  <div style={{borderTop:"2px dotted #444",width:105,marginBottom:4}}></div>{l}
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

/* â”€â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function App(){
  const [screen, setScreen]         = useState("dash");
  const [students, setStudents]     = useState([]);
  const [activeId, setActiveId]     = useState(null);
  const [printSt, setPrintSt]       = useState(null);
  const [prevSt, setPrevSt]         = useState(null);
  const [toastMsg, setToastMsg]     = useState("");
  const [syncStatus, setSyncStatus] = useState("idle");
  const [syncTs, setSyncTs]         = useState("");
  const [loaded, setLoaded]         = useState(false);
  const [isDesktop, setIsDesktop]   = useState(window.innerWidth >= 900);

  // â”€â”€ Auth state â”€â”€
  const [user, setUser]             = useState(null);   // logged-in user
  const [authReady, setAuthReady]   = useState(false);  // firebase auth initialized?
  const [authLoading, setAuthLoading] = useState(false);
  const [authError, setAuthError]   = useState("");

  // â”€â”€ Responsive â”€â”€
  useEffect(()=>{
    const h = ()=>setIsDesktop(window.innerWidth >= 900);
    window.addEventListener("resize", h);
    return ()=>window.removeEventListener("resize", h);
  }, []);

  // â”€â”€ Firebase Auth listener â”€â”€
  useEffect(()=>{
    if(!auth){ setAuthReady(true); return; }
    const unsub = auth.onAuthStateChanged(firebaseUser => {
      if(firebaseUser){
        if(ALLOWED_EMAILS.includes(firebaseUser.email)){
          setUser(firebaseUser);
          setAuthError("");
        } else {
          // Not in whitelist â€” sign out immediately
          auth.signOut();
          setUser(null);
          setAuthError(`"${firebaseUser.email}" ko access nahi hai. Admin se contact karein.`);
        }
      } else {
        setUser(null);
      }
      setAuthReady(true);
    });
    return ()=>unsub();
  }, []);

  // â”€â”€ Google Login â”€â”€
  const handleLogin = async () => {
    if(!auth){ setAuthError("Auth available nahi hai."); return; }
    setAuthLoading(true);
    setAuthError("");
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      await auth.signInWithPopup(provider);
    } catch(e) {
      if(e.code !== "auth/popup-closed-by-user"){
        setAuthError("Login fail hua. Dobara try karein.");
      }
    } finally {
      setAuthLoading(false);
    }
  };

  const handleLogout = async () => {
    if(window.confirm("Logout karna chahte hain?")) {
      await auth.signOut();
      setStudents([]);
      setLoaded(false);
      setScreen("dash");
    }
  };

  const showToast = useCallback(msg => {
    setToastMsg(msg);
    setTimeout(()=>setToastMsg(""), 2800);
  }, []);

  // â”€â”€ Load data after login â”€â”€
  useEffect(()=>{
    if(!user) return;  // sirf login ke baad load karo
    setSyncStatus("syncing");
    fbAll().then(data=>{
      setStudents(data.length>0 ? data : lsLoad());
      setSyncStatus("synced");
      setSyncTs(new Date().toLocaleTimeString("en-IN"));
      setLoaded(true);
    }).catch(()=>{
      setStudents(lsLoad());
      setSyncStatus("offline");
      setLoaded(true);
      showToast("ğŸ“´ Offline â€” device storage se load kiya");
    });
  }, [user]);

  useEffect(()=>{ if(loaded) lsSave(students); }, [students, loaded]);

  const handleSave = useCallback(async (updated) => {
    setStudents(prev => prev.map(s=>s.id===updated.id ? updated : s));
    lsSave(students.map(s=>s.id===updated.id?updated:s));
    setPrevSt(updated);
    setSyncStatus("syncing");
    try {
      await fbSave(updated);
      setSyncStatus("synced");
      setSyncTs(new Date().toLocaleTimeString("en-IN"));
    } catch {
      setSyncStatus("error");
      showToast("âš ï¸ Device pe save hua â€” Firebase sync fail");
    }
  }, [students]);

  const handleNew = async () => {
    const st = newStudent();
    setStudents(p=>[...p, st]);
    setActiveId(st.id);
    setPrevSt(st);
    setScreen("editor");
    try { await fbSave(st); } catch {}
  };

  const handleSelect = id => {
    setActiveId(id);
    const st = students.find(s=>s.id===id);
    setPrevSt(st);
    setScreen("editor");
  };

  const handleDelete = async () => {
    if(!window.confirm("Is student ko Firebase se permanently delete karein?")) return;
    const next = students.filter(s=>s.id!==activeId);
    setStudents(next);
    lsSave(next);
    setPrevSt(null);
    try { await fbDel(activeId); } catch {}
    setScreen("dash");
    showToast("ğŸ—‘ï¸ Student delete ho gaya");
  };

  // â”€â”€ Render: auth not ready yet â”€â”€
  if(!authReady){
    return (
      <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",
        flexDirection:"column",gap:16,background:"linear-gradient(150deg,#0d1460,#1a237e,#1565c0)"}}>
        <div style={{fontSize:52}}>ğŸ«</div>
        <div style={{fontWeight:900,color:"#fff",fontSize:18,fontFamily:"'Playfair Display',serif"}}>
          {SCHOOL.name}
        </div>
        <div style={{color:"rgba(255,255,255,.6)",fontSize:13,display:"flex",alignItems:"center",gap:9}}>
          <span style={{width:9,height:9,borderRadius:"50%",background:"#fb8c00",
            display:"inline-block",animation:"pulse 1.1s infinite"}}/>
          Loadingâ€¦
        </div>
      </div>
    );
  }

  // â”€â”€ Render: not logged in â”€â”€
  if(!user){
    return <LoginScreen onLogin={handleLogin} error={authError} loading={authLoading}/>;
  }

  // â”€â”€ Render: logged in but data loading â”€â”€
  const activeStudent = students.find(s=>s.id===activeId);

  if(!loaded){
    return (
      <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",
        flexDirection:"column",gap:16,background:"#e8eaf0"}}>
        <div style={{fontSize:52}}>ğŸ«</div>
        <div style={{fontWeight:900,color:"#1a237e",fontSize:18,fontFamily:"'Playfair Display',serif"}}>
          {SCHOOL.name}
        </div>
        <div style={{color:"#888",fontSize:13,display:"flex",alignItems:"center",gap:9}}>
          <span style={{width:9,height:9,borderRadius:"50%",background:"#fb8c00",
            display:"inline-block",animation:"pulse 1.1s infinite"}}/>
          Firebase se data load ho raha haiâ€¦
        </div>
      </div>
    );
  }

  // â”€â”€ Render: main app â”€â”€
  return (
    <div className={isDesktop ? "shell" : ""}>
      {/* Left / Mobile pane */}
      <div className={isDesktop ? "left-pane" : ""}>
        {screen==="dash" && (
          <Dashboard students={students} onNew={handleNew} onSelect={handleSelect}
            syncStatus={syncStatus} syncTs={syncTs}
            user={user} onLogout={handleLogout}/>
        )}
        {screen==="editor" && activeStudent && (
          <Editor student={activeStudent} onSave={handleSave}
            onBack={()=>{setScreen("dash"); setPrevSt(null);}}
            onPrint={st=>{setPrintSt(st); setScreen("print");}}
            onDelete={handleDelete} showToast={showToast}/>
        )}
        {screen==="print" && printSt && (
          <PrintView student={printSt} onClose={()=>setScreen("editor")}/>
        )}
      </div>

      {/* Desktop live preview */}
      {isDesktop && screen !== "print" && (
        <div className="right-pane">
          <div style={{color:"#bbb",fontSize:10,letterSpacing:2,marginBottom:14,fontWeight:700}}>
            â—€ LIVE MARKSHEET PREVIEW â–¶
          </div>
          <LivePreview student={prevSt || activeStudent}/>
        </div>
      )}

      <Toast msg={toastMsg}/>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>

<!-- Service Worker for offline -->
<script>
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('sw.js')
      .then(r=>console.log('SW registered:', r.scope))
      .catch(e=>console.warn('SW error:', e));
  });
}
</script>
</body>
</html>
