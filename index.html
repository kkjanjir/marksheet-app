<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>SBS Shiksha Niketan ‚Äî Marksheet System</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:'Inter',sans-serif;-webkit-tap-highlight-color:transparent;}
:root{
  --bg:#080810;--bg2:#0e0e1c;
  --glass:rgba(255,255,255,0.055);--glass2:rgba(255,255,255,0.09);
  --gb:rgba(255,255,255,0.09);--gb2:rgba(255,255,255,0.16);
  --text:#eeeeff;--t2:rgba(255,255,255,0.52);--t3:rgba(255,255,255,0.25);
  --accent:#6c8aff;--a2:#3f51b5;
  --ib:rgba(255,255,255,0.08);--ibr:rgba(255,255,255,0.11);--ic:#eeeeff;
  --hdr:linear-gradient(145deg,#0b0b28 0%,#151050 50%,#0c1850 100%);
  --btn2:rgba(255,255,255,0.08);
  --sug:rgba(12,12,30,0.98);--sh:rgba(108,138,255,0.14);--st:rgba(255,255,255,0.82);
  --tb:rgba(5,5,18,0.95);--mb:rgba(10,10,28,0.97);--mt:#e0e0ff;
  --sync:rgba(0,0,0,0.32);
}
body.light{
  --bg:#f0f2fb;--bg2:#e6eaf7;
  --glass:rgba(255,255,255,0.62);--glass2:rgba(255,255,255,0.82);
  --gb:rgba(26,35,126,0.10);--gb2:rgba(26,35,126,0.20);
  --text:#10103a;--t2:#4a4a7a;--t3:#9090bb;
  --accent:#3f51b5;--a2:#1a237e;
  --ib:rgba(255,255,255,0.82);--ibr:rgba(26,35,126,0.18);--ic:#10103a;
  --hdr:linear-gradient(145deg,#1a237e,#283593,#1565c0);
  --btn2:rgba(26,35,126,0.08);
  --sug:rgba(246,248,255,0.99);--sh:rgba(63,81,181,0.07);--st:#10103a;
  --tb:rgba(10,10,40,0.94);--mb:rgba(246,248,255,0.98);--mt:#10103a;
  --sync:rgba(0,0,0,0.05);
}
body{background:var(--bg);color:var(--text);}

/* iOS Glass */
.gc{background:var(--glass);backdrop-filter:blur(22px) saturate(180%);-webkit-backdrop-filter:blur(22px) saturate(180%);border:1px solid var(--gb);border-radius:20px;box-shadow:0 8px 32px rgba(0,0,0,0.18),inset 0 1px 0 rgba(255,255,255,0.07);}
.gc2{background:var(--glass2);backdrop-filter:blur(30px) saturate(200%);-webkit-backdrop-filter:blur(30px) saturate(200%);border:1px solid var(--gb2);border-radius:20px;box-shadow:0 14px 44px rgba(0,0,0,0.24),inset 0 1px 0 rgba(255,255,255,0.11);}

/* Inputs */
.inp{width:100%;padding:12px 15px;border:1.5px solid var(--ibr);border-radius:12px;font-size:13px;font-family:'Inter',sans-serif;outline:none;background:var(--ib);color:var(--ic);transition:border-color .2s,box-shadow .2s,transform .15s;}
.inp:focus{border-color:var(--accent);box-shadow:0 0 0 3.5px rgba(108,138,255,0.17);transform:translateY(-1px);}
.inp::placeholder{color:var(--t3);}
select.inp option{background:#1a1a3e;color:#fff;}
body.light select.inp option{background:#fff;color:#10103a;}
.mi{width:100%;padding:5px 2px;border:1px solid var(--ibr);border-radius:7px;font-size:11px;text-align:center;outline:none;font-family:'Inter',sans-serif;background:var(--ib);color:var(--ic);transition:border-color .15s,box-shadow .15s;}
.mi:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(108,138,255,0.16);}

/* Buttons */
.btn{border:none;border-radius:12px;padding:10px 18px;font-weight:700;cursor:pointer;font-family:'Inter',sans-serif;font-size:13px;transition:all .2s cubic-bezier(.34,1.56,.64,1);position:relative;overflow:hidden;}
.btn:active{transform:scale(0.95)!important;}
.btn::after{content:"";position:absolute;inset:0;background:radial-gradient(circle at center,rgba(255,255,255,0.22),transparent 72%);opacity:0;transition:opacity .18s;}
.btn:hover::after{opacity:1;}
.bp{background:linear-gradient(135deg,#5c6bc0,#1565c0);color:#fff;box-shadow:0 4px 20px rgba(63,81,181,0.4);}
.bp:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(63,81,181,0.5);}
.bd{background:linear-gradient(135deg,#c62828,#e53935);color:#fff;box-shadow:0 4px 16px rgba(198,40,40,0.35);}
.bd:hover{transform:translateY(-2px);}
.bg2{background:var(--btn2);color:var(--t2);border:1px solid var(--gb);}
.bg2:hover{background:var(--glass2);color:var(--text);}

/* Suggestion */
.sug{position:absolute;left:0;right:0;top:calc(100% + 6px);background:var(--sug);backdrop-filter:blur(28px);-webkit-backdrop-filter:blur(28px);border:1px solid var(--gb2);border-radius:14px;z-index:500;box-shadow:0 16px 48px rgba(0,0,0,0.28);max-height:180px;overflow-y:auto;animation:fd .15s ease;}
.si{padding:11px 14px;cursor:pointer;font-size:13px;color:var(--st);border-bottom:1px solid var(--gb);transition:background .1s;}
.si:hover,.si:active{background:var(--sh);}
.si:last-child{border-bottom:none;}

/* Toast */
.toast{position:fixed;bottom:82px;left:50%;background:var(--tb);color:#fff;padding:11px 26px;border-radius:40px;font-size:13px;z-index:9999;box-shadow:0 8px 32px rgba(0,0,0,0.45);white-space:nowrap;border:1px solid rgba(255,255,255,0.1);backdrop-filter:blur(20px);animation:tin .22s cubic-bezier(.34,1.56,.64,1);}

/* Menu */
.mp{position:absolute;right:0;top:calc(100% + 8px);background:var(--mb);backdrop-filter:blur(28px);-webkit-backdrop-filter:blur(28px);border:1px solid var(--gb2);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,0.3);min-width:210px;overflow:hidden;animation:pi .18s cubic-bezier(.34,1.56,.64,1);z-index:201;}
.mi2{padding:13px 16px;cursor:pointer;font-size:13px;font-weight:600;color:var(--mt);display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--gb);transition:background .12s;}
.mi2:last-child{border-bottom:none;}
.mi2:hover{background:var(--sh);}

/* Animations */
@keyframes fu{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
@keyframes fd{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}
@keyframes fi{from{opacity:0}to{opacity:1}}
@keyframes pu{0%,100%{opacity:1}50%{opacity:.35}}
@keyframes su{from{opacity:0;transform:translateY(36px)}to{opacity:1;transform:translateY(0)}}
@keyframes pi{from{opacity:0;transform:scale(0.85) translateY(-10px)}to{opacity:1;transform:scale(1) translateY(0)}}
@keyframes sx{0%,100%{transform:translateX(0)}20%{transform:translateX(-10px)}40%{transform:translateX(10px)}60%{transform:translateX(-7px)}80%{transform:translateX(7px)}}
@keyframes tin{from{opacity:0;transform:translateX(-50%) translateY(12px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
@keyframes si2{from{opacity:0;transform:scale(0.92)}to{opacity:1;transform:scale(1)}}
.fi{animation:fu .3s cubic-bezier(.4,0,.2,1) both;}
.pu{animation:pu 1.2s infinite;}

/* Scrollbar */
::-webkit-scrollbar{width:4px;}
::-webkit-scrollbar-thumb{background:var(--gb2);border-radius:6px;}

/* Desktop */
@media(min-width:900px){
  .shell{display:flex;height:100vh;overflow:hidden;}
  .lp{width:500px;flex-shrink:0;overflow-y:auto;height:100vh;border-right:1px solid var(--gb);}
  .rp{flex:1;overflow-y:auto;height:100vh;background:var(--bg2);display:flex;flex-direction:column;align-items:center;padding:28px 20px;}
}
@media(max-width:899px){.shell,.lp{display:block;width:100%;min-height:100vh;}.rp{display:none!important;}}

/* Print */
@media print{
  *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;}
  html,body{margin:0!important;padding:0!important;width:210mm!important;height:297mm!important;background:white!important;}
  body *{visibility:hidden!important;}
  #MS,#MS *{visibility:visible!important;}
  #MS{position:fixed!important;inset:0!important;width:210mm!important;height:297mm!important;margin:0!important;padding:0!important;overflow:hidden!important;background:white!important;box-shadow:none!important;}
  @page{size:210mm 297mm;margin:0mm;}
  .np{display:none!important;}
}
.sl{font-size:11px;font-weight:700;color:var(--t2);margin-bottom:6px;letter-spacing:0.3px;}
.pill{display:inline-flex;align-items:center;padding:3px 11px;border-radius:20px;font-size:11px;font-weight:700;}
</style>
</head>
<body><div id="root"></div>
<script>
try{
  firebase.initializeApp({apiKey:"AIzaSyDw6lVRfXgehqpgvTCobqZZyLAy9alzAU8",authDomain:"sbs-marksheet.firebaseapp.com",projectId:"sbs-marksheet",storageBucket:"sbs-marksheet.firebasestorage.app",messagingSenderId:"1064566048496",appId:"1:1064566048496:web:0b7cf5d4b9fa0bf9dae435"});
  const db=firebase.firestore();db.settings({cacheSizeBytes:firebase.firestore.CACHE_SIZE_UNLIMITED});db.enablePersistence({synchronizeTabs:true}).catch(()=>{});window._db=db;
}catch(e){window._db=null;}
</script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel" data-presets="react">
const{useState,useEffect,useRef,useCallback,useMemo}=React;
const AK="sbs_auth_v1",LK="sbs_mk_v11",TK="sbs_theme_v1";
const isOk=()=>{try{const d=JSON.parse(localStorage.getItem(AK)||"{}");return d.ok&&(Date.now()-d.t)<8*3600*1000;}catch{return false;}};
const saveSes=()=>localStorage.setItem(AK,JSON.stringify({ok:true,t:Date.now()}));
const clrSes=()=>localStorage.removeItem(AK);

const SCH={name:"SBS SHIKSHA NIKETAN",addr:"Karaspur Prithvipur, Ghazipur, Uttar Pradesh ‚Äì 233226",logo:"logo.png"};
// Fixed MM per term as per image: T1=40, T2=60, T3=100 ‚Üí total per subject=200
const T1=40,T2=60,T3=100,SMM=200;
const SUBS=["HINDI","ENGLISH","MATHEMATICS","SCIENCE","SOCIAL SCIENCE","ART AND DRAWING","COMPUTER","G.K."];
const CLS=["1","2","3","4","5","6","7","8","9","10","11","12"];
const GEN=["Male","Female","Other"];
const GT=[
  {min:91,max:100,g:"A1",l:"Outstanding"},
  {min:81,max:90,g:"A2",l:"Excellent"},
  {min:71,max:80,g:"B1",l:"Very Good"},
  {min:61,max:70,g:"B2",l:"Good"},
  {min:51,max:60,g:"C1",l:"Average"},
  {min:41,max:50,g:"C2",l:"Satisfactory"},
  {min:33,max:40,g:"D",l:"Pass"},
  {min:0,max:32,g:"E",l:"Fail"},
];
const gr=p=>{if(p===null||p===undefined||p==="")return"‚Äì";for(const r of GT)if(p>=r.min&&p<=r.max)return r.g;return"‚Äì";};
const gl=p=>{if(p===null||p===undefined||p==="")return"‚Äì";for(const r of GT)if(p>=r.min&&p<=r.max)return r.l;return"‚Äì";};
const REM=["Excellent performance! Keep up the great work.","Good effort shown. Focus more on weaker subjects.","Satisfactory progress. Must work harder next term.","Very good student. Regular attendance is essential.","Outstanding achievement. We are proud of you!"];
const ADDR=["Nasiruddinpur, Prithvipur, Ghazipur, U.P. 233226","Prithvipur, Ghazipur, Uttar Pradesh 233226","Karaspur, Prithvipur, Ghazipur, U.P. 233226"];
const obt=s=>(parseFloat(s.o1)||0)+(parseFloat(s.o2)||0)+(parseFloat(s.o3)||0);
const pct=(o,m)=>m>0?parseFloat(((o/m)*100).toFixed(1)):null;
function gTot(subs){return subs.reduce((a,s)=>({o1:a.o1+(parseFloat(s.o1)||0),o2:a.o2+(parseFloat(s.o2)||0),o3:a.o3+(parseFloat(s.o3)||0),oT:a.oT+obt(s),mT:a.mT+SMM,m1:a.m1+T1,m2:a.m2+T2,m3:a.m3+T3}),{o1:0,o2:0,o3:0,oT:0,mT:0,m1:0,m2:0,m3:0});}
const db=window._db;
const fbS=async st=>{if(!db)throw new Error();await db.collection("students").doc(String(st.id)).set(st);const b=db.collection("backups").doc(String(st.id));const sn=await b.get();let v=sn.exists?(sn.data().v||[]):[];v=[{...st,_at:new Date().toISOString()},...v].slice(0,2);await b.set({v});};
const fbA=async()=>{if(!db)throw new Error();return(await db.collection("students").get()).docs.map(d=>d.data());};
const fbD=async id=>{if(!db)throw new Error();return db.collection("students").doc(String(id)).delete();};
const fbB=async id=>{if(!db)return[];const d=await db.collection("backups").doc(String(id)).get();return d.exists?(d.data().v||[]):[];};
const lsS=d=>{try{localStorage.setItem(LK,JSON.stringify(d));}catch{}};
const lsL=()=>{try{const r=localStorage.getItem(LK);return r?JSON.parse(r):[];}catch{return[];}};
const newSt=(cls="",gender="")=>({id:`${Date.now()}_${Math.random().toString(36).slice(2,8)}`,name:"",father:"",mother:"",addr:"",gender,roll:"",admno:"",dob:"",cls,sec:"",session:"2025-26",photo:null,att:{p:"",t:""},remark:"",rank:"",printDate:"",subs:SUBS.map(n=>({n,o1:"",o2:"",o3:""})),cosco:{sports:"",art:"",music:"",disc:"",clean:""},_created:new Date().toISOString(),_updated:new Date().toISOString()});

const I={
  back:<svg viewBox="0 0 24 24" width="17" height="17" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
  plus:<svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  print:<svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
  trash:<svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6M9 6V4h6v2"/></svg>,
  search:<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
  up:<svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>,
  hist:<svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-4.95"/></svg>,
  dots:<svg viewBox="0 0 24 24" width="19" height="19" fill="currentColor"><circle cx="12" cy="5" r="1.7"/><circle cx="12" cy="12" r="1.7"/><circle cx="12" cy="19" r="1.7"/></svg>,
  moon:<svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>,
  sun:<svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>,
  res:<svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>,
  out:<svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
  ok:<svg viewBox="0 0 24 24" width="13" height="13" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
};

function useTheme(){
  const[dark,set]=useState(()=>{const s=localStorage.getItem(TK);return s===null?true:s==="dark";});
  useEffect(()=>{document.body.classList.toggle("light",!dark);localStorage.setItem(TK,dark?"dark":"light");},[dark]);
  return[dark,()=>set(d=>!d)];
}

function Toast({msg}){return msg?<div className="toast">{msg}</div>:null;}

/* LOGIN */
function Login({onLogin,err,dark,tog}){
  const[pw,set]=useState("");const[show,setShow]=useState(false);const[shk,setShk]=useState(false);
  const ref=useRef();
  useEffect(()=>{setTimeout(()=>ref.current&&ref.current.focus(),450);},[]);
  const go=()=>{if(!pw.trim())return;if(!onLogin(pw)){setShk(true);setTimeout(()=>setShk(false),520);set("");}};
  return(
    <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",padding:20,position:"relative",overflow:"hidden",
      background:dark?"radial-gradient(ellipse at 55% 25%,#18106e 0%,#080810 65%)":"radial-gradient(ellipse at 55% 25%,#c8d0ff 0%,#f0f2fb 65%)"}}>
      {dark&&<>
        <div style={{position:"fixed",width:380,height:380,borderRadius:"50%",background:"radial-gradient(circle,rgba(60,80,200,0.15),transparent)",top:-90,right:-90,pointerEvents:"none"}}/>
        <div style={{position:"fixed",width:260,height:260,borderRadius:"50%",background:"radial-gradient(circle,rgba(100,50,200,0.10),transparent)",bottom:-50,left:-70,pointerEvents:"none"}}/>
      </>}
      <button onClick={tog} style={{position:"fixed",top:18,right:18,background:dark?"rgba(255,255,255,0.10)":"rgba(0,0,0,0.07)",border:"1px solid "+(dark?"rgba(255,255,255,0.14)":"rgba(0,0,0,0.11)"),color:dark?"#fff":"#333",borderRadius:12,width:40,height:40,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",backdropFilter:"blur(10px)",transition:"all .2s"}}>{dark?I.sun:I.moon}</button>
      <div className="gc2" style={{maxWidth:380,width:"100%",textAlign:"center",padding:"44px 32px",animation:shk?"sx 0.42s ease":"su 0.4s cubic-bezier(.4,0,.2,1)"}}>
        <div style={{width:76,height:76,borderRadius:22,margin:"0 auto 20px",background:"linear-gradient(135deg,#5c6bc0,#1a237e)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:38,boxShadow:"0 12px 36px rgba(63,81,181,0.45),inset 0 1px 0 rgba(255,255,255,0.18)"}}><span style={{fontSize:38}}>üè´</span></div>
        <div style={{fontSize:21,fontWeight:900,color:dark?"#fff":"#1a237e",marginBottom:3,letterSpacing:-0.3}}>SBS Shiksha Niketan</div>
        <div style={{fontSize:12,color:"var(--t2)",marginBottom:28,letterSpacing:0.3}}>Marksheet Management System</div>
        {err&&<div style={{background:"rgba(198,40,40,0.12)",border:"1px solid rgba(198,40,40,0.28)",color:"#ef5350",padding:"10px 14px",borderRadius:11,fontSize:13,marginBottom:16,animation:"si2 .2s ease"}}>‚ùå {err}</div>}
        <div style={{position:"relative",marginBottom:12}}>
          <input ref={ref} type={show?"text":"password"} value={pw} onChange={e=>set(e.target.value)} onKeyDown={e=>e.key==="Enter"&&go()} placeholder="Password daalen‚Ä¶" className="inp" style={{padding:"14px 48px 14px 17px",fontSize:15,letterSpacing:show?0:4}}/>
          <button onClick={()=>setShow(s=>!s)} style={{position:"absolute",right:13,top:"50%",transform:"translateY(-50%)",background:"none",border:"none",cursor:"pointer",fontSize:18,color:"var(--t3)"}}>{show?"üôà":"üëÅÔ∏è"}</button>
        </div>
        <button onClick={go} className="btn bp" style={{width:"100%",padding:"15px",fontSize:14,borderRadius:13}}>üîì Login Karein</button>
        <div style={{marginTop:18,fontSize:11,color:"var(--t3)"}}>üîí Authorized access only</div>
      </div>
    </div>
  );
}

/* CLASS ‚Üí GENDER SELECTOR */
function ClsSel({onSelect,dark}){
  const[cls,setCls]=useState("");const[gen,setGen]=useState("");const ok=cls&&gen;
  const cols={"Male":"#7c4dff","Female":"#e91e8c","Other":"#00bcd4"};
  const emoj={"Male":"üë¶","Female":"üëß","Other":"üßë"};
  return(
    <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",padding:20,
      background:dark?"radial-gradient(ellipse at 50% 28%,#18106e,#080810)":"radial-gradient(ellipse at 50% 28%,#c8d0ff,#f0f2fb)"}}>
      <div className="gc2" style={{maxWidth:430,width:"100%",padding:"38px 26px",animation:"su .35s cubic-bezier(.4,0,.2,1)"}}>
        <div style={{textAlign:"center",marginBottom:26}}>
          <div style={{fontSize:40,marginBottom:10}}>üéì</div>
          <div style={{fontSize:19,fontWeight:900,color:dark?"#fff":"#1a237e",marginBottom:4}}>Naya Student Banayein</div>
          <div style={{fontSize:12.5,color:"var(--t2)"}}>Pehle class chunein, phir gender</div>
        </div>
        <div style={{marginBottom:18}}>
          <div className="sl" style={{letterSpacing:1}}>üìö CLASS CHUNEIN</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:8}}>
            {CLS.map(c=>(
              <button key={c} onClick={()=>setCls(c)} style={{padding:"11px 4px",borderRadius:12,border:"1.5px solid "+(cls===c?"#5c6bc0":"var(--gb)"),fontWeight:800,fontSize:15,cursor:"pointer",background:cls===c?"linear-gradient(135deg,#5c6bc0,#1565c0)":"var(--ib)",color:cls===c?"#fff":"var(--t2)",boxShadow:cls===c?"0 4px 18px rgba(92,107,192,0.5)":"none",transform:cls===c?"scale(1.07)":"scale(1)",transition:"all .18s cubic-bezier(.34,1.56,.64,1)"}}>{c}</button>
            ))}
          </div>
        </div>
        {cls&&(
          <div style={{marginBottom:26,animation:"fu .25s ease"}}>
            <div className="sl" style={{letterSpacing:1}}>üë§ GENDER CHUNEIN</div>
            <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:9}}>
              {GEN.map(g=>(
                <button key={g} onClick={()=>setGen(g)} style={{padding:"13px 6px",borderRadius:13,border:"1.5px solid "+(gen===g?cols[g]:"var(--gb)"),fontWeight:700,fontSize:12.5,cursor:"pointer",background:gen===g?cols[g]:"var(--ib)",color:gen===g?"#fff":"var(--t2)",boxShadow:gen===g?`0 4px 16px ${cols[g]}55`:"none",transform:gen===g?"scale(1.06)":"scale(1)",transition:"all .18s cubic-bezier(.34,1.56,.64,1)"}}>{emoj[g]} {g}</button>
              ))}
            </div>
          </div>
        )}
        <button onClick={()=>ok&&onSelect(cls,gen)} className="btn" style={{width:"100%",padding:"15px",fontSize:14,fontWeight:800,borderRadius:13,background:ok?"linear-gradient(135deg,#5c6bc0,#1565c0)":"var(--btn2)",color:ok?"#fff":"var(--t3)",boxShadow:ok?"0 6px 24px rgba(92,107,192,0.45)":"none",cursor:ok?"pointer":"not-allowed",transition:"all .22s"}}>
          {ok?`‚úÖ Class ${cls} ¬∑ ${gen} ‚Äî Aage Badho`:"Class chunein pehle"}
        </button>
      </div>
    </div>
  );
}

/* SYNC BAR */
function Sync({status,ts}){
  const c={synced:{col:"#4caf50",t:"Synced ‚úì"},syncing:{col:"#ff9800",t:"Saving‚Ä¶"},error:{col:"#f44336",t:"Sync error"},offline:{col:"#9e9e9e",t:"Offline"},idle:{col:"",t:""}};
  const{col,t}=(c[status]||c.idle);if(!t)return null;
  return(<div style={{background:"var(--sync)",borderBottom:"1px solid var(--gb)",padding:"5px 16px",display:"flex",alignItems:"center",gap:8,fontSize:11,color:"var(--t2)"}}>
    <span style={{width:7,height:7,borderRadius:"50%",background:col,display:"inline-block",animation:status==="syncing"?"pu 1s infinite":""}}/><span style={{fontWeight:500}}>{t}</span>
    {ts&&status==="synced"&&<span style={{marginLeft:"auto",opacity:0.4,fontSize:10}}>{ts}</span>}
  </div>);
}

/* RESULTS VIEWER */
function RView({students,onClose,onSel}){
  const[q,sq]=useState("");const[fc,sfc]=useState("");const[fg,sfg]=useState("");
  const f=useMemo(()=>students.filter(s=>{
    const mq=!q||(s.name||"").toLowerCase().includes(q.toLowerCase())||(s.roll||"").includes(q);
    return mq&&(!fc||s.cls===fc)&&(!fg||s.gender===fg);
  }),[students,q,fc,fg]);
  return(
    <div className="fi" style={{paddingBottom:20}}>
      <div style={{backdropFilter:"blur(20px)",WebkitBackdropFilter:"blur(20px)",borderBottom:"1px solid var(--gb)",padding:"13px 15px",display:"flex",alignItems:"center",gap:10,position:"sticky",top:0,zIndex:60,background:"var(--glass)"}}>
        <button onClick={onClose} className="btn bg2" style={{padding:"8px 11px",display:"flex",alignItems:"center"}}>{I.back}</button>
        <span style={{color:"var(--text)",fontWeight:700,fontSize:15,flex:1}}>üìä Saved Results</span>
      </div>
      <div style={{padding:"12px 14px",display:"flex",gap:8,flexWrap:"wrap"}}>
        <div style={{flex:1,minWidth:130,position:"relative"}}>
          <span style={{position:"absolute",left:12,top:"50%",transform:"translateY(-50%)",color:"var(--t3)"}}>{I.search}</span>
          <input value={q} onChange={e=>sq(e.target.value)} placeholder="Naam ya roll‚Ä¶" className="inp" style={{paddingLeft:36,padding:"10px 12px 10px 36px"}}/>
        </div>
        <select value={fc} onChange={e=>sfc(e.target.value)} className="inp" style={{width:"auto"}}>
          <option value="">All Class</option>{CLS.map(c=><option key={c} value={c}>Class {c}</option>)}
        </select>
        <select value={fg} onChange={e=>sfg(e.target.value)} className="inp" style={{width:"auto"}}>
          <option value="">All Gender</option>{GEN.map(g=><option key={g} value={g}>{g}</option>)}
        </select>
      </div>
      <div style={{padding:"0 14px",display:"flex",flexDirection:"column",gap:8}}>
        {f.length===0?<div style={{textAlign:"center",padding:"50px 20px",color:"var(--t3)"}}><div style={{fontSize:40,marginBottom:10}}>üì≠</div><div>Koi result nahi mila</div></div>
        :f.map(s=>{
          const g=gTot(s.subs);const p=g.mT>0?pct(g.oT,g.mT):null;const pass=p!==null&&p>=33;
          return(<div key={s.id} onClick={()=>onSel(s.id)} className="gc" style={{padding:"12px 14px",display:"flex",alignItems:"center",gap:12,cursor:"pointer",transition:"all .2s cubic-bezier(.4,0,.2,1)"}}
            onMouseEnter={e=>{e.currentTarget.style.transform="translateY(-2px)";e.currentTarget.style.boxShadow="0 8px 24px rgba(0,0,0,0.22)";}}
            onMouseLeave={e=>{e.currentTarget.style.transform="";e.currentTarget.style.boxShadow="";}}>
            <div style={{width:44,height:44,borderRadius:12,overflow:"hidden",background:"linear-gradient(135deg,#5c6bc0,#1a237e)",flexShrink:0,display:"flex",alignItems:"center",justifyContent:"center"}}>
              {s.photo?<img src={s.photo} style={{width:"100%",height:"100%",objectFit:"cover"}} alt=""/>:<span style={{fontSize:20}}>üë§</span>}
            </div>
            <div style={{flex:1,minWidth:0}}><div style={{fontWeight:700,color:"var(--text)",fontSize:14,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{s.name||"‚Äî"}</div><div style={{fontSize:11,color:"var(--t2)",marginTop:2}}>Class {s.cls||"?"}{s.sec?"-"+s.sec:""} {s.gender?"¬∑ "+s.gender:""} {s.roll?"¬∑ Roll "+s.roll:""}</div></div>
            {p!==null&&<div style={{textAlign:"right",flexShrink:0}}><div style={{fontWeight:800,fontSize:15,color:pass?"#4caf50":"#f44336"}}>{p}%</div><div className="pill" style={{background:pass?"rgba(76,175,80,0.15)":"rgba(244,67,54,0.15)",color:pass?"#4caf50":"#f44336"}}>{gr(p)}</div></div>}
          </div>);
        })}
      </div>
    </div>
  );
}

/* DASHBOARD */
function Dash({students,onNew,onSel,ss,ts,onOut,onRes,dark,tog}){
  const[q,sq]=useState("");const[menu,sm]=useState(false);const mr=useRef();
  const f=useMemo(()=>students.filter(s=>(s.name||"").toLowerCase().includes(q.toLowerCase())||(s.roll||"").includes(q)||(s.cls||"").includes(q)),[students,q]);
  const pc=useMemo(()=>students.filter(s=>{const g=gTot(s.subs);return g.mT>0&&pct(g.oT,g.mT)>=33;}).length,[students]);
  const cs=useMemo(()=>new Set(students.map(s=>s.cls).filter(Boolean)),[students]);
  useEffect(()=>{const h=e=>{if(mr.current&&!mr.current.contains(e.target))sm(false);};if(menu)document.addEventListener("mousedown",h);return()=>document.removeEventListener("mousedown",h);},[menu]);
  return(
    <div className="fi" style={{minHeight:"100vh",background:"var(--bg)"}}>
      <Sync status={ss} ts={ts}/>
      <div style={{padding:"14px 14px 90px"}}>
        {/* Header */}
        <div style={{marginBottom:14,borderRadius:24,overflow:"hidden",position:"relative",background:"var(--hdr)",padding:"22px 18px 20px",boxShadow:"0 12px 40px rgba(0,0,30,0.45)"}}>
          <div style={{position:"absolute",width:180,height:180,borderRadius:"50%",background:"rgba(255,255,255,0.04)",top:-60,right:-50,pointerEvents:"none"}}/>
          <div style={{position:"absolute",right:13,top:13,zIndex:10}} ref={mr}>
            <button onClick={()=>sm(m=>!m)} style={{background:"rgba(255,255,255,0.13)",border:"1px solid rgba(255,255,255,0.18)",color:"#fff",borderRadius:11,width:37,height:37,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:"all .15s"}}
              onMouseEnter={e=>e.currentTarget.style.background="rgba(255,255,255,0.22)"}
              onMouseLeave={e=>e.currentTarget.style.background="rgba(255,255,255,0.13)"}>{I.dots}</button>
            {menu&&<div className="mp">
              <div className="mi2" onClick={()=>{onRes();sm(false);}}>{I.res}<span>Saved Results Dekhein</span></div>
              <div className="mi2" onClick={()=>{tog();sm(false);}}>{dark?I.sun:I.moon}<span>{dark?"Light Mode":"Dark Mode"}</span></div>
              <div className="mi2" onClick={()=>{onOut();sm(false);}} style={{color:"#ef5350"}}>{I.out}<span>Logout</span></div>
            </div>}
          </div>
          <div style={{fontSize:9,letterSpacing:3,color:"rgba(255,255,255,0.4)",fontWeight:700,marginBottom:2,textTransform:"uppercase"}}>School Management System</div>
          <div style={{fontSize:20,fontWeight:900,color:"#fff",letterSpacing:-0.3,marginBottom:1}}>{SCH.name}</div>
          <div style={{fontSize:9.5,color:"rgba(255,255,255,0.4)",marginBottom:14}}>{SCH.addr}</div>
          <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
            {[{v:students.length,l:"Students",c:"#fff"},{v:pc,l:"Passed",c:"#a5d6a7"},{v:cs.size,l:"Classes",c:"#ffcc80"},{v:students.length-pc,l:"Need Marks",c:"#ef9a9a"}].map(({v,l,c})=>(
              <div key={l} style={{background:"rgba(255,255,255,0.1)",backdropFilter:"blur(10px)",border:"1px solid rgba(255,255,255,0.15)",borderRadius:13,padding:"8px 14px",textAlign:"center",minWidth:60}}>
                <div style={{fontSize:22,fontWeight:900,color:c,lineHeight:1}}>{v}</div>
                <div style={{fontSize:9.5,color:"rgba(255,255,255,0.5)",marginTop:2}}>{l}</div>
              </div>
            ))}
          </div>
        </div>
        {/* Search + New */}
        <div style={{display:"flex",gap:8,marginBottom:12}}>
          <div style={{flex:1,position:"relative"}}>
            <span style={{position:"absolute",left:13,top:"50%",transform:"translateY(-50%)",color:"var(--t3)"}}>{I.search}</span>
            <input value={q} onChange={e=>sq(e.target.value)} placeholder="Naam, class ya roll‚Ä¶" className="inp" style={{paddingLeft:38}}/>
          </div>
          <button onClick={onNew} className="btn bp" style={{display:"flex",alignItems:"center",gap:7,whiteSpace:"nowrap",padding:"11px 18px"}}>{I.plus} Naya</button>
        </div>
        {/* List */}
        {f.length===0?<div style={{textAlign:"center",padding:"50px 20px",color:"var(--t3)"}}><div style={{fontSize:48,marginBottom:10}}>üìã</div><div style={{fontWeight:600,fontSize:14}}>{q?"Koi student nahi mila":"Abhi koi student nahi"}</div></div>
        :<div style={{display:"flex",flexDirection:"column",gap:8}}>
          {f.map((s,idx)=>{
            const g=gTot(s.subs);const p=g.mT>0?pct(g.oT,g.mT):null;const pass=p!==null&&p>=33;
            return(<div key={s.id} onClick={()=>onSel(s.id)} className="gc" style={{padding:"13px 15px",display:"flex",alignItems:"center",gap:12,cursor:"pointer",transition:"all .22s cubic-bezier(.4,0,.2,1)",animation:`fu .3s ${idx*0.04}s both`}}
              onMouseEnter={e=>{e.currentTarget.style.transform="translateY(-2px)";e.currentTarget.style.boxShadow="0 10px 30px rgba(0,0,0,0.28)";e.currentTarget.style.background="var(--glass2)";}}
              onMouseLeave={e=>{e.currentTarget.style.transform="";e.currentTarget.style.boxShadow="";e.currentTarget.style.background="";}}>
              <div style={{width:48,height:48,borderRadius:14,overflow:"hidden",background:"linear-gradient(135deg,#5c6bc0,#1a237e)",flexShrink:0,display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"0 4px 12px rgba(63,81,181,0.35)"}}>
                {s.photo?<img src={s.photo} style={{width:"100%",height:"100%",objectFit:"cover"}} alt=""/>:<span style={{fontSize:22}}>üë§</span>}
              </div>
              <div style={{flex:1,minWidth:0}}><div style={{fontWeight:700,fontSize:14,color:"var(--text)",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{s.name||"Naam nahi diya"}</div><div style={{fontSize:11,color:"var(--t2)",marginTop:2}}>Class <b style={{color:"var(--text)"}}>{s.cls||"?"}{s.sec?"-"+s.sec:""}</b>{s.gender?<> ¬∑ {s.gender}</>:""}{s.roll?<> ¬∑ Roll {s.roll}</>:""}</div></div>
              {p!==null&&<div style={{textAlign:"right",flexShrink:0}}><div style={{fontWeight:800,fontSize:15,color:pass?"#4caf50":"#f44336"}}>{p}%</div><div className="pill" style={{background:pass?"rgba(76,175,80,0.15)":"rgba(244,67,54,0.15)",color:pass?"#4caf50":"#f44336"}}>{gr(p)}</div></div>}
              <div style={{color:"var(--t3)",fontSize:18}}>‚Ä∫</div>
            </div>);
          })}
        </div>}
      </div>
    </div>
  );
}

/* EDITOR */
function Edit({student,onSave,onBack,onPrint,onDel,toast}){
  const[s,set]=useState(()=>JSON.parse(JSON.stringify(student)));
  const[baks,sb]=useState([]);const[showB,ssb]=useState(false);
  const[ao,sao]=useState(false);const[ro,sro]=useState(false);
  const pr=useRef();const tmr=useRef();
  useEffect(()=>{clearTimeout(tmr.current);tmr.current=setTimeout(()=>onSave(s),1500);return()=>clearTimeout(tmr.current);},[s]);
  const u=(k,v)=>set(p=>({...p,[k]:v,_updated:new Date().toISOString()}));
  const us=(i,k,v)=>set(p=>{const a=[...p.subs];a[i]={...a[i],[k]:v};return{...p,subs:a,_updated:new Date().toISOString()};});
  const cl=(v,mx)=>{if(v===""||v==="-")return"";let n=parseFloat(v);if(isNaN(n))return"";if(n<0)n=0;if(n>mx)n=mx;return String(Math.round(n*10)/10);};
  const hp=e=>{const f=e.target.files[0];if(!f)return;if(f.size>900000){toast("‚ö†Ô∏è Image 900KB se zyada hai");return;}const r=new FileReader();r.onload=ev=>set(p=>({...p,photo:ev.target.result}));r.readAsDataURL(f);};
  const lb=async()=>{try{const b=await fbB(s.id);sb(b);ssb(true);}catch{toast("‚ö†Ô∏è Backup load nahi hua");}};
  const gt=gTot(s.subs);const op=gt.mT>0?pct(gt.oT,gt.mT):null;const pass=op!==null&&op>=33;
  const atpct=s.att.p&&s.att.t&&parseFloat(s.att.t)>0?((parseFloat(s.att.p)/parseFloat(s.att.t))*100).toFixed(0)+"%":"";
  const am=ADDR.filter(a=>a.toLowerCase().includes((s.addr||"").toLowerCase())&&(s.addr||"").length>0);
  const Card=({title,ch})=><div className="gc" style={{padding:"16px",transition:"all .2s"}}><div style={{fontWeight:700,fontSize:11.5,marginBottom:13,color:"var(--t2)",letterSpacing:0.5,textTransform:"uppercase"}}>{title}</div>{ch}</div>;
  return(
    <div className="fi" style={{background:"var(--bg)",minHeight:"100vh",paddingBottom:90}}>
      <div style={{background:"rgba(8,8,16,0.88)",backdropFilter:"blur(24px)",WebkitBackdropFilter:"blur(24px)",borderBottom:"1px solid var(--gb)",padding:"11px 13px",display:"flex",alignItems:"center",gap:9,position:"sticky",top:0,zIndex:60,boxShadow:"0 2px 20px rgba(0,0,0,0.35)"}}>
        <button onClick={onBack} className="btn bg2" style={{padding:"8px 11px",display:"flex",alignItems:"center"}}>{I.back}</button>
        <div style={{flex:1,overflow:"hidden"}}><div style={{color:"var(--text)",fontWeight:700,fontSize:14,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{s.name||"Naya Student"}</div><div style={{color:"var(--t2)",fontSize:11}}>{s.cls?"Class "+s.cls+(s.sec?"-"+s.sec:""):""}{s.session?" ¬∑ "+s.session:""}</div></div>
        <button onClick={lb} className="btn bg2" style={{padding:"8px 11px",display:"flex",alignItems:"center",gap:5,fontSize:11}}>{I.hist}</button>
        <button onClick={()=>{onSave(s);onPrint(s);}} className="btn bd" style={{display:"flex",alignItems:"center",gap:6}}>{I.print} Print</button>
      </div>
      <div style={{padding:"13px",display:"flex",flexDirection:"column",gap:11}}>
        {op!==null&&<div style={{background:pass?"rgba(46,125,50,0.13)":"rgba(198,40,40,0.13)",border:`1.5px solid ${pass?"rgba(76,175,80,0.32)":"rgba(244,67,54,0.32)"}`,borderRadius:18,padding:"14px 18px",display:"flex",justifyContent:"space-between",alignItems:"center",animation:"si2 .25s ease",backdropFilter:"blur(10px)"}}>
          <div><div style={{fontSize:11,color:"var(--t2)",fontWeight:600,marginBottom:2}}>Overall Score</div><div style={{fontSize:20,fontWeight:800,color:pass?"#4caf50":"#f44336"}}>{gt.oT} / {gt.mT}</div></div>
          <div style={{textAlign:"right"}}><div style={{fontSize:30,fontWeight:900,color:pass?"#4caf50":"#f44336",lineHeight:1}}>{op}%</div><div className="pill" style={{background:pass?"rgba(76,175,80,0.18)":"rgba(244,67,54,0.18)",color:pass?"#4caf50":"#f44336",marginTop:4,fontSize:12}}>{gr(op)} ‚Äî {gl(op)}</div></div>
        </div>}

        {showB&&<Card title="üìÇ Cloud Backups" ch={<>
          <button onClick={()=>ssb(false)} style={{float:"right",background:"none",border:"none",cursor:"pointer",fontSize:18,color:"var(--t3)"}}>‚úï</button>
          {baks.length===0?<div style={{color:"var(--t3)",fontSize:13}}>Koi backup nahi</div>
          :baks.map((b,i)=><div key={i} style={{border:"1px solid var(--gb)",borderRadius:11,padding:"9px 12px",marginBottom:7,display:"flex",justifyContent:"space-between",alignItems:"center"}}>
            <div><div style={{fontWeight:600,fontSize:13,color:"var(--text)"}}>{i===0?"üïê Latest":"üïë Previous"}</div><div style={{fontSize:11,color:"var(--t2)"}}>{b._at?new Date(b._at).toLocaleString("en-IN"):""}</div></div>
            <button onClick={()=>{set({...b,_updated:new Date().toISOString()});ssb(false);toast("‚úÖ Restored!");}} className="btn bg2" style={{padding:"6px 13px",fontSize:12}}>Restore</button>
          </div>)}
        </>}/>}

        <Card title="üë§ Student Information" ch={<>
          <div style={{display:"flex",gap:12,marginBottom:12}}>
            <div onClick={()=>pr.current.click()} style={{width:78,height:94,border:"2px dashed var(--accent)",borderRadius:13,cursor:"pointer",overflow:"hidden",background:"rgba(92,107,192,0.08)",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",flexShrink:0,gap:4,transition:"all .2s"}}
              onMouseEnter={e=>e.currentTarget.style.background="rgba(92,107,192,0.18)"}
              onMouseLeave={e=>e.currentTarget.style.background="rgba(92,107,192,0.08)"}>
              {s.photo?<img src={s.photo} style={{width:"100%",height:"100%",objectFit:"cover"}} alt=""/>:<>{I.up}<span style={{fontSize:9,color:"var(--t3)",textAlign:"center"}}>Photo<br/><span style={{fontSize:8}}>max 900KB</span></span></>}
            </div>
            <input ref={pr} type="file" accept="image/*" style={{display:"none"}} onChange={hp}/>
            <div style={{flex:1,display:"flex",flexDirection:"column",gap:8}}>
              <input className="inp" placeholder="Student Full Name *" value={s.name} onChange={e=>u("name",e.target.value)}/>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
                <div style={{background:"var(--ib)",border:"1px solid var(--ibr)",borderRadius:10,padding:"10px 13px",fontSize:13,color:"var(--t2)"}}>Class: <strong style={{color:"var(--text)"}}>{s.cls||"‚Äî"}</strong></div>
                <input className="inp" placeholder="Section (A/B)" value={s.sec} onChange={e=>u("sec",e.target.value)}/>
              </div>
            </div>
          </div>
          <div style={{marginBottom:10}}>
            <div className="sl">Gender</div>
            <div style={{display:"flex",gap:8}}>
              {[["Male","#7c4dff"],["Female","#e91e8c"],["Other","#00bcd4"]].map(([g,col])=>(
                <button key={g} onClick={()=>u("gender",g)} style={{padding:"7px 16px",borderRadius:10,border:"1.5px solid "+(s.gender===g?col:"var(--gb)"),cursor:"pointer",fontSize:12,fontWeight:700,background:s.gender===g?col:"var(--btn2)",color:s.gender===g?"#fff":"var(--t2)",transform:s.gender===g?"scale(1.05)":"scale(1)",transition:"all .18s cubic-bezier(.34,1.56,.64,1)"}}>{g}</button>
              ))}
            </div>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            {[["Father's Name","father"],["Mother's Name","mother"],["Roll No.","roll"],["Admission No.","admno"],["Session","session"]].map(([pl,k])=>(
              <input key={k} className="inp" placeholder={pl} value={s[k]||""} onChange={e=>u(k,e.target.value)}/>
            ))}
            <input className="inp" type="date" value={s.dob||""} min="1999-01-01" max={new Date().toISOString().split("T")[0]} onChange={e=>u("dob",e.target.value)}/>
            <div style={{gridColumn:"span 2",position:"relative"}}>
              <input className="inp" placeholder="Address" value={s.addr||""} onChange={e=>{u("addr",e.target.value);sao(true);}} onFocus={()=>sao(true)} onBlur={()=>setTimeout(()=>sao(false),200)}/>
              {ao&&am.length>0&&<div className="sug">{am.map((a,i)=><div key={i} className="si" onMouseDown={()=>{u("addr",a);sao(false);}}>üìç {a}</div>)}</div>}
            </div>
          </div>
        </>}/>

        <Card title="üìÖ Attendance" ch={<>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            {[["Haazir Din","p","e.g. 210"],["Kul Kaarya Diwas","t","e.g. 240"]].map(([l,k,ph])=>(
              <div key={k}><div className="sl">{l}</div><input className="inp" type="number" min="0" placeholder={ph} value={s.att[k]} onChange={e=>set(p=>({...p,att:{...p.att,[k]:e.target.value}}))}/></div>
            ))}
          </div>
          {atpct&&<div style={{marginTop:9,fontSize:12,color:"#4caf50",fontWeight:600,background:"rgba(76,175,80,0.1)",padding:"7px 12px",borderRadius:9,display:"inline-flex",alignItems:"center",gap:5}}>{I.ok} Haaziri: {atpct}</div>}
        </>}/>

        <Card title="üìä Marks ‚Äî T1:/40  T2:/60  T3:/100  (Fixed MM)" ch={<>
          <div style={{overflowX:"auto",WebkitOverflowScrolling:"touch"}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:11,minWidth:400}}>
              <thead><tr style={{background:"rgba(92,107,192,0.22)"}}>
                <th style={{padding:"7px 5px",textAlign:"left",color:"var(--text)",minWidth:80}}>Subject</th>
                <th style={{padding:5,color:"#90caf9",fontSize:10}}>T1<br/><span style={{fontSize:8,opacity:.7}}>/40</span></th>
                <th style={{padding:5,color:"#90caf9",fontSize:10}}>T2<br/><span style={{fontSize:8,opacity:.7}}>/60</span></th>
                <th style={{padding:5,color:"#90caf9",fontSize:10}}>T3<br/><span style={{fontSize:8,opacity:.7}}>/100</span></th>
                <th style={{padding:5,color:"#ff8a80",fontSize:10}}>Total<br/><span style={{fontSize:8,opacity:.7}}>/200</span></th>
                <th style={{padding:5,color:"#b9f6ca",fontSize:10}}>%</th>
                <th style={{padding:5,color:"#ea80fc",fontSize:10}}>Grade</th>
                <th style={{width:22}}></th>
              </tr></thead>
              <tbody>
                {s.subs.map((sub,i)=>{
                  const tot=obt(sub);const p=pct(tot,SMM);const ps=p!==null&&p>=33;
                  return(<tr key={i} style={{borderBottom:"1px solid var(--gb)"}}>
                    <td style={{padding:"3px 2px"}}><input className="mi" style={{textAlign:"left",fontWeight:600,minWidth:78}} value={sub.n} onChange={e=>us(i,"n",e.target.value)} placeholder="Subject"/></td>
                    <td style={{padding:"3px 2px"}}><input className="mi" style={{width:36}} value={sub.o1} onChange={e=>us(i,"o1",cl(e.target.value,40))} placeholder="‚Äî"/></td>
                    <td style={{padding:"3px 2px"}}><input className="mi" style={{width:36}} value={sub.o2} onChange={e=>us(i,"o2",cl(e.target.value,60))} placeholder="‚Äî"/></td>
                    <td style={{padding:"3px 2px"}}><input className="mi" style={{width:36}} value={sub.o3} onChange={e=>us(i,"o3",cl(e.target.value,100))} placeholder="‚Äî"/></td>
                    <td style={{padding:"3px 4px",fontWeight:700,color:"#ff8a80",textAlign:"center"}}>{tot||""}</td>
                    <td style={{padding:"3px 4px",textAlign:"center",fontWeight:600,color:ps?"#4caf50":"#f44336",fontSize:10}}>{p!==null?p+"%":""}</td>
                    <td style={{padding:"3px 4px",textAlign:"center"}}>{p!==null&&<span className="pill" style={{background:ps?"rgba(76,175,80,0.2)":"rgba(244,67,54,0.2)",color:ps?"#4caf50":"#f44336"}}>{gr(p)}</span>}</td>
                    <td><button onClick={()=>set(p=>({...p,subs:p.subs.filter((_,j)=>j!==i)}))} style={{background:"none",border:"none",cursor:"pointer",color:"rgba(244,67,54,0.6)",padding:2}}>{I.trash}</button></td>
                  </tr>);
                })}
                <tr style={{background:"rgba(92,107,192,0.18)",fontWeight:800,fontSize:11}}>
                  <td style={{padding:"7px 5px",color:"var(--text)"}}>TOTAL</td>
                  <td style={{textAlign:"center",color:"#90caf9"}}>{gt.o1||""}</td><td style={{textAlign:"center",color:"#90caf9"}}>{gt.o2||""}</td><td style={{textAlign:"center",color:"#90caf9"}}>{gt.o3||""}</td>
                  <td style={{textAlign:"center",color:"#ff8a80"}}>{gt.oT||""}/{gt.mT}</td>
                  <td style={{textAlign:"center",color:pass?"#4caf50":"#f44336"}}>{op!==null?op+"%":""}</td>
                  <td style={{textAlign:"center"}}>{op!==null&&<span className="pill" style={{background:"rgba(92,107,192,0.3)",color:"#fff"}}>{gr(op)}</span>}</td><td></td>
                </tr>
              </tbody>
            </table>
          </div>
          <button onClick={()=>set(p=>({...p,subs:[...p.subs,{n:"",o1:"",o2:"",o3:""}]}))} className="btn bg2" style={{marginTop:9,fontSize:12,padding:"7px 14px"}}>+ Subject Add Karein</button>
        </>}/>

        <Card title="üé® Co-Scholastic Activities" ch={<div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
          {[["sports","‚öΩ Sports"],["art","üé® Art & Craft"],["music","üéµ Music"],["disc","üìê Discipline"],["clean","‚ú® Cleanliness"]].map(([k,l])=>(
            <div key={k}><div className="sl">{l}</div><select className="inp" value={s.cosco[k]} onChange={e=>set(p=>({...p,cosco:{...p.cosco,[k]:e.target.value}}))}>
              <option value="">‚Äî Chunein ‚Äî</option>{["A+","A","B+","B","C"].map(g=><option key={g} value={g}>{g}</option>)}
            </select></div>
          ))}
        </div>}/>

        <Card title="‚úèÔ∏è Remarks, Rank & Print Date" ch={<>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:10}}>
            <div><div className="sl">Class Rank</div><input className="inp" placeholder="e.g. 3rd" value={s.rank||""} onChange={e=>u("rank",e.target.value)}/></div>
            <div><div className="sl">Print Date (marksheet ke liye)</div><input className="inp" type="date" value={s.printDate||""} onChange={e=>u("printDate",e.target.value)}/></div>
          </div>
          <div className="sl">Teacher's Remark</div>
          <div style={{position:"relative"}}>
            <textarea className="inp" rows={2} value={s.remark||""} placeholder="Remark likhein ya neeche se chunein‚Ä¶" onChange={e=>u("remark",e.target.value)} onFocus={()=>sro(true)} onBlur={()=>setTimeout(()=>sro(false),200)} style={{resize:"none"}}/>
            {ro&&<div className="sug">{REM.map((r,i)=><div key={i} className="si" onMouseDown={()=>{u("remark",r);sro(false);}}>üí¨ {r}</div>)}</div>}
          </div>
        </>}/>

        <button onClick={onDel} className="btn" style={{width:"100%",background:"rgba(198,40,40,0.08)",color:"#ef5350",border:"1px solid rgba(198,40,40,0.2)",fontSize:13,padding:13,borderRadius:13}}>üóëÔ∏è Delete Student</button>
      </div>
    </div>
  );
}

/* PRINT VIEW */
function PView({student:s,onClose}){
  const gt=gTot(s.subs);const op=gt.mT>0?pct(gt.oT,gt.mT):null;
  const atd=s.att.p&&s.att.t&&parseFloat(s.att.t)>0?((parseFloat(s.att.p)/parseFloat(s.att.t))*100).toFixed(0)+"%":(s.att.p?s.att.p+" din":"");
  const t1p=gt.m1>0?((gt.o1/gt.m1)*100).toFixed(0)+"%":"";
  const t2p=gt.m2>0?((gt.o2/gt.m2)*100).toFixed(0)+"%":"";
  const t3p=gt.m3>0?((gt.o3/gt.m3)*100).toFixed(0)+"%":"";
  const bd="1px solid #000";const hbg="#fce4d6";const itl="#d1eeee";
  const pd=s.printDate?new Date(s.printDate+"T00:00:00").toLocaleDateString("en-IN",{day:"2-digit",month:"2-digit",year:"numeric"}):"";
  return(
    <div className="fi">
      <div className="np" style={{background:"#1a237e",padding:"11px 14px",display:"flex",alignItems:"center",gap:10,position:"sticky",top:0,zIndex:60}}>
        <button onClick={onClose} className="btn bg2" style={{color:"#fff",display:"flex",alignItems:"center",gap:6}}>{I.back} Back</button>
        <div style={{flex:1,color:"#fff",fontWeight:600,fontSize:13,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{s.name} ‚Äî Marksheet Preview</div>
        <button onClick={()=>window.print()} className="btn bd" style={{display:"flex",alignItems:"center",gap:6}}>{I.print} Print / PDF</button>
      </div>
      <div className="np" style={{background:"#fff8e1",padding:"6px 14px",fontSize:12,color:"#e65100",textAlign:"center"}}>üí° Chrome ‚Üí Print ‚Üí Margins: None ‚Üí Background graphics: ‚úÖ ON</div>

      <div id="MS" style={{width:"210mm",height:"297mm",background:"white",margin:"0 auto",padding:"3mm",boxSizing:"border-box",overflow:"hidden",fontFamily:"Arial,Helvetica,sans-serif",display:"flex",flexDirection:"column"}}>
        <div style={{border:"3px solid #c62828",flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
          <div style={{border:"1.5px solid #000",margin:"2px",flex:1,padding:"5px 8px",display:"flex",flexDirection:"column",overflow:"hidden"}}>

            {/* HEADER */}
            <div style={{display:"flex",alignItems:"flex-start",gap:6,marginBottom:4,minHeight:86}}>
              {/* LEFT: Student Photo */}
              <div style={{width:74,height:82,border:"1.5px solid #555",overflow:"hidden",flexShrink:0,background:"#f0f0f0",display:"flex",alignItems:"center",justifyContent:"center",boxShadow:"1px 1px 4px rgba(0,0,0,0.1)"}}>
                {s.photo?<img src={s.photo} style={{width:"100%",height:"100%",objectFit:"cover"}} alt=""/>:<div style={{textAlign:"center"}}><div style={{fontSize:28,color:"#bbb"}}>üë§</div><span style={{fontSize:7,color:"#bbb"}}>Photo</span></div>}
              </div>
              {/* CENTER */}
              <div style={{flex:1,textAlign:"center",padding:"0 4px"}}>
                <div style={{fontSize:28,fontWeight:900,color:"#c62828",fontFamily:'"Times New Roman",Times,serif',textTransform:"uppercase",letterSpacing:0.5,lineHeight:1.1}}>{SCH.name}</div>
                <div style={{fontSize:11.5,fontWeight:500,color:"#333",marginTop:2,letterSpacing:0.2}}>{SCH.addr}</div>
                <div style={{display:"inline-block",background:"#ffff00",color:"#c62828",padding:"2px 20px",fontWeight:900,fontSize:12,textDecoration:"underline",marginTop:4,marginBottom:3,letterSpacing:0.5}}>PROGRESS EVALUATION REPORT</div>
                <div style={{fontSize:10.5,fontWeight:700,color:"#1a237e",lineHeight:1.5}}>ACADEMIC SESSION :&nbsp;<span style={{color:"#000",fontWeight:900}}>{s.session}</span></div>
                <div style={{fontSize:14,fontWeight:900,color:"#000",fontFamily:'"Times New Roman",Times,serif',lineHeight:1.3}}>CLASS :&nbsp;{s.cls}{s.sec?"-"+s.sec:""}</div>
              </div>
              {/* RIGHT: Logo */}
              <div style={{width:74,height:82,flexShrink:0,display:"flex",alignItems:"center",justifyContent:"center",border:"1.5px solid #555",overflow:"hidden",background:"#f8f8ff"}}>
                <img src={SCH.logo} alt="SBS" style={{width:"100%",height:"100%",objectFit:"contain"}}
                  onError={e=>{e.target.style.display="none";e.target.parentElement.innerHTML='<div style="text-align:center;font-weight:900;font-size:14px;color:#1a237e;line-height:1.3">SBS<br/><span style=\'font-size:10px;font-weight:700\'>MARKS</span></div>';}}/>
              </div>
            </div>

            {/* GAP */}
            <div style={{height:5}}/>

            {/* STUDENT INFO ‚Äî no vertical separator, gender included */}
            <div style={{background:itl,borderTop:"2px solid #000",borderBottom:"2px solid #000",padding:"6px 9px",fontFamily:'"Times New Roman",Times,serif',fontSize:10,fontWeight:700,marginBottom:5}}>
              <div style={{display:"grid",gridTemplateColumns:"57% 43%"}}>
                <div style={{display:"flex",flexDirection:"column",gap:3.5,paddingRight:8}}>
                  {[["STUDENT'S NAME",(s.name||"").toUpperCase()],["MOTHER'S NAME",(s.mother||"").toUpperCase()],["FATHER'S NAME",(s.father||"").toUpperCase()],["GENDER",(s.gender||"").toUpperCase()],["ADDRESS",(s.addr||"").toUpperCase()]].map(([l,v])=>(
                    <div key={l} style={{display:"flex",alignItems:"flex-start",minHeight:14}}><span style={{width:112,flexShrink:0,fontSize:9.5,fontWeight:700}}>{l}</span><span style={{marginRight:4,fontWeight:900}}>:</span><span style={{flex:1,fontSize:9.5,wordBreak:"break-word",lineHeight:1.3}}>{v}</span></div>
                  ))}
                </div>
                <div style={{display:"flex",flexDirection:"column",gap:3.5,paddingLeft:9}}>
                  {[["ROLL NO.",s.roll||""],["ADMISSION NO.",s.admno||""],["DATE OF BIRTH",s.dob?new Date(s.dob+"T00:00:00").toLocaleDateString("en-IN"):s.dob||""]].map(([l,v])=>(
                    <div key={l} style={{display:"flex",alignItems:"center",minHeight:14}}><span style={{width:105,flexShrink:0,fontSize:9.5,fontWeight:700}}>{l}</span><span style={{marginRight:4,fontWeight:900}}>:</span><span style={{fontSize:9.5,fontWeight:900}}>{v}</span></div>
                  ))}
                </div>
              </div>
            </div>

            {/* GAP */}
            <div style={{height:5}}/>

            {/* MARKS TABLE ‚Äî T1=40, T2=60, T3=100 */}
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:9,tableLayout:"fixed",marginBottom:5}}>
              <colgroup><col style={{width:"20%"}}/><col style={{width:"5%"}}/><col style={{width:"8%"}}/><col style={{width:"5%"}}/><col style={{width:"8%"}}/><col style={{width:"5%"}}/><col style={{width:"8%"}}/><col style={{width:"5%"}}/><col style={{width:"9%"}}/><col style={{width:"7%"}}/></colgroup>
              <thead>
                <tr style={{background:hbg,height:20}}>
                  <th rowSpan={2} style={{border:bd,textAlign:"left",paddingLeft:4,fontWeight:800,fontSize:9.5,verticalAlign:"middle"}}>SUBJECTS</th>
                  <th colSpan={2} style={{border:bd,color:"#1a237e",fontWeight:700,fontSize:8.5,textAlign:"center"}}>FIRST TERM EXAM</th>
                  <th colSpan={2} style={{border:bd,color:"#1a237e",fontWeight:700,fontSize:8.5,textAlign:"center"}}>SECOND TERM EXAM</th>
                  <th colSpan={2} style={{border:bd,color:"#1a237e",fontWeight:700,fontSize:8.5,textAlign:"center"}}>THIRD TERM EXAM</th>
                  <th colSpan={2} style={{border:bd,color:"#1a237e",fontWeight:700,fontSize:8.5,textAlign:"center"}}>GRAND TOTAL</th>
                  <th rowSpan={2} style={{border:bd,fontWeight:700,fontSize:8.5,textAlign:"center",verticalAlign:"middle"}}>GRADE</th>
                </tr>
                <tr style={{background:hbg,height:16}}>{["MM","MARKS OBT","MM","MARKS OBT","MM","MARKS OBT","MM","TOTAL"].map((h,i)=><th key={i} style={{border:bd,color:i%2===0?"#0070c0":"#222",fontWeight:700,fontSize:7.5,textAlign:"center",padding:"1px"}}>{h}</th>)}</tr>
              </thead>
              <tbody>
                {s.subs.map((sub,i)=>{
                  const tot=obt(sub);const p=pct(tot,SMM);const ps=p!==null&&p>=33;
                  return(<tr key={i} style={{height:22,background:i%2===0?"#fff":"#f7f7fc"}}>
                    <td style={{border:bd,paddingLeft:4,fontWeight:700,textTransform:"uppercase",fontSize:9,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{sub.n}</td>
                    <td style={{border:bd,textAlign:"center",color:"#0070c0",fontWeight:700,fontSize:8.5}}>{T1}</td>
                    <td style={{border:bd,textAlign:"center",fontWeight:600}}>{sub.o1}</td>
                    <td style={{border:bd,textAlign:"center",color:"#0070c0",fontWeight:700,fontSize:8.5}}>{T2}</td>
                    <td style={{border:bd,textAlign:"center",fontWeight:600}}>{sub.o2}</td>
                    <td style={{border:bd,textAlign:"center",color:"#0070c0",fontWeight:700,fontSize:8.5}}>{T3}</td>
                    <td style={{border:bd,textAlign:"center",fontWeight:600}}>{sub.o3}</td>
                    <td style={{border:bd,textAlign:"center",color:"#0070c0",fontWeight:700,fontSize:8.5}}>{SMM}</td>
                    <td style={{border:bd,textAlign:"center",fontWeight:800}}>{tot||""}</td>
                    <td style={{border:bd,textAlign:"center",fontWeight:900,fontSize:9.5,color:p!==null&&p<33?"#c62828":"#1a237e"}}>{p!==null?gr(p):""}</td>
                  </tr>);
                })}
                <tr style={{background:"#e8eaf6",fontWeight:800,height:22,fontSize:9}}>
                  <td style={{border:bd,paddingLeft:4,fontWeight:900}}>TOTAL</td>
                  <td style={{border:bd,textAlign:"center",color:"#0070c0"}}>{gt.m1}</td><td style={{border:bd,textAlign:"center",fontWeight:900}}>{gt.o1||""}</td>
                  <td style={{border:bd,textAlign:"center",color:"#0070c0"}}>{gt.m2}</td><td style={{border:bd,textAlign:"center",fontWeight:900}}>{gt.o2||""}</td>
                  <td style={{border:bd,textAlign:"center",color:"#0070c0"}}>{gt.m3}</td><td style={{border:bd,textAlign:"center",fontWeight:900}}>{gt.o3||""}</td>
                  <td style={{border:bd,textAlign:"center",color:"#0070c0"}}>{gt.mT}</td><td style={{border:bd,textAlign:"center",fontWeight:900}}>{gt.oT}</td><td style={{border:bd}}></td>
                </tr>
                <tr style={{background:"#e8eaf6",fontWeight:800,height:22,fontSize:9}}>
                  <td style={{border:bd,paddingLeft:4,fontWeight:900}}>PERCENTAGE</td>
                  <td colSpan={2} style={{border:bd,textAlign:"center"}}>{t1p}</td>
                  <td colSpan={2} style={{border:bd,textAlign:"center"}}>{t2p}</td>
                  <td colSpan={2} style={{border:bd,textAlign:"center"}}>{t3p}</td>
                  <td colSpan={2} style={{border:bd,textAlign:"center",fontSize:11,fontWeight:900}}>{op!==null?op+"%":""}</td>
                  <td style={{border:bd,textAlign:"center",fontWeight:900,fontSize:10,color:"#1a237e"}}>{gr(op)}</td>
                </tr>
              </tbody>
            </table>

            {/* GAP */}
            <div style={{height:5}}/>

            {/* CO-SCHOLASTIC */}
            <div style={{marginBottom:5}}>
              <div style={{background:hbg,fontWeight:700,fontSize:8.5,padding:"2px 6px",border:bd,display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:"none"}}><span>Co-Scholastic Area</span><span style={{fontSize:7.5}}>A+:Outstanding ¬∑ A:Excellent ¬∑ B+:Very Good ¬∑ B:Good ¬∑ C:Average</span></div>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:8.5}}><tbody><tr style={{height:22}}>
                {[["Sports & Games","sports"],["Art & Craft","art"],["Music & Dance","music"],["Discipline","disc"],["Cleanliness","clean"]].map(([l,k])=>(
                  <React.Fragment key={k}><td style={{border:bd,padding:"2px 5px",fontWeight:700,background:"#fafafa",fontSize:8.5}}>{l}</td><td style={{border:bd,textAlign:"center",fontWeight:900,color:"#1a237e",width:"5%",fontSize:10.5}}>{s.cosco[k]||""}</td></React.Fragment>
                ))}
              </tr></tbody></table>
            </div>

            {/* GAP */}
            <div style={{height:5}}/>

            {/* GRADE SCALE ‚Äî active grade highlighted in red */}
            <div style={{display:"flex",height:22,fontSize:7.5,marginBottom:5}}>
              <div style={{background:"#4a4a4a",color:"#fff",width:"11%",display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",padding:"0 2px",lineHeight:1.2,fontSize:7,fontWeight:700,border:bd}}>GRADE<br/>SCALE</div>
              <div style={{flex:1,display:"flex"}}>
                {GT.map((r,i)=>{
                  const act=op!==null&&op>=r.min&&op<=r.max;
                  return(<div key={i} style={{flex:1,background:act?"#c62828":i%2===0?"#dbe5f1":"#cfd8ef",color:act?"#fff":"#333",borderTop:bd,borderBottom:bd,borderRight:bd,borderLeft:i===0?bd:"none",display:"flex",alignItems:"center",justifyContent:"center",fontWeight:act?900:700,fontSize:act?7.5:7,textAlign:"center",lineHeight:1.2,position:"relative",zIndex:act?1:0,transform:act?"scaleY(1.08)":"scaleY(1)"}}>
                    {r.min===0?"00":r.min}‚Äì{r.max}<br/>{r.g}
                  </div>);
                })}
              </div>
            </div>

            {/* GAP */}
            <div style={{height:5}}/>

            {/* RANK ‚Äî centred row */}
            <div style={{textAlign:"center",marginBottom:5}}>
              <span style={{fontSize:10,fontWeight:800,color:"#1a237e"}}>Class Rank : </span>
              <span style={{fontSize:11,fontWeight:900,borderBottom:"1.5px solid #333",paddingBottom:1,minWidth:60,display:"inline-block",textAlign:"center"}}>{s.rank||""}</span>
            </div>

            {/* REMARK + ATTENDANCE one row */}
            <div style={{display:"flex",alignItems:"center",gap:10,padding:"5px 10px",background:"#f8f8ff",border:"1px solid #c5cae9",borderRadius:2,marginBottom:6}}>
              <div style={{display:"flex",alignItems:"center",gap:4,flex:1}}>
                <span style={{fontSize:9.5,fontWeight:800,color:"#1a237e",whiteSpace:"nowrap"}}>Remark :</span>
                <span style={{flex:1,borderBottom:"1.5px solid #333",paddingBottom:1,fontSize:9,color:"#111",minWidth:80}}>{s.remark||""}</span>
              </div>
              <div style={{display:"flex",alignItems:"center",gap:4,flexShrink:0}}>
                <span style={{fontSize:9.5,fontWeight:800,color:"#1a237e",whiteSpace:"nowrap"}}>Attendance :</span>
                <span style={{borderBottom:"1.5px solid #333",minWidth:44,textAlign:"center",paddingBottom:1,fontSize:10,fontWeight:900,color:"#2e7d32"}}>{atd}</span>
              </div>
            </div>

            {/* FLEX SPACER ‚Äî signatures anchored to bottom */}
            <div style={{flex:1}}/>

            {/* SIGNATURES ‚Äî at absolute bottom, dotted lines only */}
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-end",padding:"0 14px 6px"}}>
              <div style={{textAlign:"center",minWidth:110}}>
                <div style={{fontSize:9.5,fontWeight:600,minHeight:14,paddingBottom:4}}>{pd}</div>
                <div style={{borderTop:"2px dotted #555",width:110,marginBottom:3}}></div>
                <div style={{fontSize:9.5,fontWeight:700}}>Date</div>
              </div>
              <div style={{textAlign:"center",minWidth:130}}>
                <div style={{borderTop:"2px dotted #555",width:130,marginBottom:3}}></div>
                <div style={{fontSize:9.5,fontWeight:700}}>Class Teacher</div>
              </div>
              <div style={{textAlign:"center",minWidth:130}}>
                <div style={{width:130,height:28,display:"flex",alignItems:"center",justifyContent:"center"}}>
                  <img src="principal_sign.png" alt="" style={{maxHeight:"100%",maxWidth:"100%",objectFit:"contain"}} onError={e=>e.target.style.display="none"}/>
                </div>
                <div style={{borderTop:"2px dotted #555",width:130,marginBottom:3}}></div>
                <div style={{fontSize:9.5,fontWeight:700}}>Principal</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

/* LIVE PREVIEW */
function LPrev({student:s}){
  if(!s)return(<div style={{color:"var(--t3)",textAlign:"center",marginTop:80}}><div style={{fontSize:48,marginBottom:12}}>üìÑ</div><div style={{fontSize:13}}>Student select karein preview ke liye</div></div>);
  const SC=0.47;const gt=gTot(s.subs);const op=gt.mT>0?pct(gt.oT,gt.mT):null;
  const bd="1px solid #000";const hbg="#fce4d6";const itl="#d1eeee";
  const W=210*SC*3.779527559;const H=297*SC*3.779527559;
  return(<div style={{position:"relative",width:W,height:H,overflow:"hidden",boxShadow:"0 16px 48px rgba(0,0,0,0.45)",borderRadius:4}}>
    <div style={{transformOrigin:"top left",transform:`scale(${SC})`,width:"210mm",height:"297mm",background:"white",padding:"3mm",boxSizing:"border-box",fontFamily:"Arial,sans-serif",position:"absolute",top:0,left:0}}>
      <div style={{border:"3px solid #c62828",height:"100%",display:"flex",flexDirection:"column"}}>
        <div style={{border:"1.5px solid #000",margin:"2px",flex:1,padding:"5px 8px",display:"flex",flexDirection:"column",overflow:"hidden"}}>
          <div style={{display:"flex",alignItems:"flex-start",gap:6,marginBottom:4,minHeight:86}}>
            <div style={{width:74,height:82,border:"1.5px solid #555",overflow:"hidden",flexShrink:0,background:"#f0f0f0",display:"flex",alignItems:"center",justifyContent:"center"}}>
              {s.photo?<img src={s.photo} style={{width:"100%",height:"100%",objectFit:"cover"}} alt=""/>:<div style={{fontSize:28,color:"#bbb"}}>üë§</div>}
            </div>
            <div style={{flex:1,textAlign:"center"}}>
              <div style={{fontSize:28,fontWeight:900,color:"#c62828",fontFamily:'"Times New Roman",serif',textTransform:"uppercase",lineHeight:1.1}}>{SCH.name}</div>
              <div style={{fontSize:11.5,color:"#333",marginTop:2}}>{SCH.addr}</div>
              <div style={{display:"inline-block",background:"#ffff00",color:"#c62828",padding:"2px 18px",fontWeight:900,fontSize:12,textDecoration:"underline",marginTop:4,marginBottom:3}}>PROGRESS EVALUATION REPORT</div>
              <div style={{fontSize:10.5,fontWeight:700,color:"#1a237e"}}>ACADEMIC SESSION : {s.session}</div>
              <div style={{fontSize:14,fontWeight:900,color:"#000"}}>CLASS : {s.cls}{s.sec?"-"+s.sec:""}</div>
            </div>
            <div style={{width:74,height:82,border:"1.5px solid #555",overflow:"hidden",flexShrink:0,background:"#f8f8ff",display:"flex",alignItems:"center",justifyContent:"center"}}>
              <img src={SCH.logo} alt="SBS" style={{width:"100%",height:"100%",objectFit:"contain"}} onError={e=>{e.target.style.display="none";e.target.parentElement.innerHTML='<div style="text-align:center;font-weight:900;font-size:14px;color:#1a237e">SBS<br/><span style=\'font-size:10px\'>MARKS</span></div>';}}/>
            </div>
          </div>
          <div style={{background:itl,borderTop:"2px solid #000",borderBottom:"2px solid #000",padding:"5px 8px",fontSize:9.5,fontWeight:700,marginBottom:4}}>
            {[["STUDENT'S NAME",(s.name||"").toUpperCase()],["MOTHER'S NAME",(s.mother||"").toUpperCase()],["FATHER'S NAME",(s.father||"").toUpperCase()],["GENDER",(s.gender||"").toUpperCase()]].map(([l,v])=>(
              <div key={l} style={{display:"flex",minHeight:14}}><span style={{width:112,fontWeight:700}}>{l}</span><span style={{marginRight:3}}>:</span><span>{v}</span></div>
            ))}
          </div>
          <table style={{width:"100%",borderCollapse:"collapse",fontSize:8,tableLayout:"fixed",marginBottom:4}}>
            <thead><tr style={{background:hbg}}>
              <th style={{border:bd,padding:"2px 3px",textAlign:"left",fontSize:8}}>SUBJECTS</th>
              {["T1/40","OBT","T2/60","OBT","T3/100","OBT","TOTAL","GR"].map((h,i)=><th key={i} style={{border:bd,fontSize:7,textAlign:"center",color:i%2===0&&i<6?"#0070c0":i===6?"#c62828":"#333"}}>{h}</th>)}
            </tr></thead>
            <tbody>{s.subs.map((sub,i)=>{const tot=obt(sub);const p=pct(tot,SMM);return(<tr key={i} style={{height:18,background:i%2===0?"#fff":"#f9f9f9"}}>
              <td style={{border:bd,paddingLeft:3,fontSize:7.5,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",fontWeight:600}}>{sub.n}</td>
              <td style={{border:bd,textAlign:"center",fontSize:7,color:"#0070c0"}}>{T1}</td><td style={{border:bd,textAlign:"center",fontSize:7}}>{sub.o1}</td>
              <td style={{border:bd,textAlign:"center",fontSize:7,color:"#0070c0"}}>{T2}</td><td style={{border:bd,textAlign:"center",fontSize:7}}>{sub.o2}</td>
              <td style={{border:bd,textAlign:"center",fontSize:7,color:"#0070c0"}}>{T3}</td><td style={{border:bd,textAlign:"center",fontSize:7}}>{sub.o3}</td>
              <td style={{border:bd,textAlign:"center",fontWeight:700,fontSize:7}}>{tot||""}</td>
              <td style={{border:bd,textAlign:"center",fontWeight:700,color:p!==null&&p<33?"#c62828":"#1a237e",fontSize:7}}>{p!==null?gr(p):""}</td>
            </tr>);})}
            </tbody>
          </table>
          {op!==null&&<div style={{textAlign:"center",fontSize:11,fontWeight:900,color:op>=33?"#1b5e20":"#c62828"}}>{op}% ‚Äî {gr(op)} ‚Äî {gl(op)}</div>}
        </div>
      </div>
    </div>
  </div>);
}

/* APP */
function App(){
  const[dark,tog]=useTheme();
  const[scr,setSc]=useState("dash");
  const[sts,setSts]=useState([]);
  const[aid,setAid]=useState(null);
  const[pst,setPst]=useState(null);
  const[prv,setPrv]=useState(null);
  const[msg,setMsg]=useState("");
  const[ss,setSs]=useState("idle");
  const[ts,setTs]=useState("");
  const[loaded,setL]=useState(false);
  const[isD,setIsD]=useState(window.innerWidth>=900);
  const[logd,setLogd]=useState(()=>isOk());
  const[err,setErr]=useState("");
  const[cs,setCs]=useState(false);

  useEffect(()=>{const h=()=>setIsD(window.innerWidth>=900);window.addEventListener("resize",h);return()=>window.removeEventListener("resize",h);},[]);
  const toast=useCallback(m=>{setMsg(m);setTimeout(()=>setMsg(""),2800);},[]);
  const login=pw=>{if(pw==="sbs2025"){saveSes();setLogd(true);setErr("");return true;}setErr("Galat password!");return false;};
  const logout=()=>{if(window.confirm("Logout karna chahte hain?")){clrSes();setLogd(false);setSts([]);setL(false);setSc("dash");}};

  useEffect(()=>{
    if(!logd)return;setSs("syncing");
    fbA().then(d=>{setSts(d.length>0?d:lsL());setSs("synced");setTs(new Date().toLocaleTimeString("en-IN"));setL(true);})
    .catch(()=>{setSts(lsL());setSs("offline");setL(true);toast("üì¥ Offline mode");});
  },[logd]);

  useEffect(()=>{if(loaded)lsS(sts);},[sts,loaded]);

  const save=useCallback(async u=>{
    const nx=sts.map(s=>s.id===u.id?u:s);setSts(nx);lsS(nx);setPrv(u);setSs("syncing");
    try{await fbS(u);setSs("synced");setTs(new Date().toLocaleTimeString("en-IN"));}
    catch{setSs("error");toast("‚ö†Ô∏è Offline ‚Äî local save hua");}
  },[sts]);

  const selCls=(cls,gen)=>{setCs(false);const st=newSt(cls,gen);setSts(p=>[...p,st]);setAid(st.id);setPrv(st);setSc("editor");fbS(st).catch(()=>{});};
  const sel=id=>{setAid(id);const st=sts.find(s=>s.id===id);setPrv(st);setSc("editor");};
  const del=async()=>{if(!window.confirm("Is student ko delete karein?"))return;const nx=sts.filter(s=>s.id!==aid);setSts(nx);lsS(nx);setPrv(null);try{await fbD(aid);}catch{}setSc("dash");toast("üóëÔ∏è Deleted");};

  if(!logd)return<Login onLogin={login} err={err} dark={dark} tog={tog}/>;
  if(cs)return<ClsSel onSelect={selCls} dark={dark}/>;
  if(!loaded)return(<div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:16,background:dark?"radial-gradient(ellipse at 50% 30%,#18106e,#080810)":"radial-gradient(ellipse at 50% 30%,#c8d0ff,#f0f2fb)"}}>
    <div style={{fontSize:50}}>üè´</div>
    <div style={{fontWeight:900,color:dark?"#fff":"#1a237e",fontSize:17}}>{SCH.name}</div>
    <div style={{color:"var(--t2)",fontSize:13,display:"flex",alignItems:"center",gap:9}}>
      <span style={{width:8,height:8,borderRadius:"50%",background:"#ff9800",display:"inline-block",animation:"pu 1.1s infinite"}}/>Loading‚Ä¶
    </div>
  </div>);

  const ast=sts.find(s=>s.id===aid);
  return(
    <div className={isD?"shell":""}>
      <div className={isD?"lp":""}>
        {scr==="dash"&&<Dash students={sts} onNew={()=>setCs(true)} onSel={sel} ss={ss} ts={ts} onOut={logout} onRes={()=>setSc("results")} dark={dark} tog={tog}/>}
        {scr==="results"&&<RView students={sts} onClose={()=>setSc("dash")} onSel={id=>{sel(id);}}/>}
        {scr==="editor"&&ast&&<Edit student={ast} onSave={save} onBack={()=>{setSc("dash");setPrv(null);}} onPrint={s=>{setPst(s);setSc("print");}} onDel={del} toast={toast}/>}
        {scr==="print"&&pst&&<PView student={pst} onClose={()=>setSc("editor")}/>}
      </div>
      {isD&&scr!=="print"&&<div className="rp">
        <div style={{color:"var(--t3)",fontSize:10,letterSpacing:2,marginBottom:16,fontWeight:700}}>‚óÄ  LIVE PREVIEW  ‚ñ∂</div>
        <LPrev student={prv||ast}/>
      </div>}
      <Toast msg={msg}/>
    </div>
  );
}
ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
