<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
<title>SBS Shiksha Niketan ‚Äî Marksheet System</title>
<meta name="theme-color" content="#1a237e"/>
<link rel="manifest" href="manifest.json"/>
<link rel="apple-touch-icon" href="icon-192.png"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet"/>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:'Inter',sans-serif;background:#f0f4f8;-webkit-tap-highlight-color:transparent;color:#1e293b;}

/* ‚îÄ‚îÄ LIGHT THEME TOKENS ‚îÄ‚îÄ */
:root{
  --bg-page:#f0f4f8;
  --bg-card:#ffffff;
  --bg-card2:#f8fafc;
  --bg-header:linear-gradient(150deg,#1e3a8a,#1a237e,#1565c0);
  --border:#e2e8f0;
  --border-strong:#cbd5e1;
  --text-primary:#1e293b;
  --text-secondary:#475569;
  --text-muted:#94a3b8;
  --accent:#1a237e;
  --accent-light:#e8edf8;
  --accent2:#1565c0;
  --danger:#c62828;
  --success:#2e7d32;
  --success-bg:#f0fdf4;
  --danger-bg:#fef2f2;
  --shadow-sm:0 1px 3px rgba(0,0,0,0.08),0 1px 2px rgba(0,0,0,0.05);
  --shadow:0 4px 16px rgba(0,0,0,0.08),0 1px 4px rgba(0,0,0,0.04);
  --shadow-lg:0 8px 32px rgba(0,0,0,0.10),0 2px 8px rgba(0,0,0,0.06);
  --radius:16px;
  --radius-sm:10px;
}

/* ‚îÄ‚îÄ INPUTS ‚îÄ‚îÄ */
.inp{
  width:100%;padding:10px 14px;
  border:1.5px solid var(--border-strong);
  border-radius:10px;font-size:13.5px;
  font-family:'Inter',sans-serif;outline:none;
  background:#fff;
  transition:all .18s cubic-bezier(.4,0,.2,1);
  color:var(--text-primary);
}
.inp:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(26,35,126,0.10);
}
.inp::placeholder{color:var(--text-muted);}
select.inp option{background:#fff;color:var(--text-primary);}

.btn{
  border:none;border-radius:10px;padding:10px 18px;font-weight:700;cursor:pointer;
  font-family:'Inter',sans-serif;font-size:13px;
  transition:all .18s cubic-bezier(.4,0,.2,1);
  letter-spacing:0.2px;
}
.btn:active{transform:scale(0.96);}
.btn-primary{background:linear-gradient(135deg,#1a237e,#1565c0);color:#fff;box-shadow:0 4px 14px rgba(26,35,126,0.28);}
.btn-primary:hover{box-shadow:0 6px 20px rgba(26,35,126,0.38);transform:translateY(-1px);}

.mi{
  width:100%;padding:5px 4px;
  border:1.5px solid var(--border);border-radius:8px;font-size:11.5px;
  text-align:center;outline:none;font-family:'Inter',sans-serif;
  background:#fff;color:var(--text-primary);
  transition:all .15s;
}
.mi:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(26,35,126,0.08);}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{
  background:var(--bg-card);
  border:1px solid var(--border);
  border-radius:var(--radius);
  box-shadow:var(--shadow-sm);
}

/* ‚îÄ‚îÄ DROPDOWN ‚îÄ‚îÄ */
.sug{
  position:absolute;left:0;right:0;top:calc(100% + 6px);
  background:#fff;
  border:1.5px solid var(--border-strong);
  border-radius:12px;z-index:400;
  box-shadow:var(--shadow-lg);
  max-height:200px;overflow-y:auto;
  animation:fadeDown .15s ease;
}
.sug-item{padding:11px 14px;cursor:pointer;font-size:13px;border-bottom:1px solid var(--border);color:var(--text-primary);}
.sug-item:hover{background:var(--accent-light);color:var(--accent);}
.sug-item:last-child{border-bottom:none;}

/* ‚îÄ‚îÄ ANIMATIONS ‚îÄ‚îÄ */
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeDown{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes popIn{from{opacity:0;transform:scale(0.88)}to{opacity:1;transform:scale(1)}}
@keyframes shakeX{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}

.fi{animation:fadeUp .28s cubic-bezier(.4,0,.2,1) both;}
.pulse{animation:pulse 1.2s infinite;}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{
  position:fixed;bottom:28px;left:50%;transform:translateX(-50%);
  background:rgba(30,41,59,0.97);
  color:#fff;padding:11px 26px;border-radius:40px;
  font-size:13px;z-index:9999;
  box-shadow:0 8px 32px rgba(0,0,0,0.2);
  white-space:nowrap;animation:fadeUp .2s ease;
  border:1px solid rgba(255,255,255,0.08);
}

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar{width:5px;}
::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:6px;}
::-webkit-scrollbar-thumb:hover{background:#94a3b8;}

/* ‚îÄ‚îÄ DESKTOP LAYOUT ‚îÄ‚îÄ */
@media(min-width:900px){
  .shell{display:flex;height:100vh;overflow:hidden;}
  .left-pane{width:480px;flex-shrink:0;overflow-y:auto;height:100vh;
    border-right:1px solid var(--border);background:var(--bg-page);}
  .right-pane{flex:1;overflow-y:auto;height:100vh;
    background:linear-gradient(160deg,#f0f4f8,#e8edf8);
    display:flex;flex-direction:column;align-items:center;padding:24px 16px;}
}
@media(max-width:899px){
  .shell,.left-pane{display:block;width:100%;min-height:100vh;background:var(--bg-page);}
  .right-pane{display:none!important;}
}

/* ‚îÄ‚îÄ PRINT ‚îÄ‚îÄ */
@media print{
  *{-webkit-print-color-adjust:exact!important;print-color-adjust:exact!important;}
  html,body{margin:0!important;padding:0!important;width:210mm!important;height:297mm!important;background:white!important;overflow:hidden!important;}
  body *{visibility:hidden!important;}
  #MARKSHEET,#MARKSHEET *{visibility:visible!important;}
  #MARKSHEET{position:fixed!important;inset:0!important;width:210mm!important;height:297mm!important;
    margin:0!important;padding:0!important;overflow:hidden!important;background:white!important;box-shadow:none!important;}
  @page{size:210mm 297mm;margin:0mm;}
  .no-print{display:none!important;}
}

/* ‚îÄ‚îÄ MENU ‚îÄ‚îÄ */
.menu-overlay{position:fixed;inset:0;z-index:200;animation:fadeIn .15s ease;}
.menu-popup{
  position:absolute;right:14px;top:52px;
  background:#fff;
  border:1.5px solid var(--border-strong);
  border-radius:14px;
  box-shadow:var(--shadow-lg);
  min-width:210px;overflow:hidden;
  animation:popIn .15s cubic-bezier(.4,0,.2,1);
  z-index:201;
}
.menu-item{
  padding:13px 16px;cursor:pointer;
  font-size:13.5px;font-weight:600;color:var(--text-primary);
  display:flex;align-items:center;gap:10px;
  border-bottom:1px solid var(--border);
  transition:background .1s;
}
.menu-item:last-child{border-bottom:none;}
.menu-item:hover{background:var(--accent-light);}

/* ‚îÄ‚îÄ STAT CHIP ‚îÄ‚îÄ */
.stat-chip{
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;padding:10px 16px;
  text-align:center;min-width:70px;
  box-shadow:var(--shadow-sm);
}

/* ‚îÄ‚îÄ SECTION ‚îÄ‚îÄ */
.section-card{
  background:#fff;
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:16px;
  box-shadow:var(--shadow-sm);
}
.section-title{font-weight:700;font-size:13px;color:var(--text-primary);margin-bottom:12px;display:flex;align-items:center;gap:6px;}

/* ‚îÄ‚îÄ LIST ITEM ‚îÄ‚îÄ */
.student-item{
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;padding:13px 15px;
  display:flex;align-items:center;gap:12px;cursor:pointer;
  transition:all .18s cubic-bezier(.4,0,.2,1);
  box-shadow:var(--shadow-sm);
}
.student-item:hover{border-color:var(--accent);box-shadow:0 4px 16px rgba(26,35,126,0.10);transform:translateY(-1px);}
</style>
</head>
<body>
<div id="root"></div>

<script>
// ‚îÄ‚îÄ FIREBASE INIT (safe) ‚îÄ‚îÄ
(function(){
  try {
    firebase.initializeApp({
      apiKey:"AIzaSyDw6lVRfXgehqpgvTCobqZZyLAy9alzAU8",
      authDomain:"sbs-marksheet.firebaseapp.com",
      projectId:"sbs-marksheet",
      storageBucket:"sbs-marksheet.firebasestorage.app",
      messagingSenderId:"1064566048496",
      appId:"1:1064566048496:web:0b7cf5d4b9fa0bf9dae435"
    });
    const db = firebase.firestore();
    db.settings({cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED});
    db.enablePersistence({synchronizeTabs:true}).catch(function(){});
    window._db = db;
  } catch(e){
    window._db = null;
  }
})();
</script>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

<script type="text/babel" data-presets="react">
const {useState,useEffect,useRef,useCallback,useMemo} = React;

/* ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ */
const APP_PASSWORD = "sbs2025";
const LS_AUTH_KEY  = "sbs_auth_v1";
const LS_KEY       = "sbs_mk_v8";

const isSessionValid = () => {
  try{
    const d = JSON.parse(localStorage.getItem(LS_AUTH_KEY)||"{}");
    return !!(d.ok && (Date.now()-d.t)<8*60*60*1000);
  }catch{return false;}
};
const saveSession  = () => { try{localStorage.setItem(LS_AUTH_KEY,JSON.stringify({ok:true,t:Date.now()}));}catch{} };
const clearSession = () => { try{localStorage.removeItem(LS_AUTH_KEY);}catch{} };

/* ‚îÄ‚îÄ‚îÄ SCHOOL ‚îÄ‚îÄ */
const SCHOOL = {
  name:"SBS SHIKSHA NIKETAN",
  addr:"Karaspur Prithvipur, Ghazipur, Uttar Pradesh ‚Äì 233226",
  logo:"logo.png",
};

/* ‚îÄ‚îÄ‚îÄ FIXED MM: T1=40, T2=60, T3=100 ‚îÄ‚îÄ */
const FIXED_MM = {m1:40, m2:60, m3:100};

const DEFAULT_SUBJECTS = ["HINDI","ENGLISH","MATHEMATICS","SCIENCE","SOCIAL SCIENCE","ART AND DRAWING","COMPUTER","G.K."];
const CLASSES = ["1","2","3","4","5","6","7","8","9","10","11","12"];
const GENDERS = ["Male","Female","Other"];

const GRADE_TABLE = [
  {min:91,max:100,g:"A1",l:"Outstanding"},
  {min:81,max:90, g:"A2",l:"Excellent"},
  {min:71,max:80, g:"B1",l:"Very Good"},
  {min:61,max:70, g:"B2",l:"Good"},
  {min:51,max:60, g:"C1",l:"Average"},
  {min:41,max:50, g:"C2",l:"Satisfactory"},
  {min:33,max:40, g:"D", l:"Pass"},
  {min:0, max:32, g:"E", l:"Fail"},
];
const grade      = p => { if(p===null||p===undefined) return "‚Äì"; for(const r of GRADE_TABLE) if(p>=r.min&&p<=r.max) return r.g; return "‚Äì"; };
const gradeLabel = p => { if(p===null||p===undefined) return "‚Äì"; for(const r of GRADE_TABLE) if(p>=r.min&&p<=r.max) return r.l; return "‚Äì"; };

const REMARK_OPTS = [
  "Excellent performance! Keep up the great work.",
  "Good effort shown. Focus more on weaker subjects.",
  "Satisfactory progress. Must work harder next term.",
  "Very good student. Regular attendance is essential.",
  "Outstanding achievement. We are proud of you!",
];
const ADDR_OPTS = [
  "Nasiruddinpur, Prithvipur, Ghazipur, U.P. 233226",
  "Prithvipur, Ghazipur, Uttar Pradesh 233226",
  "Karaspur, Prithvipur, Ghazipur, U.P. 233226",
];

/* ‚îÄ‚îÄ‚îÄ MATH ‚îÄ‚îÄ */
const safeFloat = v => { const n=parseFloat(v); return isNaN(n)?0:n; };
const subObt = s => safeFloat(s.o1)+safeFloat(s.o2)+safeFloat(s.o3);
const subMM  = () => FIXED_MM.m1+FIXED_MM.m2+FIXED_MM.m3;
const pct    = (o,m) => m>0 ? parseFloat(((o/m)*100).toFixed(1)) : null;
function grandTotals(subs){
  if(!Array.isArray(subs)) return {o1:0,o2:0,o3:0,oT:0,mT:0,m1:0,m2:0,m3:0};
  return subs.reduce((a,s)=>({
    o1:a.o1+safeFloat(s.o1),
    o2:a.o2+safeFloat(s.o2),
    o3:a.o3+safeFloat(s.o3),
    oT:a.oT+subObt(s),
    mT:a.mT+(FIXED_MM.m1+FIXED_MM.m2+FIXED_MM.m3),
    m1:a.m1+FIXED_MM.m1, m2:a.m2+FIXED_MM.m2, m3:a.m3+FIXED_MM.m3,
  }),{o1:0,o2:0,o3:0,oT:0,mT:0,m1:0,m2:0,m3:0});
}

/* ‚îÄ‚îÄ‚îÄ FIREBASE ‚îÄ‚îÄ */
const db = window._db;
const fbSave = async st => {
  if(!db) throw new Error("No DB");
  await db.collection("students").doc(String(st.id)).set(st);
  try{
    const bRef = db.collection("backups").doc(String(st.id));
    const snap = await bRef.get();
    let vers = snap.exists?(snap.data().v||[]):[];
    vers = [{...st,_at:new Date().toISOString()},...vers].slice(0,2);
    await bRef.set({v:vers});
  }catch{}
};
const fbAll  = async () => { if(!db) throw new Error("No DB"); return (await db.collection("students").get()).docs.map(d=>d.data()); };
const fbDel  = async id => { if(!db) throw new Error("No DB"); return db.collection("students").doc(String(id)).delete(); };
const fbBaks = async id => { if(!db) return []; try{ const d=await db.collection("backups").doc(String(id)).get(); return d.exists?(d.data().v||[]): []; }catch{return[];} };

/* ‚îÄ‚îÄ‚îÄ LOCAL STORAGE ‚îÄ‚îÄ */
const lsSave = d => { try{localStorage.setItem(LS_KEY,JSON.stringify(d));}catch{} };
const lsLoad = () => { try{ const r=localStorage.getItem(LS_KEY); return r?JSON.parse(r):[]; }catch{return[];} };

/* ‚îÄ‚îÄ‚îÄ NEW STUDENT ‚îÄ‚îÄ */
const newStudent = (cls="",gender="") => ({
  id:`${Date.now()}_${Math.random().toString(36).slice(2,8)}`,
  name:"",father:"",mother:"",addr:"",gender:gender,
  roll:"",admno:"",dob:"",cls:cls,sec:"",session:"2025-26",
  photo:null,
  att:{p:"",t:""},
  remark:"",rank:"",printDate:"",
  subs:DEFAULT_SUBJECTS.map(n=>({n,o1:"",o2:"",o3:""})),
  cosco:{sports:"",art:"",music:"",disc:"",clean:""},
  _created:new Date().toISOString(),
  _updated:new Date().toISOString(),
});

/* ‚îÄ‚îÄ‚îÄ ICONS ‚îÄ‚îÄ */
const Icon = {
  back:   <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="19" y1="12" x2="5" y2="12"/><polyline points="12 19 5 12 12 5"/></svg>,
  plus:   <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
  print:  <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
  trash:  <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6M14 11v6M9 6V4h6v2"/></svg>,
  search: <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
  upload: <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="16 16 12 12 8 16"/><line x1="12" y1="12" x2="12" y2="21"/><path d="M20.39 18.39A5 5 0 0 0 18 9h-1.26A8 8 0 1 0 3 16.3"/></svg>,
  hist:   <svg viewBox="0 0 24 24" width="15" height="15" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 .49-4.95"/></svg>,
  dots:   <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><circle cx="12" cy="5" r="1.5"/><circle cx="12" cy="12" r="1.5"/><circle cx="12" cy="19" r="1.5"/></svg>,
  eye:    <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
  results:<svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>,
  logout: <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
  check:  <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" strokeWidth="3"><polyline points="20 6 9 17 4 12"/></svg>,
};

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
function Toast({msg}){ return msg ? <div className="toast no-print">{msg}</div> : null; }

/* ‚îÄ‚îÄ‚îÄ LOGIN SCREEN ‚Äî Premium Light ‚îÄ‚îÄ */
function LoginScreen({onLogin, error}){
  const [pw,setPw]     = useState("");
  const [show,setShow] = useState(false);
  const [shake,setShake]=useState(false);
  const ref = useRef();
  useEffect(()=>{ const t=setTimeout(()=>ref.current&&ref.current.focus(),400); return()=>clearTimeout(t); },[]);
  const submit = () => {
    if(!pw.trim()) return;
    if(!onLogin(pw)){
      setShake(true); setTimeout(()=>setShake(false),500); setPw("");
    }
  };
  return (
    <div style={{
      minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",
      background:"linear-gradient(145deg,#e8edf8 0%,#f0f4ff 50%,#e2e8f8 100%)",
      padding:20,position:"relative",overflow:"hidden",
    }}>
      {/* Decorative blobs */}
      <div style={{position:"fixed",width:400,height:400,borderRadius:"50%",
        background:"radial-gradient(circle,rgba(26,35,126,0.07),transparent)",
        top:-120,right:-120,pointerEvents:"none"}}/>
      <div style={{position:"fixed",width:300,height:300,borderRadius:"50%",
        background:"radial-gradient(circle,rgba(21,101,192,0.06),transparent)",
        bottom:-80,left:-80,pointerEvents:"none"}}/>

      <div style={{
        maxWidth:400,width:"100%",textAlign:"center",
        background:"rgba(255,255,255,0.96)",
        backdropFilter:"blur(20px)",WebkitBackdropFilter:"blur(20px)",
        border:"1.5px solid rgba(255,255,255,0.9)",
        borderRadius:24,padding:"44px 36px",
        boxShadow:"0 20px 60px rgba(26,35,126,0.12), 0 4px 20px rgba(0,0,0,0.06)",
        animation:shake?"shakeX 0.4s ease":"slideUp 0.4s cubic-bezier(.4,0,.2,1)",
      }}>
        <div style={{
          width:80,height:80,borderRadius:22,margin:"0 auto 20px",
          background:"linear-gradient(135deg,#1a237e,#1565c0)",
          display:"flex",alignItems:"center",justifyContent:"center",
          fontSize:40,boxShadow:"0 12px 36px rgba(26,35,126,0.28)",
        }}>üè´</div>
        <div style={{fontSize:22,fontWeight:900,color:"#1e293b",fontFamily:"'Playfair Display',serif",marginBottom:4}}>
          SBS Shiksha Niketan
        </div>
        <div style={{fontSize:12.5,color:"#64748b",marginBottom:32,letterSpacing:0.4}}>
          Marksheet Management System
        </div>
        {error && (
          <div style={{background:"#fef2f2",border:"1px solid #fecaca",
            color:"#c62828",padding:"11px 16px",borderRadius:10,fontSize:13,marginBottom:18,textAlign:"left"}}>
            ‚ùå {error}
          </div>
        )}
        <div style={{position:"relative",marginBottom:14}}>
          <input ref={ref} type={show?"text":"password"} value={pw}
            onChange={e=>setPw(e.target.value)} onKeyDown={e=>e.key==="Enter"&&submit()}
            placeholder="Password daalen‚Ä¶"
            style={{
              width:"100%",padding:"13px 48px 13px 18px",
              background:"#f8fafc",
              border:"1.5px solid #cbd5e1",
              borderRadius:12,fontSize:15,color:"#1e293b",outline:"none",
              letterSpacing:show?0:4,
              transition:"all .2s",fontFamily:"'Inter',sans-serif",
            }}
            onFocus={e=>{e.target.style.borderColor="#1a237e"; e.target.style.background="#fff"; e.target.style.boxShadow="0 0 0 3px rgba(26,35,126,0.10)";}}
            onBlur={e=>{e.target.style.borderColor="#cbd5e1"; e.target.style.background="#f8fafc"; e.target.style.boxShadow="none";}}
          />
          <button onClick={()=>setShow(s=>!s)} style={{
            position:"absolute",right:14,top:"50%",transform:"translateY(-50%)",
            background:"none",border:"none",cursor:"pointer",fontSize:18,color:"#94a3b8",
          }}>{show?"üôà":"üëÅÔ∏è"}</button>
        </div>
        <button onClick={submit} className="btn btn-primary" style={{width:"100%",padding:"14px",fontSize:15,letterSpacing:0.3}}>
          üîì Login Karein
        </button>
        <div style={{marginTop:20,fontSize:11,color:"#94a3b8"}}>
          üîí Authorized access only
        </div>
      </div>
      <style>{`
        @keyframes slideUp{from{opacity:0;transform:translateY(40px)}to{opacity:1;transform:translateY(0)}}
        @keyframes shakeX{0%,100%{transform:translateX(0)}20%{transform:translateX(-8px)}40%{transform:translateX(8px)}60%{transform:translateX(-5px)}80%{transform:translateX(5px)}}
      `}</style>
    </div>
  );
}

/* ‚îÄ‚îÄ‚îÄ CLASS+GENDER SELECTOR ‚îÄ‚îÄ */
function ClassGenderSelector({onSelect}){
  const [cls,setCls]       = useState("");
  const [gender,setGender] = useState("");
  const canProceed = cls && gender;
  return (
    <div style={{
      minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",
      background:"linear-gradient(145deg,#e8edf8,#f0f4ff,#e2e8f8)",padding:20,
    }}>
      <div style={{
        maxWidth:420,width:"100%",
        background:"rgba(255,255,255,0.98)",
        border:"1.5px solid #e2e8f0",
        borderRadius:24,padding:"40px 28px",
        boxShadow:"0 20px 60px rgba(26,35,126,0.10)",
        animation:"slideUp 0.35s cubic-bezier(.4,0,.2,1)",
      }}>
        <div style={{textAlign:"center",marginBottom:28}}>
          <div style={{fontSize:36,marginBottom:10}}>üéì</div>
          <div style={{fontSize:20,fontWeight:800,color:"#1e293b",marginBottom:6}}>Naya Student</div>
          <div style={{fontSize:13,color:"#64748b"}}>Pehle class aur gender chunein</div>
        </div>

        <div style={{marginBottom:16}}>
          <div style={{fontSize:11,fontWeight:700,color:"#475569",marginBottom:8,letterSpacing:1,textTransform:"uppercase"}}>Class Chunein</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:8}}>
            {CLASSES.map(c=>(
              <button key={c} onClick={()=>setCls(c)} style={{
                padding:"11px 6px",borderRadius:10,border:`1.5px solid ${cls===c?"#1a237e":"#e2e8f0"}`,cursor:"pointer",
                fontWeight:700,fontSize:14,
                background:cls===c?"linear-gradient(135deg,#1a237e,#1565c0)":"#fff",
                color:cls===c?"#fff":"#475569",
                boxShadow:cls===c?"0 4px 14px rgba(26,35,126,0.25)":"none",
                transition:"all .15s",
              }}>{c}</button>
            ))}
          </div>
        </div>

        <div style={{marginBottom:28}}>
          <div style={{fontSize:11,fontWeight:700,color:"#475569",marginBottom:8,letterSpacing:1,textTransform:"uppercase"}}>Gender Chunein</div>
          <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:8}}>
            {GENDERS.map(g=>(
              <button key={g} onClick={()=>setGender(g)} style={{
                padding:"12px 8px",borderRadius:10,border:`1.5px solid ${gender===g?"#7b1fa2":"#e2e8f0"}`,cursor:"pointer",
                fontWeight:700,fontSize:13,
                background:gender===g?"linear-gradient(135deg,#7b1fa2,#4a148c)":"#fff",
                color:gender===g?"#fff":"#475569",
                boxShadow:gender===g?"0 4px 14px rgba(123,31,162,0.25)":"none",
                transition:"all .15s",
              }}>{g==="Male"?"üë¶":g==="Female"?"üëß":"üßë"} {g}</button>
            ))}
          </div>
        </div>

        <button onClick={()=>canProceed&&onSelect(cls,gender)} className="btn" style={{
          width:"100%",padding:"14px",fontSize:15,fontWeight:800,
          background:canProceed?"linear-gradient(135deg,#1a237e,#1565c0)":"#e2e8f0",
          color:canProceed?"#fff":"#94a3b8",
          borderRadius:12,border:"none",cursor:canProceed?"pointer":"not-allowed",
          boxShadow:canProceed?"0 6px 20px rgba(26,35,126,0.28)":"none",
          transition:"all .2s",
        }}>
          Aage Badhein ‚Üí
        </button>
      </div>
      <style>{`@keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}`}</style>
    </div>
  );
}

/* ‚îÄ‚îÄ‚îÄ SYNC BAR ‚îÄ‚îÄ */
function SyncBar({status,ts}){
  const cfg={
    synced:{c:"#16a34a",bg:"#f0fdf4",t:"Synced ‚úì"},
    syncing:{c:"#d97706",bg:"#fffbeb",t:"Saving‚Ä¶"},
    error:{c:"#dc2626",bg:"#fef2f2",t:"Sync error"},
    offline:{c:"#64748b",bg:"#f1f5f9",t:"Offline mode"},
    idle:{c:"#94a3b8",bg:"transparent",t:""}
  };
  const {c,bg,t}=cfg[status]||cfg.idle;
  if(!t) return null;
  return (
    <div style={{background:bg,borderBottom:"1px solid #e2e8f0",
      padding:"5px 16px",display:"flex",alignItems:"center",gap:7,fontSize:11.5,color:c,fontWeight:600}}>
      <span style={{width:7,height:7,borderRadius:"50%",background:c,display:"inline-block",flexShrink:0,
        animation:status==="syncing"?"pulse 1s infinite":""}}/>
      <span>{t}</span>
      {ts&&status==="synced"&&<span style={{marginLeft:"auto",color:"#94a3b8",fontWeight:400}}>{ts}</span>}
    </div>
  );
}

/* ‚îÄ‚îÄ‚îÄ RESULTS VIEWER ‚îÄ‚îÄ */
function ResultsViewer({students,onClose,onSelect}){
  const [q,setQ]=useState("");
  const [filterCls,setFilterCls]=useState("");
  const [filterGender,setFilterGender]=useState("");
  const filtered=useMemo(()=>students.filter(s=>{
    const matchQ=!q||(s.name||"").toLowerCase().includes(q.toLowerCase())||(s.roll||"").includes(q);
    const matchCls=!filterCls||s.cls===filterCls;
    const matchG=!filterGender||s.gender===filterGender;
    return matchQ&&matchCls&&matchG;
  }),[students,q,filterCls,filterGender]);
  return (
    <div className="fi" style={{paddingBottom:20,minHeight:"100vh",background:"#f0f4f8"}}>
      <div style={{
        background:"#fff",
        borderBottom:"1px solid #e2e8f0",
        padding:"14px 16px",display:"flex",alignItems:"center",gap:10,
        position:"sticky",top:0,zIndex:60,boxShadow:"0 1px 4px rgba(0,0,0,0.06)",
      }}>
        <button onClick={onClose} className="btn" style={{background:"#f1f5f9",color:"#1e293b",padding:"8px 12px",display:"flex",alignItems:"center"}}>{Icon.back}</button>
        <span style={{color:"#1e293b",fontWeight:700,fontSize:15,flex:1}}>üìä Saved Results</span>
      </div>
      <div style={{padding:"12px 14px",display:"flex",gap:8,flexWrap:"wrap"}}>
        <div style={{flex:1,minWidth:140,position:"relative"}}>
          <span style={{position:"absolute",left:11,top:"50%",transform:"translateY(-50%)",color:"#94a3b8"}}>{Icon.search}</span>
          <input value={q} onChange={e=>setQ(e.target.value)} placeholder="Naam ya roll‚Ä¶"
            className="inp" style={{paddingLeft:34}}/>
        </div>
        <select value={filterCls} onChange={e=>setFilterCls(e.target.value)} className="inp" style={{width:"auto",minWidth:120}}>
          <option value="">All Classes</option>
          {CLASSES.map(c=><option key={c} value={c}>Class {c}</option>)}
        </select>
        <select value={filterGender} onChange={e=>setFilterGender(e.target.value)} className="inp" style={{width:"auto",minWidth:110}}>
          <option value="">All Gender</option>
          {GENDERS.map(g=><option key={g} value={g}>{g}</option>)}
        </select>
      </div>
      <div style={{padding:"0 14px",display:"flex",flexDirection:"column",gap:8}}>
        {filtered.length===0?(
          <div style={{textAlign:"center",padding:"60px 20px",color:"#94a3b8"}}>
            <div style={{fontSize:40,marginBottom:10}}>üì≠</div>
            <div style={{fontWeight:600}}>Koi result nahi mila</div>
          </div>
        ):filtered.map(s=>{
          const g=grandTotals(s.subs);
          const p=g.mT>0?pct(g.oT,g.mT):null;
          const pass=p!==null&&p>=33;
          return (
            <div key={s.id} onClick={()=>onSelect(s.id)} className="student-item">
              <div style={{width:44,height:44,borderRadius:12,overflow:"hidden",
                background:"linear-gradient(135deg,#1a237e,#1565c0)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}>
                {s.photo?<img src={s.photo} style={{width:"100%",height:"100%",objectFit:"cover"}} alt=""/>:<span style={{fontSize:20}}>üë§</span>}
              </div>
              <div style={{flex:1,minWidth:0}}>
                <div style={{fontWeight:700,color:"#1e293b",fontSize:14,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{s.name||"‚Äî"}</div>
                <div style={{fontSize:11,color:"#64748b",marginTop:2}}>
                  Class {s.cls||"?"}{s.sec?"-"+s.sec:""} {s.gender?"¬∑ "+s.gender:""} {s.roll?"¬∑ Roll "+s.roll:""}
                </div>
              </div>
              {p!==null&&(
                <div style={{textAlign:"right",flexShrink:0}}>
                  <div style={{fontWeight:800,fontSize:16,color:pass?"#16a34a":"#dc2626"}}>{p}%</div>
                  <div style={{fontSize:11,background:pass?"#f0fdf4":"#fef2f2",
                    color:pass?"#16a34a":"#dc2626",padding:"2px 8px",borderRadius:20,fontWeight:700}}>{grade(p)}</div>
                </div>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
function Dashboard({students,onNew,onSelect,syncStatus,syncTs,onLogout,onViewResults}){
  const [q,setQ]=useState("");
  const [menuOpen,setMenuOpen]=useState(false);
  const filtered=useMemo(()=>students.filter(s=>
    (s.name||"").toLowerCase().includes(q.toLowerCase())||(s.roll||"").includes(q)||(s.cls||"").includes(q)
  ),[students,q]);
  const passCount=useMemo(()=>students.filter(s=>{const g=grandTotals(s.subs);return g.mT>0&&pct(g.oT,g.mT)>=33;}).length,[students]);
  const clsSet=useMemo(()=>new Set(students.map(s=>s.cls).filter(Boolean)),[students]);

  return (
    <div className="fi" style={{background:"#f0f4f8",minHeight:"100vh"}}>
      <SyncBar status={syncStatus} ts={syncTs}/>
      <div style={{padding:"14px 14px 80px"}}>

        {/* Header card */}
        <div style={{
          marginBottom:16,borderRadius:20,overflow:"hidden",position:"relative",
          background:"linear-gradient(150deg,#1e3a8a,#1a237e,#1565c0)",
          padding:"22px 18px 20px",
          boxShadow:"0 8px 32px rgba(26,35,126,0.25)",
        }}>
          {/* Decorative circles */}
          <div style={{position:"absolute",width:160,height:160,borderRadius:"50%",
            background:"rgba(255,255,255,0.05)",top:-50,right:-40,pointerEvents:"none"}}/>
          <div style={{position:"absolute",width:100,height:100,borderRadius:"50%",
            background:"rgba(255,255,255,0.04)",bottom:-30,left:-20,pointerEvents:"none"}}/>

          {/* Three dot menu ‚Äî BUG FIXED: removed duplicate onClick, removed undefined handleLogout */}
          <div style={{position:"absolute",top:14,right:14,zIndex:10}}>
            <button onClick={()=>setMenuOpen(m=>!m)} style={{
              background:"rgba(255,255,255,0.15)",border:"1px solid rgba(255,255,255,0.2)",
              color:"#fff",borderRadius:10,width:36,height:36,cursor:"pointer",
              display:"flex",alignItems:"center",justifyContent:"center",
            }}>{Icon.dots}</button>
            {menuOpen&&(
              <>
                <div className="menu-overlay" onClick={()=>setMenuOpen(false)}/>
                <div className="menu-popup">
                  <div className="menu-item" onClick={()=>{onViewResults();setMenuOpen(false);}}>
                    {Icon.results} <span>Saved Results Dekhein</span>
                  </div>
                  <div className="menu-item" onClick={()=>{setMenuOpen(false);onLogout();}} style={{color:"#c62828"}}>
                    {Icon.logout} <span>Logout</span>
                  </div>
                </div>
              </>
            )}
          </div>

          <div style={{fontSize:10,letterSpacing:3,color:"rgba(255,255,255,0.55)",fontWeight:700,marginBottom:3,textTransform:"uppercase"}}>School Management System</div>
          <div style={{fontSize:22,fontWeight:900,color:"#fff",fontFamily:"'Playfair Display',serif",lineHeight:1.2,marginBottom:2}}>{SCHOOL.name}</div>
          <div style={{fontSize:10,color:"rgba(255,255,255,0.55)",marginBottom:16}}>{SCHOOL.addr}</div>

          <div style={{display:"flex",gap:10,flexWrap:"wrap"}}>
            {[
              {v:students.length,l:"Students",c:"#fff"},
              {v:passCount,l:"Passed",c:"#86efac"},
              {v:clsSet.size,l:"Classes",c:"#fde68a"},
              {v:students.length-passCount,l:"Pending",c:"#fca5a5"},
            ].map(({v,l,c})=>(
              <div key={l} style={{background:"rgba(255,255,255,0.12)",backdropFilter:"blur(10px)",
                border:"1px solid rgba(255,255,255,0.18)",borderRadius:14,padding:"9px 16px",textAlign:"center",minWidth:66}}>
                <div style={{fontSize:22,fontWeight:900,color:c}}>{v}</div>
                <div style={{fontSize:10,color:"rgba(255,255,255,0.55)"}}>{l}</div>
              </div>
            ))}
          </div>
        </div>

        {/* Search + New */}
        <div style={{display:"flex",gap:10,marginBottom:14}}>
          <div style={{flex:1,position:"relative"}}>
            <span style={{position:"absolute",left:12,top:"50%",transform:"translateY(-50%)",color:"#94a3b8"}}>{Icon.search}</span>
            <input value={q} onChange={e=>setQ(e.target.value)} placeholder="Naam, class ya roll‚Ä¶"
              className="inp" style={{paddingLeft:36}}/>
          </div>
          <button onClick={onNew} className="btn btn-primary" style={{
            display:"flex",alignItems:"center",gap:7,whiteSpace:"nowrap",padding:"10px 18px",
          }}>
            {Icon.plus} Naya
          </button>
        </div>

        {/* Student List */}
        {filtered.length===0?(
          <div style={{textAlign:"center",padding:"60px 20px",color:"#94a3b8"}}>
            <div style={{fontSize:50,marginBottom:10}}>üìã</div>
            <div style={{fontWeight:600,fontSize:15,color:"#475569"}}>{q?"Koi student nahi mila":"Abhi koi student nahi"}</div>
            <div style={{fontSize:12,marginTop:5}}>{q?"Dusra naam try karein":'Naya tap karein'}</div>
          </div>
        ):(
          <div style={{display:"flex",flexDirection:"column",gap:8}}>
            {filtered.map(s=>{
              const g=grandTotals(s.subs);
              const p=g.mT>0?pct(g.oT,g.mT):null;
              const pass=p!==null&&p>=33;
              return (
                <div key={s.id} onClick={()=>onSelect(s.id)} className="student-item">
                  <div style={{width:48,height:48,borderRadius:14,overflow:"hidden",
                    background:"linear-gradient(135deg,#1a237e,#1565c0)",flexShrink:0,
                    display:"flex",alignItems:"center",justifyContent:"center"}}>
                    {s.photo?<img src={s.photo} style={{width:"100%",height:"100%",objectFit:"cover"}} alt=""/>:<span style={{fontSize:22}}>üë§</span>}
                  </div>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontWeight:700,fontSize:14,color:"#1e293b",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>
                      {s.name||"Naam nahi diya"}
                    </div>
                    <div style={{fontSize:11,color:"#64748b",marginTop:2}}>
                      Class <b style={{color:"#475569"}}>{s.cls||"?"}{s.sec?"-"+s.sec:""}</b>
                      {s.gender&&<> ¬∑ {s.gender}</>}
                      {s.roll&&<> ¬∑ Roll <b style={{color:"#475569"}}>{s.roll}</b></>}
                    </div>
                  </div>
                  {p!==null&&(
                    <div style={{textAlign:"right",flexShrink:0}}>
                      <div style={{fontWeight:800,fontSize:16,color:pass?"#16a34a":"#dc2626"}}>{p}%</div>
                      <div style={{fontSize:11,background:pass?"#f0fdf4":"#fef2f2",
                        color:pass?"#16a34a":"#dc2626",padding:"2px 9px",borderRadius:20,fontWeight:700}}>{grade(p)}</div>
                    </div>
                  )}
                  <div style={{color:"#cbd5e1",fontSize:18}}>‚Ä∫</div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ‚îÄ EDITOR ‚îÄ‚îÄ */
function Editor({student,onSave,onBack,onPrint,onDelete,showToast}){
  const [s,setS]=useState(()=>{try{return JSON.parse(JSON.stringify(student));}catch{return student;}});
  const [baks,setBaks]=useState([]);
  const [showBaks,setShowBaks]=useState(false);
  const [addrOpen,setAddrOpen]=useState(false);
  const [remOpen,setRemOpen]=useState(false);
  const photoRef=useRef();
  const timer=useRef();
  const sRef=useRef(s);
  sRef.current=s;

  // Auto-save with debounce ‚Äî BUG FIXED: use ref to avoid stale closure
  useEffect(()=>{
    clearTimeout(timer.current);
    timer.current=setTimeout(()=>onSave(sRef.current),1500);
    return()=>clearTimeout(timer.current);
  },[s]);

  const upd=(k,v)=>setS(p=>({...p,[k]:v,_updated:new Date().toISOString()}));
  const updSub=(i,k,v)=>{
    setS(p=>{const a=[...p.subs];a[i]={...a[i],[k]:v};return{...p,subs:a,_updated:new Date().toISOString()};});
  };
  const clamp=(v,max)=>{
    if(v===""||v==="-") return "";
    let n=parseFloat(v); if(isNaN(n)) return "";
    if(n<0) n=0; if(n>max) n=max;
    return String(Math.round(n*10)/10);
  };
  const handlePhoto=e=>{
    const f=e.target.files&&e.target.files[0]; if(!f) return;
    if(f.size>800000){showToast("‚ö†Ô∏è Image 800KB se zyada hai"); return;}
    const r=new FileReader();
    r.onload=ev=>setS(p=>({...p,photo:ev.target.result}));
    r.readAsDataURL(f);
  };
  const loadBaks=async()=>{
    try{const b=await fbBaks(s.id);setBaks(b||[]);setShowBaks(true);}
    catch{showToast("‚ö†Ô∏è Backup load nahi hua");}
  };

  const gt=grandTotals(s.subs);
  const op=gt.mT>0?pct(gt.oT,gt.mT):null;
  const pass=op!==null&&op>=33;
  const attPct=s.att&&s.att.p&&s.att.t&&parseFloat(s.att.t)>0
    ?((parseFloat(s.att.p)/parseFloat(s.att.t))*100).toFixed(0)+"%":"";
  const addrMatches=ADDR_OPTS.filter(a=>a.toLowerCase().includes((s.addr||"").toLowerCase())&&(s.addr||"").length>0);

  const Section=({title,children})=>(
    <div className="section-card">
      <div className="section-title">{title}</div>
      {children}
    </div>
  );

  return (
    <div className="fi" style={{background:"#f0f4f8",minHeight:"100vh",paddingBottom:90}}>
      {/* Top bar */}
      <div style={{
        background:"#fff",
        borderBottom:"1px solid #e2e8f0",
        padding:"12px 14px",display:"flex",alignItems:"center",gap:10,
        position:"sticky",top:0,zIndex:60,
        boxShadow:"0 1px 6px rgba(0,0,0,0.06)",
      }}>
        <button onClick={onBack} className="btn" style={{background:"#f1f5f9",color:"#1e293b",padding:"8px 12px",display:"flex",alignItems:"center"}}>{Icon.back}</button>
        <div style={{flex:1,overflow:"hidden"}}>
          <div style={{color:"#1e293b",fontWeight:700,fontSize:14,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>
            {s.name||"Naya Student"}
          </div>
          <div style={{color:"#64748b",fontSize:11}}>
            {s.cls?"Class "+s.cls+(s.sec?"-"+s.sec:""):""}{s.session?" ¬∑ "+s.session:""}
          </div>
        </div>
        <button onClick={loadBaks} className="btn" style={{background:"#f1f5f9",color:"#475569",padding:"8px 12px",display:"flex",alignItems:"center",gap:5,fontSize:11}} title="History">
          {Icon.hist}
        </button>
        <button onClick={()=>{onSave(s);onPrint(s);}} className="btn" style={{
          background:"linear-gradient(135deg,#c62828,#e53935)",color:"#fff",
          display:"flex",alignItems:"center",gap:6,
          boxShadow:"0 4px 14px rgba(198,40,40,0.28)",
        }}>
          {Icon.print} Print
        </button>
      </div>

      <div style={{padding:"14px",display:"flex",flexDirection:"column",gap:12}}>

        {/* Score banner */}
        {op!==null&&(
          <div style={{
            background:pass?"linear-gradient(135deg,#f0fdf4,#dcfce7)":"linear-gradient(135deg,#fef2f2,#fee2e2)",
            border:`1.5px solid ${pass?"#86efac":"#fca5a5"}`,
            borderRadius:16,padding:"14px 18px",
            display:"flex",justifyContent:"space-between",alignItems:"center",
            boxShadow:pass?"0 4px 16px rgba(22,163,74,0.10)":"0 4px 16px rgba(220,38,38,0.10)",
          }}>
            <div>
              <div style={{fontSize:11,color:"#64748b",fontWeight:600}}>Overall Score</div>
              <div style={{fontSize:22,fontWeight:800,color:pass?"#16a34a":"#dc2626"}}>{gt.oT} / {gt.mT}</div>
            </div>
            <div style={{textAlign:"right"}}>
              <div style={{fontSize:30,fontWeight:900,color:pass?"#16a34a":"#dc2626",lineHeight:1}}>{op}%</div>
              <div style={{background:pass?"rgba(22,163,74,0.12)":"rgba(220,38,38,0.12)",
                color:pass?"#16a34a":"#dc2626",padding:"3px 13px",borderRadius:20,fontSize:12,fontWeight:700,marginTop:3}}>
                {grade(op)} ‚Äî {gradeLabel(op)}
              </div>
            </div>
          </div>
        )}

        {/* Backups */}
        {showBaks&&(
          <Section title="üìÇ Cloud Backups">
            <button onClick={()=>setShowBaks(false)} style={{float:"right",background:"none",border:"none",cursor:"pointer",fontSize:18,color:"#94a3b8"}}>‚úï</button>
            {baks.length===0
              ?<div style={{color:"#94a3b8",fontSize:13}}>Koi backup nahi</div>
              :baks.map((b,i)=>(
                <div key={i} style={{border:"1px solid #e2e8f0",borderRadius:12,padding:"10px 13px",marginBottom:8,display:"flex",justifyContent:"space-between",alignItems:"center",background:"#f8fafc"}}>
                  <div>
                    <div style={{fontWeight:600,fontSize:13,color:"#1e293b"}}>{i===0?"üïê Latest":"üïë Previous"}</div>
                    <div style={{fontSize:11,color:"#64748b"}}>{b._at?new Date(b._at).toLocaleString("en-IN"):""}</div>
                  </div>
                  <button onClick={()=>{setS({...b,_updated:new Date().toISOString()});setShowBaks(false);showToast("‚úÖ Restored!");}}
                    className="btn" style={{background:"#e8edf8",color:"#1a237e",padding:"6px 14px",fontSize:12,border:"1px solid #c7d2f0"}}>Restore</button>
                </div>
              ))
            }
          </Section>
        )}

        {/* Student Info */}
        <Section title="üë§ Student Information">
          <div style={{display:"flex",gap:12,marginBottom:12}}>
            <div onClick={()=>photoRef.current&&photoRef.current.click()} style={{
              width:80,height:96,border:"2px dashed #93c5fd",borderRadius:14,cursor:"pointer",
              overflow:"hidden",background:"#eff6ff",display:"flex",flexDirection:"column",
              alignItems:"center",justifyContent:"center",flexShrink:0,gap:4,transition:"all .2s",
            }}
            onMouseEnter={e=>{e.currentTarget.style.borderColor="#3b82f6"; e.currentTarget.style.background="#dbeafe";}}
            onMouseLeave={e=>{e.currentTarget.style.borderColor="#93c5fd"; e.currentTarget.style.background="#eff6ff";}}>
              {s.photo?<img src={s.photo} style={{width:"100%",height:"100%",objectFit:"cover"}} alt=""/>
                :<>{Icon.upload}<span style={{fontSize:10,color:"#64748b",textAlign:"center"}}>Photo<br/><span style={{fontSize:9}}>max 800KB</span></span></>}
            </div>
            <input ref={photoRef} type="file" accept="image/*" style={{display:"none"}} onChange={handlePhoto}/>
            <div style={{flex:1,display:"flex",flexDirection:"column",gap:8}}>
              <input className="inp" placeholder="Student Full Name *" value={s.name||""} onChange={e=>upd("name",e.target.value)}/>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
                <div style={{background:"#f0f4f8",border:"1.5px solid #e2e8f0",borderRadius:10,padding:"9px 14px",fontSize:13,color:"#475569"}}>
                  Class: <strong style={{color:"#1a237e"}}>{s.cls||"‚Äî"}</strong>
                </div>
                <input className="inp" placeholder="Section (A/B)" value={s.sec||""} onChange={e=>upd("sec",e.target.value)}/>
              </div>
            </div>
          </div>
          {/* Gender */}
          <div style={{marginBottom:8}}>
            <div style={{fontSize:11,color:"#64748b",marginBottom:6,fontWeight:600}}>Gender</div>
            <div style={{display:"flex",gap:8}}>
              {GENDERS.map(g=>(
                <button key={g} onClick={()=>upd("gender",g)} style={{
                  padding:"7px 16px",borderRadius:10,border:`1.5px solid ${s.gender===g?"#7b1fa2":"#e2e8f0"}`,cursor:"pointer",fontSize:12,fontWeight:600,
                  background:s.gender===g?"linear-gradient(135deg,#7b1fa2,#4a148c)":"#fff",
                  color:s.gender===g?"#fff":"#475569",
                  transition:"all .15s",
                }}>{g}</button>
              ))}
            </div>
          </div>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            {[["Father's Name","father"],["Mother's Name","mother"],["Roll No.","roll"],["Admission No.","admno"],["Session","session"]].map(([pl,key])=>(
              <input key={key} className="inp" placeholder={pl} value={s[key]||""} onChange={e=>upd(key,e.target.value)}/>
            ))}
            <input className="inp" type="date" value={s.dob||""}
              min="1999-01-01" max={new Date().toISOString().split("T")[0]}
              onChange={e=>upd("dob",e.target.value)}/>
            <div style={{gridColumn:"span 2",position:"relative"}}>
              <input className="inp" placeholder="Address" value={s.addr||""}
                onChange={e=>{upd("addr",e.target.value);setAddrOpen(true);}}
                onFocus={()=>setAddrOpen(true)} onBlur={()=>setTimeout(()=>setAddrOpen(false),200)}/>
              {addrOpen&&addrMatches.length>0&&(
                <div className="sug">
                  {addrMatches.map((a,i)=><div key={i} className="sug-item" onMouseDown={()=>{upd("addr",a);setAddrOpen(false);}}>üìç {a}</div>)}
                </div>
              )}
            </div>
          </div>
        </Section>

        {/* Attendance */}
        <Section title="üìÖ Haaziri (Attendance)">
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            {[["Haazir Din","p","e.g. 210"],["Kul Kaarya Diwas","t","e.g. 240"]].map(([lbl,key,ph])=>(
              <div key={key}>
                <label style={{fontSize:11,color:"#64748b",display:"block",marginBottom:4,fontWeight:600}}>{lbl}</label>
                <input className="inp" type="number" min="0" placeholder={ph}
                  value={(s.att&&s.att[key])||""}
                  onChange={e=>setS(p=>({...p,att:{...(p.att||{}),p:p.att&&p.att.p||"",[key]:e.target.value}}))}/>
              </div>
            ))}
          </div>
          {attPct&&<div style={{marginTop:8,fontSize:12,color:"#16a34a",fontWeight:600,background:"#f0fdf4",border:"1px solid #86efac",padding:"7px 12px",borderRadius:10,display:"inline-flex",alignItems:"center",gap:5}}>{Icon.check} Haaziri: {attPct}</div>}
        </Section>

        {/* Marks */}
        <Section title="üìä Marks ‚Äî T1: 40 | T2: 60 | T3: 100">
          <div style={{overflowX:"auto",WebkitOverflowScrolling:"touch"}}>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:11,minWidth:420}}>
              <thead>
                <tr style={{background:"#e8edf8",borderRadius:8}}>
                  <th style={{padding:"8px 6px",textAlign:"left",color:"#1a237e",minWidth:90,borderRadius:"8px 0 0 8px",fontSize:12}}>Subject</th>
                  <th style={{padding:6,color:"#1565c0",fontSize:10,fontWeight:700}}>T1 /40</th>
                  <th style={{padding:6,color:"#1565c0",fontSize:10,fontWeight:700}}>T2 /60</th>
                  <th style={{padding:6,color:"#1565c0",fontSize:10,fontWeight:700}}>T3 /100</th>
                  <th style={{padding:6,color:"#c62828",fontSize:10,fontWeight:700}}>Total</th>
                  <th style={{padding:6,color:"#475569",fontSize:10,fontWeight:700}}>%</th>
                  <th style={{padding:6,color:"#475569",fontSize:10,fontWeight:700}}>Grade</th>
                  <th style={{width:22}}></th>
                </tr>
              </thead>
              <tbody>
                {s.subs.map((sub,i)=>{
                  const tot=subObt(sub);
                  const mm=FIXED_MM.m1+FIXED_MM.m2+FIXED_MM.m3;
                  const p=pct(tot,mm);
                  const pass=p!==null&&p>=33;
                  return (
                    <tr key={i} style={{borderBottom:"1px solid #f1f5f9",background:i%2===0?"#fff":"#f8fafc"}}>
                      <td style={{padding:"3px 2px"}}>
                        <input className="mi" style={{textAlign:"left",fontWeight:600,minWidth:80}}
                          value={sub.n} onChange={e=>updSub(i,"n",e.target.value)} placeholder="Subject"/>
                      </td>
                      <td style={{padding:"3px 2px"}}><input className="mi" style={{width:38,background:"#eff6ff",borderColor:"#bfdbfe"}} value={sub.o1} onChange={e=>updSub(i,"o1",clamp(e.target.value,40))} placeholder="‚Äî"/></td>
                      <td style={{padding:"3px 2px"}}><input className="mi" style={{width:38,background:"#eff6ff",borderColor:"#bfdbfe"}} value={sub.o2} onChange={e=>updSub(i,"o2",clamp(e.target.value,60))} placeholder="‚Äî"/></td>
                      <td style={{padding:"3px 2px"}}><input className="mi" style={{width:38,background:"#eff6ff",borderColor:"#bfdbfe"}} value={sub.o3} onChange={e=>updSub(i,"o3",clamp(e.target.value,100))} placeholder="‚Äî"/></td>
                      <td style={{padding:"3px 4px",fontWeight:700,color:"#c62828",textAlign:"center"}}>{mm>0?tot:""}</td>
                      <td style={{padding:"3px 4px",textAlign:"center",fontWeight:600,color:pass?"#16a34a":"#dc2626",fontSize:10}}>{p!==null?p+"%":""}</td>
                      <td style={{padding:"3px 4px",textAlign:"center"}}>
                        {p!==null&&<span style={{background:pass?"#f0fdf4":"#fef2f2",color:pass?"#16a34a":"#dc2626",padding:"1px 6px",borderRadius:8,fontSize:10,fontWeight:700}}>{grade(p)}</span>}
                      </td>
                      <td><button onClick={()=>setS(p=>({...p,subs:p.subs.filter((_,j)=>j!==i)}))} style={{background:"none",border:"none",cursor:"pointer",color:"#fca5a5",padding:2}}>{Icon.trash}</button></td>
                    </tr>
                  );
                })}
                <tr style={{background:"#e8edf8",fontWeight:800,fontSize:11}}>
                  <td style={{padding:"7px 6px",color:"#1a237e",fontWeight:900}}>TOTAL</td>
                  <td style={{textAlign:"center",color:"#1565c0"}}>{gt.o1}</td>
                  <td style={{textAlign:"center",color:"#1565c0"}}>{gt.o2}</td>
                  <td style={{textAlign:"center",color:"#1565c0"}}>{gt.o3}</td>
                  <td style={{textAlign:"center",color:"#c62828"}}>{gt.oT}/{gt.mT}</td>
                  <td style={{textAlign:"center",color:pass?"#16a34a":"#dc2626"}}>{op!==null?op+"%":""}</td>
                  <td style={{textAlign:"center"}}><span style={{background:"#e8edf8",color:"#1a237e",padding:"1px 7px",borderRadius:8,fontSize:10}}>{op!==null?grade(op):""}</span></td>
                  <td></td>
                </tr>
              </tbody>
            </table>
          </div>
          <button onClick={()=>setS(p=>({...p,subs:[...p.subs,{n:"",o1:"",o2:"",o3:""}]}))} className="btn"
            style={{marginTop:10,background:"#e8edf8",color:"#1a237e",border:"1px solid #c7d2f0",fontSize:12,padding:"7px 16px"}}>
            + Subject Add Karein
          </button>
        </Section>

        {/* Co-Scholastic */}
        <Section title="üé® Co-Scholastic Activities">
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
            {[["sports","‚öΩ Sports & Games"],["art","üé® Art & Craft"],["music","üéµ Music & Dance"],["disc","üìê Discipline"],["clean","‚ú® Cleanliness"]].map(([k,lbl])=>(
              <div key={k}>
                <label style={{fontSize:11,color:"#64748b",display:"block",marginBottom:3,fontWeight:600}}>{lbl}</label>
                <select className="inp" value={(s.cosco&&s.cosco[k])||""} onChange={e=>setS(p=>({...p,cosco:{...(p.cosco||{}),sports:"",art:"",music:"",disc:"",clean:"",...(p.cosco||{}),[k]:e.target.value}}))}>
                  <option value="">‚Äî Chunein ‚Äî</option>
                  {["A+","A","B+","B","C"].map(g=><option key={g} value={g}>{g}</option>)}
                </select>
              </div>
            ))}
          </div>
        </Section>

        {/* Remarks */}
        <Section title="‚úèÔ∏è Remarks & Result">
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:10}}>
            <div>
              <label style={{fontSize:11,color:"#64748b",display:"block",marginBottom:4,fontWeight:600}}>Class Rank</label>
              <input className="inp" placeholder="e.g. 3" value={s.rank||""} onChange={e=>upd("rank",e.target.value)}/>
            </div>
            <div>
              <label style={{fontSize:11,color:"#64748b",display:"block",marginBottom:4,fontWeight:600}}>Print Date</label>
              <input className="inp" type="date" value={s.printDate||""} onChange={e=>upd("printDate",e.target.value)}/>
            </div>
          </div>
          <label style={{fontSize:11,color:"#64748b",display:"block",marginBottom:4,fontWeight:600}}>Teacher's Remark</label>
          <div style={{position:"relative"}}>
            <textarea className="inp" rows={2} value={s.remark||""} placeholder="Remark likhein ya neeche se chunein‚Ä¶"
              onChange={e=>upd("remark",e.target.value)}
              onFocus={()=>setRemOpen(true)} onBlur={()=>setTimeout(()=>setRemOpen(false),200)}
              style={{resize:"none"}}/>
            {remOpen&&(
              <div className="sug">
                {REMARK_OPTS.map((r,i)=>(
                  <div key={i} className="sug-item" onMouseDown={()=>{upd("remark",r);setRemOpen(false);}}>üí¨ {r}</div>
                ))}
              </div>
            )}
          </div>
        </Section>

        <button onClick={onDelete} className="btn" style={{width:"100%",background:"#fef2f2",color:"#dc2626",border:"1.5px solid #fca5a5",fontSize:13,padding:12,fontWeight:700}}>
          üóëÔ∏è Delete Student
        </button>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ‚îÄ PRINT VIEW ‚îÄ‚îÄ */
function PrintView({student:s, onClose}){
  const gt=grandTotals(s.subs);
  const op=gt.mT>0?pct(gt.oT,gt.mT):null;
  const attDisp=s.att&&s.att.p&&s.att.t&&parseFloat(s.att.t)>0
    ?((parseFloat(s.att.p)/parseFloat(s.att.t))*100).toFixed(0)+"%"
    :(s.att&&s.att.p?s.att.p+" din":"");
  const t1p=gt.m1>0?((gt.o1/gt.m1)*100).toFixed(0)+"%":"";
  const t2p=gt.m2>0?((gt.o2/gt.m2)*100).toFixed(0)+"%":"";
  const t3p=gt.m3>0?((gt.o3/gt.m3)*100).toFixed(0)+"%":"";
  const border="1px solid #000";
  const headerBg="#fce4d6";
  const infoTeal="#d1eeee";
  const printDateStr = s.printDate
    ? new Date(s.printDate).toLocaleDateString("en-IN",{day:"2-digit",month:"2-digit",year:"numeric"})
    : "";

  return (
    <div className="fi">
      <div className="no-print" style={{background:"#1a237e",padding:"12px 15px",display:"flex",alignItems:"center",gap:10,position:"sticky",top:0,zIndex:60}}>
        <button onClick={onClose} className="btn" style={{background:"rgba(255,255,255,.15)",color:"#fff",display:"flex",alignItems:"center",gap:6}}>{Icon.back} Back</button>
        <div style={{flex:1,color:"#fff",fontWeight:600,fontSize:13,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{s.name} ‚Äî Preview</div>
        <button onClick={()=>window.print()} className="btn" style={{background:"#c62828",color:"#fff",display:"flex",alignItems:"center",gap:6}}>{Icon.print} Print / PDF</button>
      </div>
      <div className="no-print" style={{background:"#fff8e1",padding:"7px 15px",fontSize:12,color:"#e65100",textAlign:"center"}}>
        üí° Chrome ‚Üí Print ‚Üí Margins: None ‚Üí Background graphics: ON ‚Üí Save as PDF
      </div>

      <div id="MARKSHEET" style={{
        width:"210mm",height:"297mm",background:"white",margin:"0 auto",
        padding:"2.5mm",boxSizing:"border-box",overflow:"hidden",
        fontFamily:"Arial,Helvetica,sans-serif",display:"flex",flexDirection:"column",
      }}>
        <div style={{border:"3.5px solid #c62828",flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
          <div style={{border:"1px solid #000",margin:"2px",flex:1,padding:"5px 7px",display:"flex",flexDirection:"column",overflow:"hidden"}}>

            {/* HEADER */}
            <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:6}}>
              <div style={{width:92,height:92,overflow:"hidden",flexShrink:0,display:"flex",alignItems:"center",justifyContent:"center",marginLeft:2}}>
                <img src={SCHOOL.logo} alt="" style={{width:"100%",height:"100%",objectFit:"contain"}} onError={e=>{e.target.style.display="none";}}/>
              </div>
              <div style={{flex:1,textAlign:"center",padding:"0 4px"}}>
                <div style={{fontSize:26,fontWeight:900,color:"#c62828",fontFamily:'"Times New Roman",Times,serif',textTransform:"uppercase",letterSpacing:0.5,lineHeight:1.1}}>
                  {SCHOOL.name}
                </div>
                <div style={{fontSize:11,fontWeight:600,color:"#333",marginTop:2,letterSpacing:0.3}}>
                  {SCHOOL.addr}
                </div>
                <div style={{display:"inline-block",background:"linear-gradient(90deg,#fff3e0,#ffff00,#fff3e0)",
                  color:"#b71c1c",padding:"3px 22px",fontWeight:900,fontSize:12,
                  border:"1.2px solid #c62828",borderRadius:2,
                  textDecoration:"underline",marginTop:5,marginBottom:4,letterSpacing:0.5}}>
                  PROGRESS EVALUATION REPORT
                </div>
                <div style={{fontSize:10.5,fontWeight:700,color:"#1a237e",lineHeight:1.5}}>
                  ACADEMIC SESSION :&nbsp;
                  <span style={{color:"#000",fontFamily:'"Times New Roman",serif',fontWeight:900}}>{s.session}</span>
                </div>
                <div style={{fontSize:13,fontWeight:900,color:"#000",fontFamily:'"Times New Roman",Times,serif',lineHeight:1.3}}>
                  CLASS :&nbsp;{s.cls}{s.sec?"-"+s.sec:""}
                </div>
              </div>
              <div style={{width:74,height:90,border:"1.5px solid #555",overflow:"hidden",flexShrink:0,
                background:"#f0f0f0",display:"flex",alignItems:"center",justifyContent:"center",
                marginTop:18,marginRight:3,boxShadow:"1px 1px 4px rgba(0,0,0,0.12)"}}>
                {s.photo?<img src={s.photo} style={{width:"100%",height:"100%",objectFit:"cover"}} alt=""/>
                  :<div style={{textAlign:"center"}}><div style={{fontSize:18,color:"#bbb"}}>üë§</div><span style={{fontSize:7,color:"#bbb"}}>Student<br/>Photo</span></div>}
              </div>
            </div>

            {/* STUDENT INFO */}
            <div style={{background:infoTeal,borderTop:"2px solid #000",borderBottom:"2px solid #000",
              padding:"6px 9px",fontFamily:'"Times New Roman",Times,serif',fontSize:10,fontWeight:700,marginBottom:5}}>
              <div style={{display:"grid",gridTemplateColumns:"57% 43%"}}>
                <div style={{display:"flex",flexDirection:"column",gap:3.5,paddingRight:8}}>
                  {[
                    ["STUDENT'S NAME",(s.name||"").toUpperCase()],
                    ["MOTHER'S NAME", (s.mother||"").toUpperCase()],
                    ["FATHER'S NAME", (s.father||"").toUpperCase()],
                    ["GENDER",        (s.gender||"").toUpperCase()],
                    ["ADDRESS",       (s.addr||"").toUpperCase()],
                  ].map(([label,val])=>(
                    <div key={label} style={{display:"flex",alignItems:"flex-start",minHeight:15}}>
                      <span style={{width:115,flexShrink:0,fontSize:9.5,fontWeight:700}}>{label}</span>
                      <span style={{marginRight:4,fontWeight:900}}>:</span>
                      <span style={{flex:1,fontSize:9.5,wordBreak:"break-word",lineHeight:1.3}}>{val}</span>
                    </div>
                  ))}
                </div>
                <div style={{display:"flex",flexDirection:"column",gap:3.5,paddingLeft:9}}>
                  {[
                    ["ROLL NO.",      s.roll||""],
                    ["ADMISSION NO.", s.admno||""],
                    ["DATE OF BIRTH", s.dob||""],
                  ].map(([label,val])=>(
                    <div key={label} style={{display:"flex",alignItems:"center",minHeight:15}}>
                      <span style={{width:105,flexShrink:0,fontSize:9.5,fontWeight:700}}>{label}</span>
                      <span style={{marginRight:4,fontWeight:900}}>:</span>
                      <span style={{fontSize:9.5,fontWeight:900}}>{val}</span>
                    </div>
                  ))}
                </div>
              </div>
            </div>

            {/* MARKS TABLE */}
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:9.5,tableLayout:"fixed",marginBottom:5}}>
              <colgroup>
                <col style={{width:"21%"}}/>
                <col style={{width:"5.5%"}}/><col style={{width:"8%"}}/>
                <col style={{width:"5.5%"}}/><col style={{width:"8%"}}/>
                <col style={{width:"5.5%"}}/><col style={{width:"8%"}}/>
                <col style={{width:"5.5%"}}/><col style={{width:"9%"}}/>
                <col style={{width:"7%"}}/>
              </colgroup>
              <thead>
                <tr style={{background:headerBg,height:24}}>
                  <th rowSpan={2} style={{border,textAlign:"left",paddingLeft:4,fontWeight:800,fontSize:10,verticalAlign:"middle"}}>SUBJECTS</th>
                  <th colSpan={2} style={{border,color:"#1a237e",fontWeight:700,fontSize:9,textAlign:"center"}}>FIRST TERM (40)</th>
                  <th colSpan={2} style={{border,color:"#1a237e",fontWeight:700,fontSize:9,textAlign:"center"}}>SECOND TERM (60)</th>
                  <th colSpan={2} style={{border,color:"#1a237e",fontWeight:700,fontSize:9,textAlign:"center"}}>THIRD TERM (100)</th>
                  <th colSpan={2} style={{border,color:"#1a237e",fontWeight:700,fontSize:9,textAlign:"center"}}>GRAND TOTAL</th>
                  <th rowSpan={2} style={{border,fontWeight:700,fontSize:9,textAlign:"center",verticalAlign:"middle"}}>GRADE</th>
                </tr>
                <tr style={{background:headerBg,height:18}}>
                  {["MM","MARKS OBT","MM","MARKS OBT","MM","MARKS OBT","MM","TOTAL"].map((h,i)=>(
                    <th key={i} style={{border,color:i%2===0?"#0070c0":"#222",fontWeight:700,fontSize:8,textAlign:"center",padding:"1px"}}>{h}</th>
                  ))}
                </tr>
              </thead>
              <tbody>
                {s.subs.map((sub,i)=>{
                  const tot=subObt(sub);
                  const p=pct(tot,200);
                  const pass=p!==null&&p>=33;
                  return (
                    <tr key={i} style={{height:23,background:i%2===0?"#fff":"#f7f7fc"}}>
                      <td style={{border,paddingLeft:4,fontWeight:700,textTransform:"uppercase",fontSize:9.5,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{sub.n}</td>
                      <td style={{border,textAlign:"center",color:"#0070c0",fontWeight:700,fontSize:9}}>{FIXED_MM.m1}</td>
                      <td style={{border,textAlign:"center",fontWeight:600}}>{sub.o1}</td>
                      <td style={{border,textAlign:"center",color:"#0070c0",fontWeight:700,fontSize:9}}>{FIXED_MM.m2}</td>
                      <td style={{border,textAlign:"center",fontWeight:600}}>{sub.o2}</td>
                      <td style={{border,textAlign:"center",color:"#0070c0",fontWeight:700,fontSize:9}}>{FIXED_MM.m3}</td>
                      <td style={{border,textAlign:"center",fontWeight:600}}>{sub.o3}</td>
                      <td style={{border,textAlign:"center",color:"#0070c0",fontWeight:700,fontSize:9}}>200</td>
                      <td style={{border,textAlign:"center",fontWeight:800}}>{tot||""}</td>
                      <td style={{border,textAlign:"center",fontWeight:900,fontSize:10,color:p!==null&&p<33?"#c62828":"#1a237e"}}>{p!==null?grade(p):""}</td>
                    </tr>
                  );
                })}
                <tr style={{background:"#e8eaf6",fontWeight:800,height:24,fontSize:9.5}}>
                  <td style={{border,paddingLeft:4,fontWeight:900}}>TOTAL</td>
                  <td style={{border,textAlign:"center",color:"#0070c0"}}>{gt.m1}</td>
                  <td style={{border,textAlign:"center"}}>{gt.o1||""}</td>
                  <td style={{border,textAlign:"center",color:"#0070c0"}}>{gt.m2}</td>
                  <td style={{border,textAlign:"center"}}>{gt.o2||""}</td>
                  <td style={{border,textAlign:"center",color:"#0070c0"}}>{gt.m3}</td>
                  <td style={{border,textAlign:"center"}}>{gt.o3||""}</td>
                  <td style={{border,textAlign:"center",color:"#0070c0"}}>{gt.mT}</td>
                  <td style={{border,textAlign:"center",fontWeight:900}}>{gt.oT}</td>
                  <td style={{border}}></td>
                </tr>
                <tr style={{background:"#e8eaf6",fontWeight:800,height:24,fontSize:9.5}}>
                  <td style={{border,paddingLeft:4,fontWeight:900}}>PERCENTAGE</td>
                  <td colSpan={2} style={{border,textAlign:"center"}}>{t1p}</td>
                  <td colSpan={2} style={{border,textAlign:"center"}}>{t2p}</td>
                  <td colSpan={2} style={{border,textAlign:"center"}}>{t3p}</td>
                  <td colSpan={2} style={{border,textAlign:"center",fontSize:12,fontWeight:900}}>{op!==null?op+"%":""}</td>
                  <td style={{border,textAlign:"center",fontWeight:900,fontSize:11,color:"#1a237e"}}>{grade(op)}</td>
                </tr>
              </tbody>
            </table>

            {/* CO-SCHOLASTIC */}
            <div style={{marginBottom:5}}>
              <div style={{background:headerBg,fontWeight:700,fontSize:9,padding:"3px 6px",border,
                display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:"none"}}>
                <span>Co-Scholastic Area</span>
                <span style={{fontSize:8}}>A+:Outstanding ¬∑ A:Excellent ¬∑ B+:Very Good ¬∑ B:Good ¬∑ C:Average</span>
              </div>
              <table style={{width:"100%",borderCollapse:"collapse",fontSize:9}}>
                <tbody>
                  <tr style={{height:22}}>
                    {[["Sports & Games","sports"],["Art & Craft","art"],["Music & Dance","music"],["Discipline","disc"],["Cleanliness","clean"]].map(([lbl,k])=>(
                      <React.Fragment key={k}>
                        <td style={{border,padding:"2px 5px",fontWeight:700,background:"#fafafa",fontSize:9}}>{lbl}</td>
                        <td style={{border,textAlign:"center",fontWeight:900,color:"#1a237e",width:"5%",fontSize:10.5}}>{(s.cosco&&s.cosco[k])||""}</td>
                      </React.Fragment>
                    ))}
                  </tr>
                </tbody>
              </table>
            </div>

            {/* GRADE SCALE */}
            <div style={{display:"flex",border,height:24,fontSize:8,marginBottom:6}}>
              <div style={{background:"#4a4a4a",color:"#fff",width:"12%",display:"flex",
                alignItems:"center",justifyContent:"center",textAlign:"center",
                padding:"0 3px",lineHeight:1.3,fontSize:7.5,fontWeight:700}}>GRADE<br/>SCALE</div>
              <div style={{flex:1,display:"flex"}}>
                {GRADE_TABLE.map((r,i)=>{
                  const isActive = op!==null && op>=r.min && op<=r.max;
                  return (
                    <div key={i} style={{
                      flex:1,
                      background:isActive?"#1a237e":"#dbe5f1",
                      color:isActive?"#fff":"#333",
                      borderLeft:"1px solid rgba(255,255,255,0.8)",
                      display:"flex",alignItems:"center",justifyContent:"center",
                      fontWeight:isActive?900:700,fontSize:7.5,textAlign:"center",lineHeight:1.2,
                    }}>
                      {r.min===0?"00":r.min}‚Äì{r.max}<br/>{r.g}
                    </div>
                  );
                })}
              </div>
            </div>

            {/* RANK */}
            <div style={{textAlign:"center",marginBottom:4}}>
              <span style={{fontSize:10,fontWeight:800,color:"#1a237e"}}>Class Rank : </span>
              <span style={{fontSize:11,fontWeight:900,borderBottom:"1.5px solid #333",paddingBottom:1,minWidth:50,display:"inline-block",textAlign:"center"}}>{s.rank||""}</span>
            </div>

            {/* REMARK + ATTENDANCE */}
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",
              background:"#f8f8ff",border:"1px solid #c5cae9",borderRadius:3,
              padding:"6px 12px",marginBottom:6}}>
              <div style={{display:"flex",alignItems:"center",gap:5,flex:1}}>
                <span style={{fontSize:10,fontWeight:800,color:"#1a237e",whiteSpace:"nowrap"}}>Remark :</span>
                <span style={{flex:1,borderBottom:"1.5px solid #333",paddingBottom:1,
                  fontSize:9.5,lineHeight:1.4,wordBreak:"break-word",color:"#111",minWidth:80}}>{s.remark||""}</span>
              </div>
              <div style={{display:"flex",alignItems:"center",gap:5,marginLeft:16,flexShrink:0}}>
                <span style={{fontSize:10,fontWeight:800,color:"#1a237e",whiteSpace:"nowrap"}}>Attendance :</span>
                <span style={{borderBottom:"1.5px solid #333",minWidth:44,textAlign:"center",
                  paddingBottom:1,fontSize:11,fontWeight:900,color:"#2e7d32"}}>{attDisp}</span>
              </div>
            </div>

            <div style={{flex:1}}/>

            {/* SIGNATURES */}
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-end",padding:"0 16px 4px"}}>
              <div style={{textAlign:"center",minWidth:110}}>
                <div style={{fontSize:10,fontWeight:600,marginBottom:3}}>{printDateStr}</div>
                <div style={{borderTop:"2px dotted #555",width:110,marginBottom:3}}></div>
                <div style={{fontSize:10,fontWeight:700}}>Date</div>
              </div>
              <div style={{textAlign:"center",minWidth:120}}>
                <div style={{borderTop:"2px dotted #555",width:130,marginBottom:3}}></div>
                <div style={{fontSize:10,fontWeight:700}}>Class Teacher</div>
              </div>
              <div style={{textAlign:"center",minWidth:120}}>
                <div style={{width:130,height:36,display:"flex",alignItems:"center",justifyContent:"center",marginBottom:0}}>
                  <img src="principal_sign.png" alt="" style={{maxHeight:"100%",maxWidth:"100%",objectFit:"contain"}} onError={e=>e.target.style.display="none"}/>
                </div>
                <div style={{borderTop:"2px dotted #555",width:130,marginBottom:3}}></div>
                <div style={{fontSize:10,fontWeight:700}}>Principal</div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ‚îÄ LIVE PREVIEW ‚îÄ‚îÄ */
function LivePreview({student:s}){
  if(!s) return (
    <div style={{color:"#94a3b8",textAlign:"center",marginTop:80}}>
      <div style={{fontSize:50,marginBottom:12}}>üìÑ</div>
      <div style={{fontSize:13}}>Student select karein preview ke liye</div>
    </div>
  );
  const SCALE="0.5";
  const gt=grandTotals(s.subs);
  const op=gt.mT>0?pct(gt.oT,gt.mT):null;
  const border="1px solid #000";
  const headerBg="#fce4d6";
  const infoTeal="#d1eeee";
  return (
    <div style={{transformOrigin:"top center",transform:`scale(${SCALE})`,
      width:"210mm",marginBottom:`calc((${SCALE} - 1) * 297mm)`,
      background:"white",padding:"2.5mm",boxSizing:"border-box",
      fontFamily:"Arial,sans-serif",height:"297mm",overflow:"hidden",
      boxShadow:"0 20px 60px rgba(26,35,126,0.15)",borderRadius:4,
    }}>
      <div style={{border:"3.5px solid #c62828",height:"100%",display:"flex",flexDirection:"column"}}>
        <div style={{border:"1px solid #000",margin:"2px",flex:1,padding:"5px 7px",display:"flex",flexDirection:"column"}}>
          <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:4}}>
            <div style={{width:80,height:80,overflow:"hidden",flexShrink:0}}>
              <img src={SCHOOL.logo} alt="" style={{width:"100%",height:"100%",objectFit:"contain"}} onError={e=>e.target.style.display="none"}/>
            </div>
            <div style={{flex:1,textAlign:"center"}}>
              <div style={{fontSize:22,fontWeight:900,color:"#c62828",fontFamily:'"Times New Roman",serif',textTransform:"uppercase"}}>{SCHOOL.name}</div>
              <div style={{fontSize:9,color:"#333",marginTop:2}}>{SCHOOL.addr}</div>
              <div style={{display:"inline-block",background:"#ffff00",color:"#c62828",padding:"2px 14px",fontWeight:900,fontSize:10,marginTop:4,marginBottom:3}}>PROGRESS EVALUATION REPORT</div>
              <div style={{fontSize:10,fontWeight:700,color:"#000"}}>CLASS : {s.cls}{s.sec?"-"+s.sec:""} &nbsp;|&nbsp; {s.session}</div>
            </div>
            <div style={{width:66,height:80,border:"1px solid #555",overflow:"hidden",flexShrink:0,display:"flex",alignItems:"center",justifyContent:"center",marginTop:14}}>
              {s.photo?<img src={s.photo} style={{width:"100%",height:"100%",objectFit:"cover"}} alt=""/>:<span style={{fontSize:7,color:"#bbb",textAlign:"center"}}>Photo</span>}
            </div>
          </div>
          <div style={{background:infoTeal,borderTop:"1.5px solid #000",borderBottom:"1.5px solid #000",padding:"4px 7px",fontSize:9,marginBottom:4}}>
            {[["STUDENT'S NAME",(s.name||"").toUpperCase()],["GENDER",(s.gender||"").toUpperCase()],["FATHER'S NAME",(s.father||"").toUpperCase()]].map(([l,v])=>(
              <div key={l} style={{display:"flex",minHeight:14}}><span style={{width:100,fontWeight:700}}>{l}</span><span style={{marginRight:3}}>:</span><span>{v}</span></div>
            ))}
          </div>
          <table style={{width:"100%",borderCollapse:"collapse",fontSize:8,tableLayout:"fixed",marginBottom:4}}>
            <thead>
              <tr style={{background:headerBg}}>
                <th style={{border,padding:"2px 3px",textAlign:"left"}}>SUBJECT</th>
                <th style={{border,padding:"2px",textAlign:"center",color:"#1a237e"}}>T1/40</th>
                <th style={{border,padding:"2px",textAlign:"center",color:"#1a237e"}}>T2/60</th>
                <th style={{border,padding:"2px",textAlign:"center",color:"#1a237e"}}>T3/100</th>
                <th style={{border,padding:"2px",textAlign:"center",color:"#c62828"}}>TOTAL</th>
                <th style={{border,padding:"2px",textAlign:"center"}}>GRADE</th>
              </tr>
            </thead>
            <tbody>
              {s.subs.map((sub,i)=>{
                const tot=subObt(sub);
                const p=pct(tot,200);
                return (
                  <tr key={i} style={{height:18,background:i%2===0?"#fff":"#f9f9f9"}}>
                    <td style={{border,paddingLeft:3,fontSize:8,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",fontWeight:600}}>{sub.n}</td>
                    <td style={{border,textAlign:"center"}}>{sub.o1}</td>
                    <td style={{border,textAlign:"center"}}>{sub.o2}</td>
                    <td style={{border,textAlign:"center"}}>{sub.o3}</td>
                    <td style={{border,textAlign:"center",fontWeight:700}}>{tot||""}</td>
                    <td style={{border,textAlign:"center",fontWeight:700,color:p!==null&&p<33?"#c62828":"#1a237e"}}>{p!==null?grade(p):""}</td>
                  </tr>
                );
              })}
            </tbody>
          </table>
          {op!==null&&<div style={{textAlign:"center",fontSize:14,fontWeight:900,color:op>=33?"#1b5e20":"#c62828",padding:"4px 0"}}>{op}% ‚Äî {grade(op)} ‚Äî {gradeLabel(op)}</div>}
        </div>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ‚îÄ APP ‚îÄ‚îÄ */
function App(){
  const [screen,setScreen]         = useState("dash");
  const [students,setStudents]     = useState([]);
  const [activeId,setActiveId]     = useState(null);
  const [printSt,setPrintSt]       = useState(null);
  const [prevSt,setPrevSt]         = useState(null);
  const [toastMsg,setToastMsg]     = useState("");
  const [syncStatus,setSyncStatus] = useState("idle");
  const [syncTs,setSyncTs]         = useState("");
  const [loaded,setLoaded]         = useState(false);
  const [isDesktop,setIsDesktop]   = useState(window.innerWidth>=900);
  const [loggedIn,setLoggedIn]     = useState(()=>isSessionValid());
  const [authError,setAuthError]   = useState("");
  const [showClassSelector,setShowClassSelector] = useState(false);

  // Stable ref for students to avoid stale closures
  const studentsRef = useRef(students);
  studentsRef.current = students;

  useEffect(()=>{
    const h=()=>setIsDesktop(window.innerWidth>=900);
    window.addEventListener("resize",h);
    return()=>window.removeEventListener("resize",h);
  },[]);

  const handleLogin=pw=>{
    if(pw===APP_PASSWORD){saveSession();setLoggedIn(true);setAuthError("");return true;}
    setAuthError("Galat password!"); return false;
  };
  const handleLogout=()=>{
    if(window.confirm("Logout karna chahte hain?")){
      clearSession();setLoggedIn(false);setStudents([]);setLoaded(false);setScreen("dash");
    }
  };
  const showToast=useCallback(msg=>{setToastMsg(msg);setTimeout(()=>setToastMsg(""),2800);},[]);

  useEffect(()=>{
    if(!loggedIn) return;
    setSyncStatus("syncing");
    fbAll().then(data=>{
      const d=Array.isArray(data)?data:[];
      setStudents(d.length>0?d:lsLoad());
      setSyncStatus("synced");setSyncTs(new Date().toLocaleTimeString("en-IN"));setLoaded(true);
    }).catch(()=>{setStudents(lsLoad());setSyncStatus("offline");setLoaded(true);showToast("üì¥ Offline mode");});
  },[loggedIn]);

  useEffect(()=>{if(loaded) lsSave(students);},[students,loaded]);

  // BUG FIXED: handleSave now uses functional update + ref to avoid stale closure
  const handleSave=useCallback(async updated=>{
    if(!updated||!updated.id) return;
    setStudents(prev=>{
      const next=prev.map(s=>s.id===updated.id?updated:s);
      lsSave(next);
      return next;
    });
    setPrevSt(updated);setSyncStatus("syncing");
    try{await fbSave(updated);setSyncStatus("synced");setSyncTs(new Date().toLocaleTimeString("en-IN"));}
    catch{setSyncStatus("error");showToast("‚ö†Ô∏è Offline save");}
  },[showToast]);

  const handleNew=()=>setShowClassSelector(true);

  const handleClassSelected=(cls,gender)=>{
    setShowClassSelector(false);
    const st=newStudent(cls,gender);
    setStudents(p=>[...p,st]);
    setActiveId(st.id);setPrevSt(st);setScreen("editor");
    fbSave(st).catch(()=>{});
  };

  const handleSelect=id=>{
    setActiveId(id);
    const st=studentsRef.current.find(s=>s.id===id);
    if(st){setPrevSt(st);setScreen("editor");}
  };

  const handleDelete=async()=>{
    if(!activeId) return;
    if(!window.confirm("Delete karein?")) return;
    const next=studentsRef.current.filter(s=>s.id!==activeId);
    setStudents(next);lsSave(next);setPrevSt(null);
    try{await fbDel(activeId);}catch{}
    setScreen("dash");showToast("üóëÔ∏è Deleted");
  };

  if(!loggedIn) return <LoginScreen onLogin={handleLogin} error={authError}/>;
  if(showClassSelector) return <ClassGenderSelector onSelect={handleClassSelected}/>;
  if(!loaded) return (
    <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",
      flexDirection:"column",gap:16,background:"linear-gradient(145deg,#e8edf8,#f0f4ff)"}}>
      <div style={{fontSize:52}}>üè´</div>
      <div style={{fontWeight:900,color:"#1a237e",fontSize:18,fontFamily:"'Playfair Display',serif"}}>{SCHOOL.name}</div>
      <div style={{color:"#64748b",fontSize:13,display:"flex",alignItems:"center",gap:9}}>
        <span style={{width:8,height:8,borderRadius:"50%",background:"#f59e0b",display:"inline-block",animation:"pulse 1.1s infinite"}}/>
        Loading‚Ä¶
      </div>
    </div>
  );

  const activeStudent=students.find(s=>s.id===activeId);

  return (
    <div className={isDesktop?"shell":""}>
      <div className={isDesktop?"left-pane":""}>
        {screen==="dash"&&(
          <Dashboard students={students} onNew={handleNew} onSelect={handleSelect}
            syncStatus={syncStatus} syncTs={syncTs} onLogout={handleLogout}
            onViewResults={()=>setScreen("results")}/>
        )}
        {screen==="results"&&(
          <ResultsViewer students={students} onClose={()=>setScreen("dash")} onSelect={id=>{handleSelect(id);}}/>
        )}
        {screen==="editor"&&activeStudent&&(
          <Editor student={activeStudent} onSave={handleSave}
            onBack={()=>{setScreen("dash");setPrevSt(null);}}
            onPrint={st=>{setPrintSt(st);setScreen("print");}}
            onDelete={handleDelete} showToast={showToast}/>
        )}
        {screen==="print"&&printSt&&(
          <PrintView student={printSt} onClose={()=>setScreen("editor")}/>
        )}
      </div>
      {isDesktop&&screen!=="print"&&(
        <div className="right-pane">
          <div style={{color:"#94a3b8",fontSize:10,letterSpacing:2,marginBottom:14,fontWeight:700}}>‚óÄ LIVE PREVIEW ‚ñ∂</div>
          <LivePreview student={prevSt||activeStudent}/>
        </div>
      )}
      <Toast msg={toastMsg}/>
    </div>
  );
}

// ‚îÄ‚îÄ ERROR BOUNDARY (stability) ‚îÄ‚îÄ
class ErrorBoundary extends React.Component{
  constructor(props){super(props);this.state={hasError:false,error:null};}
  static getDerivedStateFromError(error){return{hasError:true,error};}
  componentDidCatch(error,info){console.error("App error:",error,info);}
  render(){
    if(this.state.hasError){
      return (
        <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",
          background:"#f0f4f8",padding:20,flexDirection:"column",gap:16,textAlign:"center"}}>
          <div style={{fontSize:48}}>‚ö†Ô∏è</div>
          <div style={{fontWeight:700,fontSize:18,color:"#1e293b"}}>Kuch galat ho gaya</div>
          <div style={{fontSize:13,color:"#64748b",maxWidth:320}}>{String(this.state.error?.message||"Unknown error")}</div>
          <button onClick={()=>window.location.reload()} className="btn btn-primary" style={{marginTop:8}}>
            üîÑ Reload Karein
          </button>
        </div>
      );
    }
    return this.props.children;
  }
}

ReactDOM.createRoot(document.getElementById("root")).render(
  <ErrorBoundary><App/></ErrorBoundary>
);
</script>

<script>
// Service worker ‚Äî only register on HTTPS/localhost to avoid errors
if('serviceWorker' in navigator && (location.protocol==='https:'||location.hostname==='localhost')){
  window.addEventListener('load',function(){
    navigator.serviceWorker.register('sw.js').catch(function(){});
  });
}
</script>
</body>
</html>
